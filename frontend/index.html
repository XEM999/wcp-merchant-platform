<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NearBite â€” å‘ç°ç¾é£Ÿ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸœ</text></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ============================================================
   NearBite Consumer UI â€” Design System
   Based on: Edward_NearBite_UIè®¾è®¡æ–¹æ¡ˆ.html
   Colors: Orange(#ff6b35) + White + Light Gray BG
   AI Accent: Purple(#8b5cf6)
   Style: Rounded cards, minimalist, mobile-first
   ============================================================ */

:root {
    --pri: #ff6b35;
    --pri-l: #ff8f66;
    --pri-d: #e55a2b;
    --pri-bg: #fff7ed;
    --ai: #8b5cf6;
    --ai-l: #a78bfa;
    --ai-bg: #f5f3ff;
    --bg: #f7f7f8;
    --card: #ffffff;
    --g1: #f3f4f6;
    --g2: #e5e7eb;
    --g3: #d1d5db;
    --g4: #9ca3af;
    --g5: #6b7280;
    --g6: #4b5563;
    --g7: #374151;
    --g8: #1f2937;
    --green: #10b981;
    --red: #ef4444;
    --border: #e5e7eb;
    --sh: 0 2px 12px rgba(0,0,0,.06);
    --sh-lg: 0 4px 20px rgba(0,0,0,.12);
    --r: 12px;
    --r2: 16px;
    --r3: 24px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', sans-serif;
    background: var(--bg);
    color: var(--g8);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
}

/* ========== LOGIN PAGE ========== */
.login-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, #fff 0%, #fff7f4 100%);
    padding: 20px;
}
.login-overlay.show { display: flex; }

.login-page {
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.login-icon {
    width: 80px;
    height: 80px;
    background: var(--pri);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.4rem;
    margin: 0 auto 16px;
    box-shadow: 0 8px 24px rgba(255,107,53,.3);
}

.login-title {
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--g8);
    margin-bottom: 4px;
}

.login-subtitle {
    font-size: .9rem;
    color: var(--g4);
    margin-bottom: 32px;
}

.login-card {
    background: var(--card);
    border-radius: var(--r2);
    padding: 24px;
    box-shadow: var(--sh-lg);
    text-align: left;
}

.f-group { margin-bottom: 14px; }

.f-label {
    display: block;
    font-size: .8rem;
    font-weight: 600;
    color: var(--g6);
    margin-bottom: 6px;
}

.f-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.f-prefix {
    width: 72px;
    height: 48px;
    border: 2px solid var(--g2);
    border-radius: var(--r);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: .85rem;
    font-weight: 600;
    color: var(--g6);
    background: #fafafa;
    flex-shrink: 0;
}

.f-input {
    width: 100%;
    height: 48px;
    border: 2px solid var(--g2);
    border-radius: var(--r);
    padding: 0 14px;
    font-size: .95rem;
    background: #fff;
    color: var(--g8);
    outline: none;
    transition: border .2s;
    font-family: inherit;
}
.f-input:focus { border-color: var(--pri); }
.f-input.flex { flex: 1; }

.btn {
    width: 100%;
    height: 50px;
    border: none;
    border-radius: var(--r);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
    font-family: inherit;
}

.btn-pri {
    background: var(--pri);
    color: #fff;
    box-shadow: 0 4px 16px rgba(255,107,53,.3);
}
.btn-pri:hover { background: var(--pri-d); transform: translateY(-1px); }
.btn-pri:active { transform: scale(.98); }

.login-or {
    display: flex;
    align-items: center;
    margin: 18px 0;
    color: var(--g4);
    font-size: .8rem;
}
.login-or::before, .login-or::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--g2);
}
.login-or span { padding: 0 12px; }

.social-row {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 16px;
}

.social-btn {
    width: 52px;
    height: 52px;
    border: 2px solid var(--g2);
    border-radius: var(--r);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    background: #fff;
    cursor: pointer;
    transition: all .2s;
}
.social-btn:hover { border-color: var(--pri); background: #fff8f5; }

.login-link {
    text-align: center;
    font-size: .85rem;
    color: var(--g5);
}
.login-link a {
    color: var(--pri);
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
}

.login-err {
    color: var(--red);
    font-size: .8rem;
    margin-bottom: 10px;
    min-height: 1.2em;
}

/* ========== APP CONTAINER ========== */
.app {
    display: none;
    flex-direction: column;
    min-height: 100vh;
    padding-bottom: 70px;
}
.app.show { display: flex; }

/* ========== HEADER ========== */
.app-hd {
    position: sticky;
    top: 0;
    z-index: 500;
    background: rgba(255,255,255,.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
}

.hd-left { display: flex; align-items: center; gap: 8px; }
.hd-logo { font-size: 28px; }
.hd-brand { font-size: 20px; font-weight: 800; color: var(--pri); letter-spacing: -.5px; }

.hd-right { display: flex; align-items: center; gap: 8px; }

.lang-sel {
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 20px;
    background: var(--card);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    color: var(--g5);
    outline: none;
    appearance: none;
    -webkit-appearance: none;
    padding-right: 24px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 10px;
}
.lang-sel:hover { border-color: var(--pri); color: var(--pri-d); }
.lang-sel:focus { border-color: var(--pri); }

/* ========== HOME PAGE ========== */
.pg-home {
    flex: 1;
    display: none;
    flex-direction: column;
    background: var(--bg);
}
.pg-home.show { display: flex; }

.home-hd {
    background: #fff;
    padding: 14px 16px 10px;
    flex-shrink: 0;
}

.loc-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
    font-size: .85rem;
    font-weight: 600;
    color: var(--g8);
    cursor: pointer;
}
.loc-row .arr { color: var(--g4); font-size: .7rem; }

/* Search Bar */
.search-bar { position: relative; }
.search-bar input {
    width: 100%;
    height: 42px;
    background: var(--g1);
    border: none;
    border-radius: var(--r);
    padding: 0 70px 0 38px;
    font-size: .85rem;
    color: var(--g8);
    outline: none;
    font-family: inherit;
    transition: all .2s;
}
.search-bar input:focus {
    background: #fff;
    box-shadow: 0 0 0 2px var(--pri);
}
.search-bar .ico {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
    color: var(--g4);
}
.search-ai-badge {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, var(--ai), var(--ai-l));
    color: #fff;
    font-size: .55rem;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: 600;
}

/* Tabs Row */
.tabs-row {
    display: flex;
    background: #fff;
    border-bottom: 1px solid var(--g1);
    flex-shrink: 0;
}
.tab {
    flex: 1;
    text-align: center;
    padding: 10px 0;
    font-size: .85rem;
    font-weight: 500;
    color: var(--g4);
    cursor: pointer;
    position: relative;
    transition: color .15s;
}
.tab.on { color: var(--pri); font-weight: 600; }
.tab.on::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 24px;
    height: 3px;
    background: var(--pri);
    border-radius: 2px;
}

/* Category Nav */
.home-cats {
    background: #fff;
    padding: 12px 0;
    border-bottom: 1px solid var(--g1);
    flex-shrink: 0;
}
.cats-scroll {
    display: flex;
    gap: 6px;
    padding: 0 14px;
    overflow-x: auto;
}
.cats-scroll::-webkit-scrollbar { display: none; }
.cat {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    padding: 6px 10px;
    cursor: pointer;
}
.cat-ico {
    width: 46px;
    height: 46px;
    background: var(--g1);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    transition: all .2s;
}
.cat.on .cat-ico { background: var(--pri); color: #fff; }
.cat span { font-size: .7rem; color: var(--g5); white-space: nowrap; }
.cat.on span { color: var(--pri); font-weight: 600; }

/* Filter Chips */
.filter-row {
    display: flex;
    gap: 8px;
    padding: 10px 16px;
    background: #fff;
    flex-shrink: 0;
    overflow-x: auto;
}
.filter-row::-webkit-scrollbar { display: none; }
.chip {
    flex-shrink: 0;
    height: 32px;
    padding: 0 14px;
    border-radius: 16px;
    border: 1px solid var(--g2);
    background: #fff;
    font-size: .8rem;
    color: var(--g6);
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    transition: all .15s;
    font-family: inherit;
    white-space: nowrap;
}
.chip.on { background: var(--pri); color: #fff; border-color: var(--pri); }
.chip:hover { border-color: var(--pri); }

/* Home Body (scrollable) */
.home-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px 80px;
}

/* AI Recommend Section */
.ai-recommend { padding: 12px 0; margin-bottom: 8px; }
.ai-recommend-hd {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding: 0 2px;
}
.ai-recommend-hd .icon {
    background: linear-gradient(135deg, var(--ai), var(--ai-l));
    color: #fff;
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: .9rem;
}
.ai-recommend-hd .title { font-size: .95rem; font-weight: 600; color: var(--g8); }
.ai-recommend-hd .subtitle { font-size: .7rem; color: var(--g4); margin-left: auto; }
.ai-cards { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 4px; }
.ai-cards::-webkit-scrollbar { display: none; }
.ai-card {
    flex-shrink: 0;
    width: 150px;
    background: #fff;
    border-radius: var(--r);
    padding: 10px;
    box-shadow: 0 1px 6px rgba(0,0,0,.04);
    cursor: pointer;
    transition: transform .15s;
}
.ai-card:hover { transform: translateY(-2px); }
.ai-card-img {
    width: 100%;
    height: 72px;
    background: linear-gradient(135deg, #ffe4d6, #fff0e8);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin-bottom: 8px;
}
.ai-card-name {
    font-size: .8rem;
    font-weight: 600;
    color: var(--g8);
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.ai-card-desc { font-size: .65rem; color: var(--g4); margin-bottom: 6px; }
.ai-card-tag {
    font-size: .55rem;
    padding: 2px 5px;
    background: linear-gradient(135deg, var(--ai), var(--ai-l));
    color: #fff;
    border-radius: 4px;
    display: inline-block;
}

/* Mini Map & Full Map */
.map-preview {
    height: 140px;
    border-radius: var(--r2);
    margin-bottom: 12px;
    position: relative;
    overflow: hidden;
}
#mini-map { height: 100%; width: 100%; border-radius: var(--r2); }
.full-map-wrap {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 70px;
    z-index: 400;
}
.full-map-wrap.show { display: block; }
#full-map { width: 100%; height: 100%; }

/* Promo Banner */
.promo {
    height: 110px;
    background: linear-gradient(135deg, var(--pri), var(--pri-l));
    border-radius: var(--r2);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    padding: 0 20px;
    color: #fff;
    position: relative;
    overflow: hidden;
}
.promo h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; }
.promo p { font-size: .8rem; opacity: .85; }
.promo .deco {
    position: absolute;
    right: -10px;
    top: -10px;
    width: 100px;
    height: 100px;
    background: rgba(255,255,255,.1);
    border-radius: 50%;
}
.promo .deco2 {
    position: absolute;
    right: 30px;
    bottom: -20px;
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,.08);
    border-radius: 50%;
}

/* ========== VENDOR CARD ========== */
.v-card {
    background: #fff;
    border-radius: var(--r2);
    margin-bottom: 12px;
    overflow: hidden;
    box-shadow: 0 1px 6px rgba(0,0,0,.04);
    display: flex;
    gap: 12px;
    padding: 12px;
    cursor: pointer;
    transition: transform .15s;
}
.v-card:active { transform: scale(.99); }
.v-img {
    width: 88px;
    height: 88px;
    border-radius: var(--r);
    background: linear-gradient(135deg, #ffe4d6, #fff0e8);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
}
.v-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.v-name {
    font-size: .95rem;
    font-weight: 600;
    color: var(--g8);
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.v-rate {
    font-size: .78rem;
    color: var(--g5);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.v-rate .star { color: #ffb800; }
.v-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
.v-tag {
    font-size: .65rem;
    padding: 2px 7px;
    background: #fff5f2;
    color: var(--pri);
    border-radius: 4px;
}
.v-tag-ai {
    font-size: .65rem;
    padding: 2px 7px;
    background: linear-gradient(135deg, var(--ai), var(--ai-l));
    color: #fff;
    border-radius: 4px;
}
.v-meta {
    display: flex;
    justify-content: space-between;
    font-size: .72rem;
    color: var(--g4);
}
.v-meta .open { color: var(--green); }

/* Menu Expand inside card */
.menu-expand {
    display: none;
    width: 100%;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
}
.menu-expand.show { display: block; animation: slideDown .25s ease; }
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: none; }
}
.menu-category {
    font-size: 12px;
    font-weight: 600;
    color: var(--g5);
    margin: 12px 0 8px;
    text-transform: uppercase;
    letter-spacing: .5px;
}
.menu-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f3f4f6;
}
.menu-item:last-child { border-bottom: none; }
.menu-item-info { flex: 1; }
.menu-item-name { font-size: 14px; font-weight: 500; }
.menu-item-price { color: var(--pri-d); font-size: 14px; font-weight: 700; margin-top: 2px; }
.menu-item-add {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--pri);
    color: #fff;
    border: none;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform .15s;
}
.menu-item-add:active { transform: scale(.9); }

/* Empty State */
.empty-state { text-align: center; padding: 40px 20px; color: var(--g4); }
.empty-state .em-icon { font-size: 48px; margin-bottom: 12px; }

/* ========== BOTTOM NAV ========== */
.bnav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    display: flex;
    border-top: 1px solid var(--g1);
    padding: 8px 0 28px;
    z-index: 500;
}
.bnav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    font-size: .62rem;
    color: var(--g4);
    cursor: pointer;
    padding: 4px 0;
    transition: color .15s;
}
.bnav-item.on { color: var(--pri); }
.bnav-item.ai-on { color: var(--ai); }
.bnav-item .ico { font-size: 1.3rem; }

/* ========== PLACEHOLDER PAGES ========== */
.pg-placeholder {
    display: none;
    flex: 1;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
}
.pg-placeholder.show { display: flex; }
.pg-placeholder .ph-ico { font-size: 3.5rem; margin-bottom: 16px; }
.pg-placeholder h3 { font-size: 1.1rem; color: var(--g8); margin-bottom: 8px; }
.pg-placeholder p { font-size: .85rem; color: var(--g4); line-height: 1.6; }

/* ========== CART FLOAT ========== */
.cart-float {
    position: fixed;
    bottom: 90px;
    right: 16px;
    z-index: 450;
    background: var(--pri);
    color: #fff;
    border: none;
    border-radius: 28px;
    padding: 12px 20px;
    font-size: .9rem;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(255,107,53,.4);
    display: none;
    align-items: center;
    gap: 8px;
    font-family: inherit;
    transition: transform .2s;
}
.cart-float.show { display: flex; }
.cart-float:active { transform: scale(.95); }
.cart-badge {
    background: var(--red);
    color: #fff;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: .7rem;
    font-weight: 700;
}

/* ========== CART PANEL ========== */
.cart-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.4);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all .3s;
}
.cart-overlay.show { opacity: 1; visibility: visible; }
.cart-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--card);
    border-radius: var(--r3) var(--r3) 0 0;
    max-height: 80vh;
    transform: translateY(100%);
    transition: transform .3s ease;
    z-index: 1001;
    display: flex;
    flex-direction: column;
}
.cart-overlay.show .cart-panel { transform: translateY(0); }
.cart-handle {
    width: 40px;
    height: 4px;
    background: var(--g2);
    border-radius: 2px;
    margin: 12px auto;
}
.cart-header {
    padding: 0 20px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
}
.cart-title { font-size: 18px; font-weight: 700; }
.cart-close {
    background: var(--g1);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.cart-items { flex: 1; overflow-y: auto; padding: 12px 20px; }
.cart-empty { text-align: center; padding: 40px; color: var(--g4); }
.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}
.cart-item-info { flex: 1; }
.cart-item-name { font-size: 14px; font-weight: 500; }
.cart-item-price { color: var(--pri-d); font-size: 13px; }
.cart-item-qty { display: flex; align-items: center; gap: 12px; }
.qty-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--g1);
    border: none;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.cart-item-total { font-weight: 700; min-width: 60px; text-align: right; }
.cart-footer {
    padding: 16px 20px 24px;
    border-top: 1px solid var(--border);
    background: var(--card);
}
.cart-total {
    display: flex;
    justify-content: space-between;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 12px;
}
.cart-total-amount { color: var(--pri-d); }
.cart-note {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    margin-bottom: 12px;
    resize: none;
}
.cart-note:focus { border-color: var(--pri); outline: none; }
.checkout-btn {
    width: 100%;
    padding: 16px;
    background: var(--pri);
    color: #fff;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    font-family: inherit;
    box-shadow: 0 4px 16px rgba(255,107,53,.3);
    transition: all .2s;
}
.checkout-btn:active { transform: scale(.98); }

/* ========== ORDER PANEL ========== */
.order-panel {
    position: fixed;
    top: 60px;
    left: 16px;
    right: 16px;
    background: var(--card);
    border-radius: var(--r2);
    box-shadow: var(--sh-lg);
    padding: 20px;
    z-index: 800;
    display: none;
}
.order-panel.show { display: block; animation: slideDown .3s ease; }
.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}
.order-id { font-size: 12px; color: var(--g5); }
.order-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--g5);
}
.order-status-title {
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 20px;
}
.status-progress {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-bottom: 20px;
}
.status-progress::before {
    content: '';
    position: absolute;
    top: 14px;
    left: 20px;
    right: 20px;
    height: 4px;
    background: var(--g2);
    border-radius: 2px;
}
.status-progress-fill {
    position: absolute;
    top: 14px;
    left: 20px;
    height: 4px;
    background: var(--green);
    border-radius: 2px;
    transition: width .5s ease;
}
.status-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 1;
}
.status-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--g1);
    border: 3px solid var(--g2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    margin-bottom: 6px;
    transition: all .3s;
}
.status-step.done .status-icon {
    background: var(--green);
    border-color: var(--green);
    color: #fff;
}
.status-step.active .status-icon {
    background: var(--pri);
    border-color: var(--pri);
    color: #fff;
    animation: pulse 1s infinite;
}
.status-label { font-size: 10px; color: var(--g4); text-align: center; }
.status-step.done .status-label,
.status-step.active .status-label { color: var(--g8); font-weight: 600; }
@keyframes pulse { 50% { opacity: .4; } }
.order-action { text-align: center; margin-top: 16px; }
.order-action button {
    padding: 10px 20px;
    background: var(--g1);
    border: none;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    font-family: inherit;
}

/* ========== TOAST ========== */
.toast-container {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: none;
}
.toast {
    background: var(--card);
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
    box-shadow: var(--sh-lg);
    animation: toastIn .3s ease;
}
.toast.success { border-left: 4px solid var(--green); }
.toast.error { border-left: 4px solid var(--red); }
.toast.info { border-left: 4px solid #3b82f6; }
@keyframes toastIn {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: none; }
}

/* ========== LOADING ========== */
.loading-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}
.loading-overlay.active { display: flex; }
.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--g2);
    border-top-color: var(--pri);
    border-radius: 50%;
    animation: spin .6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-msg { margin-top: 12px; font-size: 13px; color: var(--g5); }

/* ========== LEAFLET OVERRIDES ========== */
.leaflet-popup-content-wrapper { border-radius: 12px !important; }
.leaflet-popup-content { margin: 12px 16px !important; font-family: inherit !important; }
.popup-rich .pr-name { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
.popup-rich .pr-type { font-size: 12px; color: var(--g5); margin-bottom: 4px; }
.popup-rich .pr-stars { color: #f59e0b; font-size: 12px; }
.popup-rich .pr-dist { font-size: 12px; color: var(--pri); font-weight: 600; }
.popup-rich .pr-action {
    margin-top: 8px;
    padding: 6px 12px;
    background: var(--pri);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    width: 100%;
}
/* ========== PHASE 2C: FOLLOW + SCHEDULE + PROFILE ========== */
.follow-row { display:flex; align-items:center; justify-content:space-between; padding:8px 0 6px; border-bottom:1px solid var(--g2); margin-bottom:8px; }
.follow-info { font-size:12px; color:var(--g5); }
.follow-info span { font-weight:600; color:var(--g7); }
.btn-follow { padding:5px 14px; border-radius:20px; border:1.5px solid var(--pri); background:#fff; color:var(--pri); font-size:12px; font-weight:600; cursor:pointer; transition:.2s; }
.btn-follow.followed { background:var(--g2); border-color:var(--g2); color:var(--g5); }
.expand-tabs { display:flex; gap:6px; margin-bottom:8px; }
.expand-tab { padding:4px 12px; border-radius:8px; border:1px solid var(--g2); background:#fff; font-size:12px; font-weight:500; cursor:pointer; color:var(--g6); }
.expand-tab.on { background:var(--pri-bg); border-color:var(--pri); color:var(--pri); font-weight:600; }
.schedule-card { background:var(--g1); border-radius:10px; padding:10px 12px; margin-bottom:8px; }
.schedule-date { font-size:13px; font-weight:600; color:var(--g7); }
.schedule-time { font-size:12px; color:var(--g5); margin-top:2px; }
.schedule-addr { font-size:12px; color:var(--pri); margin-top:3px; }
.schedule-note { font-size:11px; color:var(--g4); margin-top:2px; font-style:italic; }
.schedule-empty { text-align:center; padding:20px; color:var(--g4); font-size:13px; }
/* ========== PROFILE PAGE ========== */
#pgProfile { display:none; padding:0 16px 80px; text-align:left; }
#pgProfile.show { display:block; }
.profile-hero { text-align:center; padding:28px 0 16px; }
.profile-hero .ph-ico { font-size:3rem; margin-bottom:8px; }
.profile-hero h3 { font-size:1.1rem; font-weight:600; color:var(--g8); }
.profile-section-title { font-size:14px; font-weight:700; color:var(--g7); margin:16px 0 8px; padding-left:4px; }
.followed-card { display:flex; align-items:center; gap:12px; background:var(--card); border-radius:12px; padding:12px; margin-bottom:8px; box-shadow:var(--sh); cursor:pointer; active:opacity:.7; }
.followed-emoji { font-size:1.8rem; width:44px; height:44px; display:flex; align-items:center; justify-content:center; background:var(--g1); border-radius:10px; flex-shrink:0; }
.followed-info { flex:1; min-width:0; }
.followed-name { font-size:14px; font-weight:600; color:var(--g8); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.followed-meta { font-size:12px; color:var(--g5); margin-top:2px; }
.followed-status.open { color:var(--green); font-weight:500; }
.followed-status.closed { color:var(--g4); }
.followed-empty { text-align:center; padding:40px 20px; color:var(--g4); font-size:14px; }
.profile-logout-btn { width:100%; padding:12px; margin-top:8px; background:none; border:1.5px solid var(--g2); color:var(--g5); border-radius:10px; font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; }
</style>
</head>
<body>

<!-- ==================== LOGIN OVERLAY ==================== -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-page">
    <div class="login-icon">ğŸ”</div>
    <h1 class="login-title">NearBite</h1>
    <p class="login-subtitle" data-i18n="loginSlogan">å‘ç°èº«è¾¹çš„ç¾å‘³é¤è½¦</p>
    <div class="login-card">
      <!-- Login Form (default) -->
      <div id="loginForm">
        <div class="f-group">
          <label class="f-label" data-i18n="phone">æ‰‹æœºå·</label>
          <div class="f-row">
            <div class="f-prefix">+64</div>
            <input class="f-input flex" id="loginPhone" type="tel" data-i18n-placeholder="phonePh" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
          </div>
        </div>
        <div class="f-group">
          <label class="f-label" data-i18n="password">å¯†ç </label>
          <input class="f-input" id="loginPass" type="password" data-i18n-placeholder="passwordPh" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>
        <div class="login-err" id="loginErr"></div>
        <button class="btn btn-pri" onclick="doFullLogin()" data-i18n="loginBtn">ç™» å½•</button>
        <div class="login-or"><span data-i18n="or">æˆ–</span></div>
        <div class="social-row">
          <div class="social-btn" title="Apple">ğŸ</div>
          <div class="social-btn" title="Google">G</div>
          <div class="social-btn" title="WeChat">ğŸ’¬</div>
        </div>
        <div class="login-link"><span data-i18n="noAccount">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span> <a onclick="toggleLoginRegister(true)" data-i18n="registerNow">ç«‹å³æ³¨å†Œ</a></div>
      </div>
      <!-- Register Form (hidden by default) -->
      <div id="registerForm" style="display:none">
        <div class="f-group">
          <label class="f-label" data-i18n="username">ç”¨æˆ·å</label>
          <input class="f-input" id="regName" data-i18n-placeholder="usernamePh" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        </div>
        <div class="f-group">
          <label class="f-label" data-i18n="phone">æ‰‹æœºå·</label>
          <div class="f-row">
            <div class="f-prefix">+64</div>
            <input class="f-input flex" id="regPhone" type="tel" data-i18n-placeholder="phonePh" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
          </div>
        </div>
        <div class="f-group">
          <label class="f-label" data-i18n="password">å¯†ç </label>
          <input class="f-input" id="regPass" type="password" data-i18n-placeholder="passwordPh" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>
        <div class="login-err" id="regErr"></div>
        <button class="btn btn-pri" onclick="doFullRegister()" data-i18n="registerBtn">æ³¨ å†Œ</button>
        <div style="height:16px"></div>
        <div class="login-link"><span data-i18n="hasAccount">å·²æœ‰è´¦å·ï¼Ÿ</span> <a onclick="toggleLoginRegister(false)" data-i18n="loginNow">ç«‹å³ç™»å½•</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MAIN APP ==================== -->
<div class="app" id="appContainer">
  <!-- Header -->
  <header class="app-hd">
    <div class="hd-left">
      <span class="hd-logo">ğŸ”</span>
      <span class="hd-brand">NearBite</span>
    </div>
    <div class="hd-right">
      <select class="lang-sel" id="langSelect" onchange="switchLang(this.value)">
        <option value="zh">ä¸­æ–‡</option>
        <option value="en">English</option>
      </select>
    </div>
  </header>

  <!-- ===== HOME PAGE ===== -->
  <div class="pg-home show" id="pgHome">
    <div class="home-hd">
      <div class="loc-row" id="locRow">ğŸ“ <span id="locText">Christchurch CBD</span> <span class="arr">â–¼</span></div>
      <div class="search-bar">
        <span class="ico">ğŸ”</span>
        <input id="searchInput" data-i18n-placeholder="searchPh" placeholder="æˆ‘æƒ³åƒè¾£çš„ã€$15ä»¥å†…..." oninput="onSearchInput(this.value)">
        <span class="search-ai-badge">âœ¨ AI</span>
      </div>
    </div>
    <div class="tabs-row" id="contentTabs">
      <div class="tab on" data-tab="recommend" onclick="switchContentTab('recommend')" data-i18n="tabRecommend">æ¨è</div>
      <div class="tab" data-tab="nearby" onclick="switchContentTab('nearby')" data-i18n="tabNearby">é™„è¿‘</div>
      <div class="tab" data-tab="map" onclick="switchContentTab('map')" data-i18n="tabMap">åœ°å›¾</div>
      <div class="tab" data-tab="rating" onclick="switchContentTab('rating')" data-i18n="tabRating">è¯„åˆ†</div>
    </div>
    <div class="home-cats" id="homeCats">
      <div class="cats-scroll" id="catsScroll">
        <div class="cat on" data-cat="all" onclick="selectCategory('all')"><div class="cat-ico">ğŸ”¥</div><span data-i18n="catAll">å…¨éƒ¨</span></div>
        <div class="cat" data-cat="burger" onclick="selectCategory('burger')"><div class="cat-ico">ğŸ”</div><span data-i18n="catBurger">æ±‰å ¡</span></div>
        <div class="cat" data-cat="mexican" onclick="selectCategory('mexican')"><div class="cat-ico">ğŸŒ®</div><span data-i18n="catMexican">å¢¨è¥¿å“¥</span></div>
        <div class="cat" data-cat="noodle" onclick="selectCategory('noodle')"><div class="cat-ico">ğŸœ</div><span data-i18n="catNoodle">é¢é£Ÿ</span></div>
        <div class="cat" data-cat="pizza" onclick="selectCategory('pizza')"><div class="cat-ico">ğŸ•</div><span data-i18n="catPizza">æŠ«è¨</span></div>
        <div class="cat" data-cat="coffee" onclick="selectCategory('coffee')"><div class="cat-ico">â˜•</div><span data-i18n="catCoffee">å’–å•¡</span></div>
      </div>
    </div>
    <div class="filter-row" id="filterRow">
      <button class="chip on" data-filter="hot" onclick="selectFilter('hot')">ğŸ”¥ <span data-i18n="filterHot">çƒ­é—¨</span></button>
      <button class="chip" data-filter="near" onclick="selectFilter('near')">ğŸ“ <span data-i18n="filterNear">æœ€è¿‘</span></button>
      <button class="chip" data-filter="deal" onclick="selectFilter('deal')">ğŸ’° <span data-i18n="filterDeal">ä¼˜æƒ </span></button>
      <button class="chip" data-filter="top" onclick="selectFilter('top')">â­ <span data-i18n="filterTop">å¥½è¯„</span></button>
    </div>
    <!-- Scrollable home body -->
    <div class="home-body" id="homeBody">
      <!-- AI Recommend -->
      <div class="ai-recommend" id="aiRecommendSection">
        <div class="ai-recommend-hd">
          <div class="icon">âœ¨</div>
          <span class="title" data-i18n="aiRecommendTitle">AI ä¸ºä½ æ¨è</span>
          <span class="subtitle" data-i18n="aiRecommendSub">åŸºäºä½ çš„å£å‘³åå¥½</span>
        </div>
        <div class="ai-cards" id="aiCards"></div>
      </div>
      <!-- Mini Map Preview -->
      <div class="map-preview" id="mapPreview" onclick="switchContentTab('map')">
        <div id="mini-map"></div>
      </div>
      <!-- Promo Banner -->
      <div class="promo" id="promoBanner">
        <div><h3 data-i18n="promoTitle">æ–°ç”¨æˆ·é¦–å•ç«‹å‡$5</h3><p data-i18n="promoCode">ä½¿ç”¨ä¼˜æƒ ç  NEARBITE5</p></div>
        <div class="deco"></div><div class="deco2"></div>
      </div>
      <!-- Merchant List -->
      <div id="merchantList"></div>
      <div id="emptyState" class="empty-state" style="display:none">
        <div class="em-icon">ğŸ”</div>
        <p data-i18n="noMerchants">æš‚æ— å•†å®¶ï¼Œè¯·ç¨åå†è¯•</p>
      </div>
    </div>
  </div>

  <!-- ===== FULL MAP VIEW ===== -->
  <div class="full-map-wrap" id="fullMapWrap">
    <div id="full-map"></div>
  </div>

  <!-- ===== DISCOVER PAGE (placeholder) ===== -->
  <div class="pg-placeholder" id="pgDiscover">
    <div class="ph-ico">ğŸ”</div>
    <h3 data-i18n="discoverTitle">å‘ç°</h3>
    <p data-i18n="discoverDesc">æ¢ç´¢æ›´å¤šç¾é£Ÿåˆ†ç±»å’Œä¸»é¢˜æ¨è<br>åŠŸèƒ½å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…</p>
  </div>

  <!-- ===== AI ASSISTANT PAGE (placeholder) ===== -->
  <div class="pg-placeholder" id="pgAI">
    <div class="ph-ico">âœ¨</div>
    <h3 data-i18n="aiTitle">AI ç¾é£ŸåŠ©æ‰‹</h3>
    <p data-i18n="aiDesc">ç”¨è‡ªç„¶è¯­è¨€å‘ç°ç¾é£Ÿã€æ™ºèƒ½ç‚¹é¤<br>åŠŸèƒ½å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…</p>
  </div>

  <!-- ===== ORDERS PAGE (placeholder) ===== -->
  <div class="pg-placeholder" id="pgOrders">
    <div class="ph-ico">ğŸ“‹</div>
    <h3 data-i18n="ordersTitle">æˆ‘çš„è®¢å•</h3>
    <p data-i18n="ordersDesc">æŸ¥çœ‹å†å²è®¢å•å’Œå½“å‰è®¢å•çŠ¶æ€<br>ä¸‹å•åè®¢å•ä¼šå‡ºç°åœ¨è¿™é‡Œ</p>
  </div>

  <!-- ===== PROFILE PAGE ===== -->
  <div id="pgProfile">
    <div class="profile-hero">
      <div class="ph-ico">ğŸ‘¤</div>
      <h3 id="profileUserName">ä¸ªäººä¸­å¿ƒ</h3>
    </div>
    <div class="profile-section-title">â¤ï¸ æˆ‘çš„å…³æ³¨</div>
    <div id="followedList"><div class="followed-empty">è¿˜æ²¡æœ‰å…³æ³¨çš„å•†å®¶</div></div>
    <button class="profile-logout-btn" onclick="doLogout()">é€€å‡ºç™»å½•</button>
  </div>

  <!-- ===== BOTTOM NAV ===== -->
  <nav class="bnav" id="bottomNav">
    <div class="bnav-item on" data-bnav="home" onclick="switchBottomTab('home')"><span class="ico">ğŸ </span><span data-i18n="navHome">é¦–é¡µ</span></div>
    <div class="bnav-item" data-bnav="discover" onclick="switchBottomTab('discover')"><span class="ico">ğŸ”</span><span data-i18n="navDiscover">å‘ç°</span></div>
    <div class="bnav-item" data-bnav="ai" onclick="switchBottomTab('ai')"><span class="ico">âœ¨</span><span data-i18n="navAI">AIåŠ©æ‰‹</span></div>
    <div class="bnav-item" data-bnav="orders" onclick="switchBottomTab('orders')"><span class="ico">ğŸ“‹</span><span data-i18n="navOrders">è®¢å•</span></div>
    <div class="bnav-item" data-bnav="profile" onclick="switchBottomTab('profile')"><span class="ico">ğŸ‘¤</span><span data-i18n="navProfile">æˆ‘çš„</span></div>
  </nav>
</div>

<!-- ==================== CART FLOAT ==================== -->
<button class="cart-float" id="cartFloat" onclick="openCart()">
  ğŸ›’ <span data-i18n="viewCart">æŸ¥çœ‹è´­ç‰©è½¦</span>
  <div class="cart-badge" id="cartBadge">0</div>
</button>

<!-- ==================== CART OVERLAY ==================== -->
<div class="cart-overlay" id="cartOverlay" onclick="closeCart()">
  <div class="cart-panel" onclick="event.stopPropagation()">
    <div class="cart-handle"></div>
    <div class="cart-header">
      <span class="cart-title" data-i18n="cart">è´­ç‰©è½¦</span>
      <button class="cart-close" onclick="closeCart()">âœ•</button>
    </div>
    <div class="cart-items" id="cartItems">
      <div class="cart-empty" data-i18n="cartEmpty">è´­ç‰©è½¦æ˜¯ç©ºçš„</div>
    </div>
    <div class="cart-footer" id="cartFooter" style="display:none">
      <div class="cart-total">
        <span data-i18n="total">åˆè®¡</span>
        <span class="cart-total-amount" id="cartTotal">$0</span>
      </div>
      <textarea class="cart-note" id="cartNote" rows="2" data-i18n-placeholder="cartNotePh" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
      <button class="checkout-btn" onclick="submitOrder()" data-i18n="placeOrder">æäº¤è®¢å•</button>
    </div>
  </div>
</div>

<!-- ==================== ORDER STATUS PANEL ==================== -->
<div class="order-panel" id="orderPanel">
  <div class="order-header">
    <span class="order-id" id="orderIdText"></span>
    <button class="order-close" onclick="closeOrderPanel()">âœ•</button>
  </div>
  <div class="order-status-title" id="orderStatusTitle"></div>
  <div class="status-progress">
    <div class="status-progress-fill" id="statusProgressFill" style="width:0"></div>
    <div class="status-step" id="step-pending"><div class="status-icon">ğŸ“</div><div class="status-label" data-i18n="sPending">å·²ä¸‹å•</div></div>
    <div class="status-step" id="step-confirmed"><div class="status-icon">âœ…</div><div class="status-label" data-i18n="sConfirmed">å·²æ¥å•</div></div>
    <div class="status-step" id="step-preparing"><div class="status-icon">ğŸ‘¨â€ğŸ³</div><div class="status-label" data-i18n="sPreparing">åˆ¶ä½œä¸­</div></div>
    <div class="status-step" id="step-ready"><div class="status-icon">ğŸ‰</div><div class="status-label" data-i18n="sReady">å¯å–é¤</div></div>
  </div>
  <div class="order-action"><button onclick="closeOrderPanel()" data-i18n="close">å…³é—­</button></div>
</div>

<!-- ==================== TOAST ==================== -->
<div class="toast-container" id="toastContainer"></div>

<!-- ==================== LOADING ==================== -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-msg" id="loadingMsg" data-i18n="loading">åŠ è½½ä¸­...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ============================================================
   NearBite Consumer Frontend â€” Complete JS
   ============================================================ */

// ========== CONFIG ==========
const BASE_URL = 'https://wcp-merchant-platform-production-dcdb.up.railway.app';
const API_BASE = '/api';
const DEFAULT_CENTER = { lat: -43.532, lng: 172.636 };
const DEFAULT_RADIUS = 5000;

// ========== STATE ==========
let currentLang = localStorage.getItem('nb_lang') || 'zh';
let allMerchants = [];
let currentCategory = 'all';
let currentFilter = 'hot';
let currentContentTab = 'recommend';
let currentBottomTab = 'home';
let miniMap = null;
let fullMap = null;
let miniMapMarkers = [];
let fullMapMarkers = [];
let cart = JSON.parse(localStorage.getItem('nb_cart') || '[]');
let currentMerchantId = localStorage.getItem('nb_cartMerchant') || null;
let expandedCardId = null;
let orderSSE = null;

// ========== i18n ==========
const LANG = {
  zh: {
    loginSlogan: 'å‘ç°èº«è¾¹çš„ç¾å‘³é¤è½¦',
    phone: 'æ‰‹æœºå·', phonePh: 'è¯·è¾“å…¥æ‰‹æœºå·',
    password: 'å¯†ç ', passwordPh: 'è¯·è¾“å…¥å¯†ç ',
    loginBtn: 'ç™» å½•', or: 'æˆ–',
    noAccount: 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ', registerNow: 'ç«‹å³æ³¨å†Œ',
    hasAccount: 'å·²æœ‰è´¦å·ï¼Ÿ', loginNow: 'ç«‹å³ç™»å½•',
    username: 'ç”¨æˆ·å', usernamePh: 'è¯·è¾“å…¥ç”¨æˆ·å',
    registerBtn: 'æ³¨ å†Œ',
    searchPh: 'æˆ‘æƒ³åƒè¾£çš„ã€$15ä»¥å†…...',
    tabRecommend: 'æ¨è', tabNearby: 'é™„è¿‘', tabMap: 'åœ°å›¾', tabRating: 'è¯„åˆ†',
    catAll: 'å…¨éƒ¨', catBurger: 'æ±‰å ¡', catMexican: 'å¢¨è¥¿å“¥', catNoodle: 'é¢é£Ÿ', catPizza: 'æŠ«è¨', catCoffee: 'å’–å•¡',
    filterHot: 'çƒ­é—¨', filterNear: 'æœ€è¿‘', filterDeal: 'ä¼˜æƒ ', filterTop: 'å¥½è¯„',
    aiRecommendTitle: 'AI ä¸ºä½ æ¨è', aiRecommendSub: 'åŸºäºä½ çš„å£å‘³åå¥½',
    promoTitle: 'æ–°ç”¨æˆ·é¦–å•ç«‹å‡$5', promoCode: 'ä½¿ç”¨ä¼˜æƒ ç  NEARBITE5',
    noMerchants: 'æš‚æ— å•†å®¶ï¼Œè¯·ç¨åå†è¯•',
    viewCart: 'æŸ¥çœ‹è´­ç‰©è½¦', cart: 'è´­ç‰©è½¦', cartEmpty: 'è´­ç‰©è½¦æ˜¯ç©ºçš„',
    total: 'åˆè®¡', cartNotePh: 'å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰', placeOrder: 'æäº¤è®¢å•',
    close: 'å…³é—­', loading: 'åŠ è½½ä¸­...',
    sPending: 'å·²ä¸‹å•', sConfirmed: 'å·²æ¥å•', sPreparing: 'åˆ¶ä½œä¸­', sReady: 'å¯å–é¤',
    monthSales: 'æœˆé”€', km: 'km', pickup: 'åˆ°åº—è‡ªå–', open: 'è¥ä¸šä¸­', closed: 'ä¼‘æ¯ä¸­',
    menu: 'èœå•', addToCart: '+',
    navHome: 'é¦–é¡µ', navDiscover: 'å‘ç°', navAI: 'AIåŠ©æ‰‹', navOrders: 'è®¢å•', navProfile: 'æˆ‘çš„',
    discoverTitle: 'å‘ç°', discoverDesc: 'æ¢ç´¢æ›´å¤šç¾é£Ÿåˆ†ç±»å’Œä¸»é¢˜æ¨è\nåŠŸèƒ½å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…',
    aiTitle: 'AI ç¾é£ŸåŠ©æ‰‹', aiDesc: 'ç”¨è‡ªç„¶è¯­è¨€å‘ç°ç¾é£Ÿã€æ™ºèƒ½ç‚¹é¤\nåŠŸèƒ½å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…',
    ordersTitle: 'æˆ‘çš„è®¢å•', ordersDesc: 'æŸ¥çœ‹å†å²è®¢å•å’Œå½“å‰è®¢å•çŠ¶æ€\nä¸‹å•åè®¢å•ä¼šå‡ºç°åœ¨è¿™é‡Œ',
    profileTitle: 'ä¸ªäººä¸­å¿ƒ', profileDesc: 'ç®¡ç†è´¦æˆ·ã€æ”¶è—ã€è®¾ç½®\nåŠŸèƒ½å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…',
    logoutBtn: 'é€€å‡ºç™»å½•',
    loginFail: 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰‹æœºå·å’Œå¯†ç ',
    regFail: 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•',
    orderSuccess: 'ä¸‹å•æˆåŠŸï¼',
    orderFail: 'ä¸‹å•å¤±è´¥ï¼Œè¯·é‡è¯•',
    cartDiffMerchant: 'è´­ç‰©è½¦ä¸­æœ‰å…¶ä»–å•†å®¶çš„å•†å“ï¼Œæ˜¯å¦æ¸…ç©ºï¼Ÿ',
    aiTag: 'AIæ¨è', topReview: 'å¥½è¯„æœ€å¤š', spicyPick: 'è¾£å‘³é¦–é€‰',
    viewMap: 'æŸ¥çœ‹åœ°å›¾'
  },
  en: {
    loginSlogan: 'Discover nearby food trucks',
    phone: 'Phone', phonePh: 'Enter phone number',
    password: 'Password', passwordPh: 'Enter password',
    loginBtn: 'Log In', or: 'or',
    noAccount: "Don't have an account?", registerNow: 'Sign Up',
    hasAccount: 'Already have an account?', loginNow: 'Log In',
    username: 'Username', usernamePh: 'Enter username',
    registerBtn: 'Sign Up',
    searchPh: 'I want spicy food under $15...',
    tabRecommend: 'For You', tabNearby: 'Nearby', tabMap: 'Map', tabRating: 'Top Rated',
    catAll: 'All', catBurger: 'Burger', catMexican: 'Mexican', catNoodle: 'Noodles', catPizza: 'Pizza', catCoffee: 'Coffee',
    filterHot: 'Popular', filterNear: 'Nearest', filterDeal: 'Deals', filterTop: 'Top Rated',
    aiRecommendTitle: 'AI Picks for You', aiRecommendSub: 'Based on your preferences',
    promoTitle: '$5 off your first order', promoCode: 'Use code NEARBITE5',
    noMerchants: 'No merchants found. Try again later.',
    viewCart: 'View Cart', cart: 'Cart', cartEmpty: 'Your cart is empty',
    total: 'Total', cartNotePh: 'Notes (optional)', placeOrder: 'Place Order',
    close: 'Close', loading: 'Loading...',
    sPending: 'Placed', sConfirmed: 'Confirmed', sPreparing: 'Preparing', sReady: 'Ready',
    monthSales: 'monthly', km: 'km', pickup: 'Self Pickup', open: 'Open', closed: 'Closed',
    menu: 'Menu', addToCart: '+',
    navHome: 'Home', navDiscover: 'Explore', navAI: 'AI', navOrders: 'Orders', navProfile: 'Me',
    discoverTitle: 'Explore', discoverDesc: 'Discover more food categories\nComing soon',
    aiTitle: 'AI Food Assistant', aiDesc: 'Discover food with natural language\nComing soon',
    ordersTitle: 'My Orders', ordersDesc: 'View order history and status\nOrders will appear here',
    profileTitle: 'Profile', profileDesc: 'Manage account, favorites, settings\nComing soon',
    logoutBtn: 'Log Out',
    loginFail: 'Login failed. Check phone & password.',
    regFail: 'Registration failed. Please try again.',
    orderSuccess: 'Order placed!',
    orderFail: 'Order failed. Try again.',
    cartDiffMerchant: 'Cart has items from another merchant. Clear cart?',
    aiTag: 'AI Pick', topReview: 'Most Liked', spicyPick: 'Spicy Pick',
    viewMap: 'View Map'
  }
};

function t(key) { return (LANG[currentLang] || LANG.zh)[key] || key; }

function applyI18n() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    const val = t(k);
    if (val) el.textContent = val;
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const k = el.getAttribute('data-i18n-placeholder');
    const val = t(k);
    if (val) el.placeholder = val;
  });
}

function switchLang(lang) {
  currentLang = lang;
  localStorage.setItem('nb_lang', lang);
  document.getElementById('langSelect').value = lang;
  applyI18n();
  renderMerchants();
  renderAICards();
}

// ========== API ==========
async function apiCall(path, options = {}) {
  const token = localStorage.getItem('token');
  const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const url = path.startsWith('http') ? path : `${BASE_URL}${path}`;
  const res = await fetch(url, { ...options, headers });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw { status: res.status, ...err };
  }
  return res.json();
}

// ========== TOAST ==========
function showToast(msg, type = 'info') {
  const c = document.getElementById('toastContainer');
  const d = document.createElement('div');
  d.className = `toast ${type}`;
  d.textContent = msg;
  c.appendChild(d);
  setTimeout(() => d.remove(), 3000);
}

// ========== LOADING ==========
function showLoading(show, msg) {
  const el = document.getElementById('loadingOverlay');
  if (show) { el.classList.add('active'); if (msg) document.getElementById('loadingMsg').textContent = msg; }
  else el.classList.remove('active');
}

// ========== AUTH ==========
function showFullLoginPage() {
  document.getElementById('loginOverlay').classList.add('show');
  document.getElementById('appContainer').classList.remove('show');
}

function hideLoginPage() {
  document.getElementById('loginOverlay').classList.remove('show');
  document.getElementById('appContainer').classList.add('show');
}

function toggleLoginRegister(showReg) {
  document.getElementById('loginForm').style.display = showReg ? 'none' : '';
  document.getElementById('registerForm').style.display = showReg ? '' : 'none';
  document.getElementById('loginErr').textContent = '';
  document.getElementById('regErr').textContent = '';
}

async function doFullLogin() {
  const phone = document.getElementById('loginPhone').value.trim();
  const pass = document.getElementById('loginPass').value;
  if (!phone || !pass) { document.getElementById('loginErr').textContent = t('loginFail'); return; }
  showLoading(true);
  try {
    const data = await apiCall(`${API_BASE}/auth/login`, {
      method: 'POST',
      body: JSON.stringify({ phone, password: pass })
    });
    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify(data.user || data));
    showLoading(false);
    routeByRole(data.user || data);
  } catch (e) {
    showLoading(false);
    document.getElementById('loginErr').textContent = t('loginFail');
  }
}

async function doFullRegister() {
  const name = document.getElementById('regName').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const pass = document.getElementById('regPass').value;
  if (!name || !phone || !pass) { document.getElementById('regErr').textContent = t('regFail'); return; }
  showLoading(true);
  try {
    const data = await apiCall(`${API_BASE}/auth/register`, {
      method: 'POST',
      body: JSON.stringify({ name, phone, password: pass, role: 'consumer' })
    });
    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify(data.user || data));
    showLoading(false);
    routeByRole(data.user || data);
  } catch (e) {
    showLoading(false);
    document.getElementById('regErr').textContent = t('regFail');
  }
}

function routeByRole(user) {
  if (!user) { showFullLoginPage(); return; }
  const role = user.role || 'consumer';
  if (role === 'merchant') { window.location.href = 'merchant.html'; return; }
  if (role === 'admin') { window.location.href = 'admin.html'; return; }
  hideLoginPage();
  initConsumerPage();
}

async function checkAuthAndInit() {
  const token = localStorage.getItem('token');
  // Check QR entry
  const params = new URLSearchParams(window.location.search);
  const qrMerchant = params.get('merchant');
  const qrTable = params.get('table');

  if (!token) {
    if (qrMerchant) {
      // Allow browsing without login for QR entry
      hideLoginPage();
      initConsumerPage(qrMerchant, qrTable);
    } else {
      showFullLoginPage();
    }
    return;
  }
  showLoading(true);
  try {
    const data = await apiCall(`${API_BASE}/auth/me`);
    const user = data.user || data;
    localStorage.setItem('user', JSON.stringify(user));
    showLoading(false);
    routeByRole(user);
  } catch (e) {
    showLoading(false);
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    if (qrMerchant) {
      hideLoginPage();
      initConsumerPage(qrMerchant, qrTable);
    } else {
      showFullLoginPage();
    }
  }
}

function doLogout() {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  localStorage.removeItem('nb_cart');
  localStorage.removeItem('nb_cartMerchant');
  cart = [];
  currentMerchantId = null;
  showFullLoginPage();
}

// ========== CONSUMER PAGE INIT ==========
async function initConsumerPage(qrMerchantId, qrTable) {
  applyI18n();
  updateCartUI();
  await loadMerchants();
  initMiniMap();
  if (qrMerchantId) {
    // Auto-expand QR merchant
    setTimeout(() => {
      const card = document.querySelector(`.v-card[data-id="${qrMerchantId}"]`);
      if (card) { card.click(); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }, 500);
  }
}

// ========== LOAD MERCHANTS ==========
async function loadMerchants() {
  try {
    const data = await apiCall(`${API_BASE}/merchants/nearby?lat=${DEFAULT_CENTER.lat}&lng=${DEFAULT_CENTER.lng}&radius=${DEFAULT_RADIUS}`);
    allMerchants = (Array.isArray(data) ? data : (data.merchants || [])).map(m => ({ ...m, _id: m._id || m.id }));
  } catch (e) {
    console.warn('API failed, using mock data', e);
    allMerchants = getMockMerchants();
  }
  if (!allMerchants.length) allMerchants = getMockMerchants();
  renderMerchants();
  renderAICards();
}

function getMockMerchants() {
  return [
    { _id:'m1', name:'å¢¨è¥¿å“¥ Taco é¤è½¦', name_en:'Mexican Taco Truck', type:'mexican', emoji:'ğŸŒ®', rating:4.8, monthlySales:520, distance:1.2, isOpen:true, location:{coordinates:[172.636,-43.530]}, menu:[{name:'ç»å…¸ç‰›è‚‰Taco',name_en:'Classic Beef Taco',price:12,category:'æ‹›ç‰Œ'},{name:'é¸¡è‚‰å·é¥¼',name_en:'Chicken Burrito',price:14,category:'æ‹›ç‰Œ'},{name:'ç‰ç±³ç‰‡',name_en:'Nachos',price:8,category:'å°é£Ÿ'}] },
    { _id:'m2', name:'Burger Brothers é¤è½¦', name_en:'Burger Brothers Truck', type:'burger', emoji:'ğŸ”', rating:4.6, monthlySales:380, distance:0.8, isOpen:true, location:{coordinates:[172.638,-43.533]}, menu:[{name:'ç»å…¸å®‰æ ¼æ–¯ç‰›å ¡',name_en:'Classic Angus Burger',price:16,category:'æ±‰å ¡'},{name:'èŠå£«åŸ¹æ ¹å ¡',name_en:'Cheese Bacon Burger',price:18,category:'æ±‰å ¡'},{name:'è–¯æ¡',name_en:'Fries',price:5,category:'å°é£Ÿ'}] },
    { _id:'m3', name:'é‡åº†å°é¢', name_en:'Chongqing Noodles', type:'noodle', emoji:'ğŸœ', rating:4.7, monthlySales:290, distance:2.1, isOpen:true, location:{coordinates:[172.634,-43.531]}, menu:[{name:'é‡åº†å°é¢',name_en:'Chongqing Noodles',price:13,category:'é¢é£Ÿ'},{name:'æ‹…æ‹…é¢',name_en:'Dan Dan Noodles',price:14,category:'é¢é£Ÿ'},{name:'å†°ç²‰',name_en:'Ice Jelly',price:5,category:'é¥®å“'}] },
    { _id:'m4', name:'Pizza Wheels', name_en:'Pizza Wheels', type:'pizza', emoji:'ğŸ•', rating:4.5, monthlySales:210, distance:1.5, isOpen:false, location:{coordinates:[172.640,-43.534]}, menu:[{name:'ç›æ ¼ä¸½ç‰¹æŠ«è¨',name_en:'Margherita Pizza',price:15,category:'æŠ«è¨'},{name:'å¤å¨å¤·æŠ«è¨',name_en:'Hawaiian Pizza',price:17,category:'æŠ«è¨'}] },
    { _id:'m5', name:'Kiwi Coffee Cart', name_en:'Kiwi Coffee Cart', type:'coffee', emoji:'â˜•', rating:4.9, monthlySales:600, distance:0.3, isOpen:true, location:{coordinates:[172.637,-43.532]}, menu:[{name:'Flat White',name_en:'Flat White',price:5,category:'å’–å•¡'},{name:'Long Black',name_en:'Long Black',price:4.5,category:'å’–å•¡'},{name:'æŠ¹èŒ¶æ‹¿é“',name_en:'Matcha Latte',price:6,category:'å’–å•¡'}] }
  ];
}

// ========== RENDER MERCHANTS ==========
function getFilteredMerchants() {
  let list = [...allMerchants];
  // Category filter
  if (currentCategory !== 'all') {
    list = list.filter(m => (m.type || '').toLowerCase() === currentCategory);
  }
  // Sort by filter
  if (currentFilter === 'near') list.sort((a, b) => (a.distance || 99) - (b.distance || 99));
  else if (currentFilter === 'top') list.sort((a, b) => (b.rating || 0) - (a.rating || 0));
  else if (currentFilter === 'hot') list.sort((a, b) => (b.monthlySales || 0) - (a.monthlySales || 0));
  return list;
}

function renderMerchants() {
  const list = getFilteredMerchants();
  const container = document.getElementById('merchantList');
  const empty = document.getElementById('emptyState');

  if (!list.length) {
    container.innerHTML = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';

  container.innerHTML = list.map(m => {
    const name = currentLang === 'en' && m.name_en ? m.name_en : m.name;
    const emoji = m.emoji || 'ğŸ½ï¸';
    const rating = m.rating ? m.rating.toFixed(1) : 'â€”';
    const dist = m.distance ? m.distance.toFixed(1) : '?';
    const sales = m.monthlySales || 0;
    const isOpen = m.isOpen !== false;
    const tags = [];
    if (sales > 300) tags.push(`<span class="v-tag">ğŸ”¥ ${t('filterHot')}</span>`);
    if (m.rating >= 4.7) tags.push(`<span class="v-tag-ai">âœ¨ ${t('aiTag')}</span>`);

    return `
      <div class="v-card" data-id="${m._id}" onclick="toggleMerchantMenu('${m._id}')">
        <div class="v-img">${emoji}</div>
        <div class="v-info">
          <div class="v-name">${name}</div>
          <div class="v-rate"><span class="star">â­</span> ${rating} Â· ${t('monthSales')} ${sales}+</div>
          <div class="v-tags">${tags.join('')}</div>
          <div class="v-meta">
            <span>${dist} ${t('km')} Â· ${t('pickup')}</span>
            <span class="${isOpen ? 'open' : ''}">${isOpen ? 'â— ' + t('open') : 'â— ' + t('closed')}</span>
          </div>
          <div class="menu-expand" id="menu-${m._id}"></div>
        </div>
      </div>
    `;
  }).join('');
}

// ========== RENDER AI CARDS ==========
function renderAICards() {
  const top = [...allMerchants].sort((a, b) => (b.rating || 0) - (a.rating || 0)).slice(0, 4);
  const aiLabels = [t('aiTag'), t('topReview'), t('spicyPick'), 'ğŸ†• New'];
  const container = document.getElementById('aiCards');
  container.innerHTML = top.map((m, i) => {
    const name = currentLang === 'en' && m.name_en ? m.name_en : m.name;
    const emoji = m.emoji || 'ğŸ½ï¸';
    return `
      <div class="ai-card" onclick="toggleMerchantMenu('${m._id}');scrollToCard('${m._id}')">
        <div class="ai-card-img">${emoji}</div>
        <div class="ai-card-name">${name}</div>
        <div class="ai-card-desc">â­${(m.rating||0).toFixed(1)} Â· ${(m.distance||0).toFixed(1)}km</div>
        <span class="ai-card-tag">${aiLabels[i] || t('aiTag')}</span>
      </div>
    `;
  }).join('');
}

function scrollToCard(id) {
  setTimeout(() => {
    const card = document.querySelector(`.v-card[data-id="${id}"]`);
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

// ========== MENU EXPAND ==========
async function toggleMerchantMenu(merchantId) {
  const menuEl = document.getElementById(`menu-${merchantId}`);
  if (!menuEl) return;

  if (expandedCardId === merchantId) {
    menuEl.classList.remove('show');
    menuEl.innerHTML = '';
    expandedCardId = null;
    return;
  }

  // Close previous
  if (expandedCardId) {
    const prev = document.getElementById(`menu-${expandedCardId}`);
    if (prev) { prev.classList.remove('show'); prev.innerHTML = ''; }
  }
  expandedCardId = merchantId;

  const merchant = allMerchants.find(m => m._id === merchantId);
  if (!merchant) return;

  let menuItems = merchant.menu || [];
  if (!menuItems.length) {
    try {
      const data = await apiCall(`${API_BASE}/merchants/${merchantId}`);
      menuItems = (data.merchant || data).menu || [];
      merchant.menu = menuItems;
    } catch (e) { /* use empty */ }
  }

  // Build menu HTML
  let menuHTML = '';
  if (!menuItems.length) {
    menuHTML = `<p style="color:var(--g4);font-size:13px;text-align:center;padding:12px">${t('noMerchants')}</p>`;
  } else {
    const groups = {};
    menuItems.forEach(item => {
      const cat = item.category || 'Menu';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(item);
    });
    for (const [cat, items] of Object.entries(groups)) {
      menuHTML += `<div class="menu-category">${cat}</div>`;
      items.forEach(item => {
        const itemName = currentLang === 'en' && item.name_en ? item.name_en : item.name;
        menuHTML += `
          <div class="menu-item">
            <div class="menu-item-info">
              <div class="menu-item-name">${itemName}</div>
              <div class="menu-item-price">$${(item.price || 0).toFixed(2)}</div>
            </div>
            <button class="menu-item-add" onclick="event.stopPropagation();addToCart('${merchantId}','${(item.name||'').replace(/'/g,"\\'")}',${item.price||0})">+</button>
          </div>
        `;
      });
    }
  }

  // Render: follow row + tabs + content
  menuEl.innerHTML = `
    <div class="follow-row">
      <div class="follow-info" id="follow-info-${merchantId}"><span id="follow-count-${merchantId}">â€¦</span> äººå…³æ³¨</div>
      <button class="btn-follow" id="follow-btn-${merchantId}" onclick="event.stopPropagation();toggleFollow('${merchantId}')">å…³æ³¨</button>
    </div>
    <div class="expand-tabs">
      <button class="expand-tab on" id="tab-menu-${merchantId}" onclick="event.stopPropagation();switchExpandTab('${merchantId}','menu')">ğŸ½ï¸ èœå•</button>
      <button class="expand-tab" id="tab-sched-${merchantId}" onclick="event.stopPropagation();switchExpandTab('${merchantId}','sched')">ğŸ“… æ—¥ç¨‹</button>
    </div>
    <div id="expand-menu-${merchantId}">${menuHTML}</div>
    <div id="expand-sched-${merchantId}" style="display:none"><div class="schedule-empty">åŠ è½½ä¸­â€¦</div></div>
  `;
  menuEl.classList.add('show');

  // Async: load follow status
  loadFollowStatus(merchantId);
}

// ========== SEARCH ==========
function onSearchInput(val) {
  const q = val.trim().toLowerCase();
  if (!q) { renderMerchants(); return; }
  const container = document.getElementById('merchantList');
  const filtered = allMerchants.filter(m => {
    const name = (m.name || '').toLowerCase();
    const nameEn = (m.name_en || '').toLowerCase();
    const type = (m.type || '').toLowerCase();
    return name.includes(q) || nameEn.includes(q) || type.includes(q);
  });
  // Temporarily override and render
  const origAll = allMerchants;
  allMerchants = filtered;
  renderMerchants();
  allMerchants = origAll;
}

// ========== TABS & FILTERS ==========
function switchContentTab(tab) {
  currentContentTab = tab;
  document.querySelectorAll('#contentTabs .tab').forEach(el => {
    el.classList.toggle('on', el.dataset.tab === tab);
  });

  const homeBody = document.getElementById('homeBody');
  const homeCats = document.getElementById('homeCats');
  const filterRow = document.getElementById('filterRow');
  const fullMapWrap = document.getElementById('fullMapWrap');

  if (tab === 'map') {
    homeBody.style.display = 'none';
    homeCats.style.display = 'none';
    filterRow.style.display = 'none';
    fullMapWrap.classList.add('show');
    initFullMap();
  } else {
    homeBody.style.display = '';
    homeCats.style.display = '';
    filterRow.style.display = '';
    fullMapWrap.classList.remove('show');

    if (tab === 'nearby') {
      currentFilter = 'near';
      updateFilterUI();
    } else if (tab === 'rating') {
      currentFilter = 'top';
      updateFilterUI();
    } else {
      currentFilter = 'hot';
      updateFilterUI();
    }
    renderMerchants();
  }
}

function selectCategory(cat) {
  currentCategory = cat;
  document.querySelectorAll('#catsScroll .cat').forEach(el => {
    el.classList.toggle('on', el.dataset.cat === cat);
  });
  renderMerchants();
}

function selectFilter(filter) {
  currentFilter = filter;
  updateFilterUI();
  renderMerchants();
}

function updateFilterUI() {
  document.querySelectorAll('#filterRow .chip').forEach(el => {
    el.classList.toggle('on', el.dataset.filter === currentFilter);
  });
}

// ========== BOTTOM NAV ==========
function switchBottomTab(tab) {
  currentBottomTab = tab;

  // Update nav items
  document.querySelectorAll('#bottomNav .bnav-item').forEach(el => {
    el.classList.remove('on', 'ai-on');
    if (el.dataset.bnav === tab) {
      el.classList.add(tab === 'ai' ? 'ai-on' : 'on');
    }
  });

  // Hide all pages
  document.getElementById('pgHome').classList.remove('show');
  document.getElementById('pgDiscover').classList.remove('show');
  document.getElementById('pgAI').classList.remove('show');
  document.getElementById('pgOrders').classList.remove('show');
  document.getElementById('pgProfile').classList.remove('show');
  document.getElementById('pgProfile').classList.remove('show');
  document.getElementById('fullMapWrap').classList.remove('show');

  // Show selected page
  const pageMap = { home: 'pgHome', discover: 'pgDiscover', ai: 'pgAI', orders: 'pgOrders', profile: 'pgProfile' };
  const pg = document.getElementById(pageMap[tab]);
  if (pg) pg.classList.add('show');

  // If going back to home, ensure map is closed
  if (tab === 'home' && currentContentTab === 'map') {
    document.getElementById('fullMapWrap').classList.add('show');
  }
  // Load profile data
  if (tab === 'profile') loadFollowedList();
}

// ========== MAPS ==========
function initMiniMap() {
  if (miniMap) return;
  const el = document.getElementById('mini-map');
  if (!el) return;
  miniMap = L.map(el, {
    center: [DEFAULT_CENTER.lat, DEFAULT_CENTER.lng],
    zoom: 14,
    zoomControl: false,
    attributionControl: false,
    dragging: false,
    scrollWheelZoom: false,
    doubleClickZoom: false,
    touchZoom: false
  });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(miniMap);
  addMapMarkers(miniMap, miniMapMarkers);
  setTimeout(() => miniMap.invalidateSize(), 300);
}

function initFullMap() {
  if (fullMap) { fullMap.invalidateSize(); addMapMarkers(fullMap, fullMapMarkers); return; }
  const el = document.getElementById('full-map');
  if (!el) return;
  fullMap = L.map(el, {
    center: [DEFAULT_CENTER.lat, DEFAULT_CENTER.lng],
    zoom: 14,
    zoomControl: true,
    attributionControl: false
  });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(fullMap);

  // User location marker
  L.circleMarker([DEFAULT_CENTER.lat, DEFAULT_CENTER.lng], {
    radius: 8, fillColor: '#ff6b35', fillOpacity: 1, color: '#fff', weight: 3
  }).addTo(fullMap).bindPopup('<b>ğŸ“ You are here</b>');

  addMapMarkers(fullMap, fullMapMarkers);
  setTimeout(() => fullMap.invalidateSize(), 300);
}

function addMapMarkers(map, markersArray) {
  // Clear existing
  markersArray.forEach(m => map.removeLayer(m));
  markersArray.length = 0;

  allMerchants.forEach(m => {
    if (!m.location || !m.location.coordinates) return;
    const [lng, lat] = m.location.coordinates;
    const name = currentLang === 'en' && m.name_en ? m.name_en : m.name;
    const emoji = m.emoji || 'ğŸ½ï¸';
    const icon = L.divIcon({
      className: '',
      html: `<div style="background:#ff6b35;color:#fff;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(255,107,53,.3)">${emoji} ${name.slice(0,6)}</div>`,
      iconSize: [0, 0],
      iconAnchor: [0, 0]
    });
    const marker = L.marker([lat, lng], { icon }).addTo(map);
    marker.bindPopup(`
      <div class="popup-rich">
        <div class="pr-name">${emoji} ${name}</div>
        <div class="pr-type">${m.type || ''}</div>
        <div class="pr-stars">â­ ${(m.rating||0).toFixed(1)}</div>
        <div class="pr-dist">${(m.distance||0).toFixed(1)} km</div>
      </div>
    `);
    markersArray.push(marker);
  });
}

// ========== CART ==========
function addToCart(merchantId, itemName, price) {
  if (currentMerchantId && currentMerchantId !== merchantId && cart.length > 0) {
    if (!confirm(t('cartDiffMerchant'))) return;
    cart = [];
  }
  currentMerchantId = merchantId;
  localStorage.setItem('nb_cartMerchant', merchantId);

  const existing = cart.find(c => c.name === itemName && c.merchantId === merchantId);
  if (existing) {
    existing.qty++;
  } else {
    cart.push({ merchantId, name: itemName, price, qty: 1 });
  }
  saveCart();
  updateCartUI();
  showToast(`${itemName} +1`, 'success');
}

function removeFromCart(index) {
  cart.splice(index, 1);
  if (!cart.length) { currentMerchantId = null; localStorage.removeItem('nb_cartMerchant'); }
  saveCart();
  updateCartUI();
  renderCartPanel();
}

function changeQty(index, delta) {
  cart[index].qty += delta;
  if (cart[index].qty <= 0) { removeFromCart(index); return; }
  saveCart();
  updateCartUI();
  renderCartPanel();
}

function saveCart() {
  localStorage.setItem('nb_cart', JSON.stringify(cart));
}

function updateCartUI() {
  const total = cart.reduce((s, c) => s + c.qty, 0);
  const floatEl = document.getElementById('cartFloat');
  const badge = document.getElementById('cartBadge');
  if (total > 0) {
    floatEl.classList.add('show');
    badge.textContent = total;
  } else {
    floatEl.classList.remove('show');
  }
}

function openCart() {
  renderCartPanel();
  document.getElementById('cartOverlay').classList.add('show');
}

function closeCart() {
  document.getElementById('cartOverlay').classList.remove('show');
}

function renderCartPanel() {
  const container = document.getElementById('cartItems');
  const footer = document.getElementById('cartFooter');

  if (!cart.length) {
    container.innerHTML = `<div class="cart-empty">${t('cartEmpty')}</div>`;
    footer.style.display = 'none';
    return;
  }

  footer.style.display = '';
  let total = 0;
  container.innerHTML = cart.map((item, i) => {
    const itemTotal = item.price * item.qty;
    total += itemTotal;
    return `
      <div class="cart-item">
        <div class="cart-item-info">
          <div class="cart-item-name">${item.name}</div>
          <div class="cart-item-price">$${item.price.toFixed(2)}</div>
        </div>
        <div class="cart-item-qty">
          <button class="qty-btn" onclick="changeQty(${i},-1)">âˆ’</button>
          <span>${item.qty}</span>
          <button class="qty-btn" onclick="changeQty(${i},1)">+</button>
        </div>
        <div class="cart-item-total">$${itemTotal.toFixed(2)}</div>
      </div>
    `;
  }).join('');

  document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
}

// ========== ORDERS ==========
async function submitOrder() {
  if (!cart.length) return;
  const token = localStorage.getItem('token');
  if (!token) { showToast(t('loginFail'), 'error'); return; }

  const note = document.getElementById('cartNote').value.trim();
  const items = cart.map(c => ({ name: c.name, quantity: c.qty, price: c.price }));
  const totalAmount = cart.reduce((s, c) => s + c.price * c.qty, 0);

  showLoading(true);
  try {
    // Get pickup methods
    let pickupMethod = 'counter';
    try {
      const methods = await apiCall(`${API_BASE}/merchants/${currentMerchantId}/pickup-methods`);
      if (methods && methods.length) pickupMethod = methods[0].type || 'counter';
    } catch (e) { /* use default */ }

    const order = await apiCall(`${API_BASE}/orders`, {
      method: 'POST',
      body: JSON.stringify({
        merchantId: currentMerchantId,
        items,
        totalAmount,
        pickupMethod,
        note,
        tableNumber: null
      })
    });

    showLoading(false);
    closeCart();
    cart = [];
    currentMerchantId = null;
    saveCart();
    updateCartUI();
    showToast(t('orderSuccess'), 'success');

    if (order._id || order.id) {
      showOrderPanel(order);
      startOrderSSE(order._id || order.id);
    }
  } catch (e) {
    showLoading(false);
    showToast(t('orderFail'), 'error');
  }
}

function showOrderPanel(order) {
  const panel = document.getElementById('orderPanel');
  document.getElementById('orderIdText').textContent = `#${(order._id || order.id || '').slice(-8)}`;
  updateOrderStatus(order.status || 'pending');
  panel.classList.add('show');
}

function closeOrderPanel() {
  document.getElementById('orderPanel').classList.remove('show');
  if (orderSSE) { orderSSE.close(); orderSSE = null; }
}

function updateOrderStatus(status) {
  const steps = ['pending', 'confirmed', 'preparing', 'ready'];
  const idx = steps.indexOf(status);
  const titles = {
    pending: 'â³ ' + t('sPending'),
    confirmed: 'âœ… ' + t('sConfirmed'),
    preparing: 'ğŸ‘¨â€ğŸ³ ' + t('sPreparing'),
    ready: 'ğŸ‰ ' + t('sReady')
  };
  document.getElementById('orderStatusTitle').textContent = titles[status] || status;

  steps.forEach((s, i) => {
    const el = document.getElementById(`step-${s}`);
    el.classList.remove('done', 'active');
    if (i < idx) el.classList.add('done');
    else if (i === idx) el.classList.add('active');
  });

  const fill = document.getElementById('statusProgressFill');
  const pct = idx >= 0 ? (idx / (steps.length - 1)) * 100 : 0;
  fill.style.width = `calc(${pct}% - 40px)`;
}

function startOrderSSE(orderId) {
  if (orderSSE) orderSSE.close();
  const token = localStorage.getItem('token');
  try {
    orderSSE = new EventSource(`${BASE_URL}${API_BASE}/orders/${orderId}/stream?token=${token}`);
    orderSSE.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);
        if (data.status) updateOrderStatus(data.status);
      } catch (err) { /* ignore parse errors */ }
    };
    orderSSE.onerror = () => { /* silent */ };
  } catch (e) { /* SSE not supported */ }
}

// ========== GEOLOCATION ==========
function tryGeolocate() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      DEFAULT_CENTER.lat = pos.coords.latitude;
      DEFAULT_CENTER.lng = pos.coords.longitude;
      document.getElementById('locText').textContent = `${pos.coords.latitude.toFixed(3)}, ${pos.coords.longitude.toFixed(3)}`;
      if (miniMap) miniMap.setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lng], 14);
      loadMerchants();
    },
    () => { /* use default */ },
    { timeout: 5000 }
  );
}

// ========== PHASE 2C: FOLLOW & SCHEDULE ==========

async function loadFollowStatus(merchantId) {
  const token = localStorage.getItem('token');
  if (!token) {
    const btn = document.getElementById(`follow-btn-${merchantId}`);
    if (btn) btn.style.display = 'none';
    return;
  }
  try {
    // Get follower count
    const data = await apiCall(`${API_BASE}/merchants/${merchantId}/followers`);
    const cnt = data.count || 0;
    const cntEl = document.getElementById(`follow-count-${merchantId}`);
    if (cntEl) cntEl.textContent = cnt;

    // Check if following
    const isFol = await apiCall(`${API_BASE}/merchants/${merchantId}/is-following`);
    const btn = document.getElementById(`follow-btn-${merchantId}`);
    if (btn) {
      btn.textContent = isFol.following ? 'âœ“ å·²å…³æ³¨' : '+ å…³æ³¨';
      btn.classList.toggle('followed', !!isFol.following);
    }
  } catch (e) { /* silent */ }
}

async function toggleFollow(merchantId) {
  const token = localStorage.getItem('token');
  if (!token) { showToast('è¯·å…ˆç™»å½•', 'error'); return; }
  const btn = document.getElementById(`follow-btn-${merchantId}`);
  const isFollowed = btn && btn.classList.contains('followed');
  // Optimistic update immediately
  if (btn) {
    btn.disabled = true;
    btn.textContent = isFollowed ? 'å–æ¶ˆä¸­â€¦' : 'å…³æ³¨ä¸­â€¦';
  }
  try {
    const method = isFollowed ? 'DELETE' : 'POST';
    await apiCall(`${API_BASE}/merchants/${merchantId}/follow`, { method });
    showToast(isFollowed ? 'å·²å–æ¶ˆå…³æ³¨' : 'å…³æ³¨æˆåŠŸ âœ“', 'success');
    await loadFollowStatus(merchantId);
    if (currentBottomTab === 'profile') loadFollowedList();
  } catch (e) {
    if (btn) {
      btn.textContent = isFollowed ? 'âœ“ å·²å…³æ³¨' : '+ å…³æ³¨';
      btn.classList.toggle('followed', isFollowed);
    }
    showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  } finally {
    if (btn) btn.disabled = false;
  }
}

function switchExpandTab(merchantId, tab) {
  const menuDiv = document.getElementById(`expand-menu-${merchantId}`);
  const schedDiv = document.getElementById(`expand-sched-${merchantId}`);
  const menuTab = document.getElementById(`tab-menu-${merchantId}`);
  const schedTab = document.getElementById(`tab-sched-${merchantId}`);
  if (!menuDiv || !schedDiv) return;
  if (tab === 'menu') {
    menuDiv.style.display = '';
    schedDiv.style.display = 'none';
    menuTab && menuTab.classList.add('on');
    schedTab && schedTab.classList.remove('on');
  } else {
    menuDiv.style.display = 'none';
    schedDiv.style.display = '';
    menuTab && menuTab.classList.remove('on');
    schedTab && schedTab.classList.add('on');
    loadSchedules(merchantId);
  }
}

async function loadSchedules(merchantId) {
  const schedDiv = document.getElementById(`expand-sched-${merchantId}`);
  if (!schedDiv || schedDiv.dataset.loaded) return;
  schedDiv.dataset.loaded = '1';
  const DAY_NAMES = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
  try {
    const data = await apiCall(`${API_BASE}/merchants/${merchantId}/schedules`);
    const schedules = Array.isArray(data) ? data : (data.schedules || []);
    const active = schedules.filter(s => s.enabled !== false);
    if (!active.length) {
      schedDiv.innerHTML = '<div class="schedule-empty">ğŸ“… æš‚æ— å‡ºæ‘Šè®¡åˆ’</div>';
      return;
    }
    schedDiv.innerHTML = active.map(s => {
      const dayName = DAY_NAMES[s.dayOfWeek] || '';
      const timeStr = s.openTime && s.closeTime ? `${s.openTime} â€“ ${s.closeTime}` : '';
      return `
        <div class="schedule-card">
          <div class="schedule-date">ğŸ“… ${dayName}</div>
          ${timeStr ? `<div class="schedule-time">â° ${timeStr}</div>` : ''}
          ${s.address ? `<div class="schedule-addr">ğŸ“ ${s.address}</div>` : ''}
        </div>
      `;
    }).join('');
  } catch (e) {
    const schedDiv2 = document.getElementById(`expand-sched-${merchantId}`);
    if (schedDiv2) schedDiv2.innerHTML = '<div class="schedule-empty">åŠ è½½å¤±è´¥</div>';
  }
}

async function loadFollowedList() {
  const token = localStorage.getItem('token');
  const container = document.getElementById('followedList');
  if (!container) return;
  if (!token) { container.innerHTML = '<div class="followed-empty">ç™»å½•åæŸ¥çœ‹å…³æ³¨</div>'; return; }
  container.innerHTML = '<div class="followed-empty">åŠ è½½ä¸­â€¦</div>';
  try {
    const data = await apiCall(`${API_BASE}/user/following`);
    const merchants = Array.isArray(data) ? data : (data.merchants || []);
    if (!merchants.length) {
      container.innerHTML = '<div class="followed-empty">è¿˜æ²¡æœ‰å…³æ³¨çš„å•†å®¶</div>';
      return;
    }
    container.innerHTML = merchants.map(m => {
      const name = currentLang === 'en' && m.name_en ? m.name_en : m.name;
      const emoji = m.emoji || 'ğŸ½ï¸';
      const isOpen = m.isOpen !== false;
      return `
        <div class="followed-card" onclick="switchBottomTab('home');setTimeout(()=>toggleMerchantMenu('${m._id}'),300)">
          <div class="followed-emoji">${emoji}</div>
          <div class="followed-info">
            <div class="followed-name">${name}</div>
            <div class="followed-meta">${m.type || ''}</div>
          </div>
          <div class="followed-status ${isOpen ? 'open' : 'closed'}">${isOpen ? 'â— è¥ä¸šä¸­' : 'â— ä¼‘æ¯'}</div>
        </div>
      `;
    }).join('');
  } catch (e) {
    container.innerHTML = '<div class="followed-empty">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
  }
}

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', () => {
  // Restore language
  document.getElementById('langSelect').value = currentLang;
  applyI18n();
  checkAuthAndInit();
  tryGeolocate();
});
</script>
</body>
</html>
