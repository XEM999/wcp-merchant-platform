<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NearBite — 发现美食</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🍜</text></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ============================================================
   NearBite Consumer UI — Design System
   Based on: Edward_NearBite_UI设计方案.html
   Colors: Orange(#ff6b35) + White + Light Gray BG
   AI Accent: Purple(#8b5cf6)
   Style: Rounded cards, minimalist, mobile-first
   ============================================================ */

:root {
    --pri: #ff6b35;
    --pri-l: #ff8f66;
    --pri-d: #e55a2b;
    --pri-bg: #fff7ed;
    --ai: #8b5cf6;
    --ai-l: #a78bfa;
    --ai-bg: #f5f3ff;
    --bg: #f7f7f8;
    --card: #ffffff;
    --g1: #f3f4f6;
    --g2: #e5e7eb;
    --g3: #d1d5db;
    --g4: #9ca3af;
    --g5: #6b7280;
    --g6: #4b5563;
    --g7: #374151;
    --g8: #1f2937;
    --green: #10b981;
    --red: #ef4444;
    --border: #e5e7eb;
    --sh: 0 2px 12px rgba(0,0,0,.06);
    --sh-lg: 0 4px 20px rgba(0,0,0,.12);
    --r: 12px;
    --r2: 16px;
    --r3: 24px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', sans-serif;
    background: var(--bg);
    color: var(--g8);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
}

/* ========== LOGIN PAGE ========== */
.login-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, #fff 0%, #fff7f4 100%);
    padding: 20px;
}
.login-overlay.show { display: flex; }

.login-page {
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.login-icon {
    width: 80px;
    height: 80px;
    background: var(--pri);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.4rem;
    margin: 0 auto 16px;
    box-shadow: 0 8px 24px rgba(255,107,53,.3);
}

.login-title {
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--g8);
    margin-bottom: 4px;
}

.login-subtitle {
    font-size: .9rem;
    color: var(--g4);
    margin-bottom: 32px;
}

.login-card {
    background: var(--card);
    border-radius: var(--r2);
    padding: 24px;
    box-shadow: var(--sh-lg);
    text-align: left;
}

.f-group { margin-bottom: 14px; }

.f-label {
    display: block;
    font-size: .8rem;
    font-weight: 600;
    color: var(--g6);
    margin-bottom: 6px;
}

.f-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.f-prefix {
    width: 72px;
    height: 48px;
    border: 2px solid var(--g2);
    border-radius: var(--r);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: .85rem;
    font-weight: 600;
    color: var(--g6);
    background: #fafafa;
    flex-shrink: 0;
}

.f-input {
    width: 100%;
    height: 48px;
    border: 2px solid var(--g2);
    border-radius: var(--r);
    padding: 0 14px;
    font-size: .95rem;
    background: #fff;
    color: var(--g8);
    outline: none;
    transition: border .2s;
    font-family: inherit;
}
.f-input:focus { border-color: var(--pri); }
.f-input.flex { flex: 1; }

.btn {
    width: 100%;
    height: 50px;
    border: none;
    border-radius: var(--r);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
    font-family: inherit;
}

.btn-pri {
    background: var(--pri);
    color: #fff;
    box-shadow: 0 4px 16px rgba(255,107,53,.3);
}
.btn-pri:hover { background: var(--pri-d); transform: translateY(-1px); }
.btn-pri:active { transform: scale(.98); }

.login-or {
    display: flex;
    align-items: center;
    margin: 18px 0;
    color: var(--g4);
    font-size: .8rem;
}
.login-or::before, .login-or::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--g2);
}
.login-or span { padding: 0 12px; }

.social-row {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 16px;
}

.social-btn {
    width: 52px;
    height: 52px;
    border: 2px solid var(--g2);
    border-radius: var(--r);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    background: #fff;
    cursor: pointer;
    transition: all .2s;
}
.social-btn:hover { border-color: var(--pri); background: #fff8f5; }

.login-link {
    text-align: center;
    font-size: .85rem;
    color: var(--g5);
}
.login-link a {
    color: var(--pri);
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
}

.login-err {
    color: var(--red);
    font-size: .8rem;
    margin-bottom: 10px;
    min-height: 1.2em;
}

/* ========== APP CONTAINER ========== */
.app {
    display: none;
    flex-direction: column;
    min-height: 100vh;
    padding-bottom: 70px;
}
.app.show { display: flex; }

/* ========== HEADER ========== */
.app-hd {
    position: sticky;
    top: 0;
    z-index: 500;
    background: rgba(255,255,255,.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
}

.hd-left { display: flex; align-items: center; gap: 8px; }
.hd-logo { font-size: 28px; }
.hd-brand { font-size: 20px; font-weight: 800; color: var(--pri); letter-spacing: -.5px; }

.hd-right { display: flex; align-items: center; gap: 8px; }

.lang-sel {
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 20px;
    background: var(--card);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    color: var(--g5);
    outline: none;
    appearance: none;
    -webkit-appearance: none;
    padding-right: 24px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 10px;
}
.lang-sel:hover { border-color: var(--pri); color: var(--pri-d); }
.lang-sel:focus { border-color: var(--pri); }

/* ========== HOME PAGE ========== */
.pg-home {
    flex: 1;
    display: none;
    flex-direction: column;
    background: var(--bg);
}
.pg-home.show { display: flex; }

.home-hd {
    background: #fff;
    padding: 14px 16px 10px;
    flex-shrink: 0;
}

.loc-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
    font-size: .85rem;
    font-weight: 600;
    color: var(--g8);
    cursor: pointer;
}
.loc-row .arr { color: var(--g4); font-size: .7rem; }

/* Search Bar */
.search-bar { position: relative; }
.search-bar input {
    width: 100%;
    height: 42px;
    background: var(--g1);
    border: none;
    border-radius: var(--r);
    padding: 0 70px 0 38px;
    font-size: .85rem;
    color: var(--g8);
    outline: none;
    font-family: inherit;
    transition: all .2s;
}
.search-bar input:focus {
    background: #fff;
    box-shadow: 0 0 0 2px var(--pri);
}
.search-bar .ico {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
    color: var(--g4);
}
.search-ai-badge {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, var(--ai), var(--ai-l));
    color: #fff;
    font-size: .55rem;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: 600;
}

/* Tabs Row */
.tabs-row {
    display: flex;
    background: #fff;
    border-bottom: 1px solid var(--g1);
    flex-shrink: 0;
}
.tab {
    flex: 1;
    text-align: center;
    padding: 10px 0;
    font-size: .85rem;
    font-weight: 500;
    color: var(--g4);
    cursor: pointer;
    position: relative;
    transition: color .15s;
}
.tab.on { color: var(--pri); font-weight: 600; }
.tab.on::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 24px;
    height: 3px;
    background: var(--pri);
    border-radius: 2px;
}

/* Category Nav */
.home-cats {
    background: #fff;
    padding: 12px 0;
    border-bottom: 1px solid var(--g1);
    flex-shrink: 0;
}
.cats-scroll {
    display: flex;
    gap: 6px;
    padding: 0 14px;
    overflow-x: auto;
}
.cats-scroll::-webkit-scrollbar { display: none; }
.cat {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    padding: 6px 10px;
    cursor: pointer;
}
.cat-ico {
    width: 46px;
    height: 46px;
    background: var(--g1);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    transition: all .2s;
}
.cat.on .cat-ico { background: var(--pri); color: #fff; }
.cat span { font-size: .7rem; color: var(--g5); white-space: nowrap; }
.cat.on span { color: var(--pri); font-weight: 600; }

/* Filter Chips */
.filter-row {
    display: flex;
    gap: 8px;
    padding: 10px 16px;
    background: #fff;
    flex-shrink: 0;
    overflow-x: auto;
}
.filter-row::-webkit-scrollbar { display: none; }
.chip {
    flex-shrink: 0;
    height: 32px;
    padding: 0 14px;
    border-radius: 16px;
    border: 1px solid var(--g2);
    background: #fff;
    font-size: .8rem;
    color: var(--g6);
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    transition: all .15s;
    font-family: inherit;
    white-space: nowrap;
}
.chip.on { background: var(--pri); color: #fff; border-color: var(--pri); }
.chip:hover { border-color: var(--pri); }

/* Home Body (scrollable) */
.home-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px 80px;
}

/* AI Recommend Section */
.ai-recommend { padding: 12px 0; margin-bottom: 8px; }
.ai-recommend-hd {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding: 0 2px;
}
.ai-recommend-hd .icon {
    background: linear-gradient(135deg, var(--ai), var(--ai-l));
    color: #fff;
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: .9rem;
}
.ai-recommend-hd .title { font-size: .95rem; font-weight: 600; color: var(--g8); }
.ai-recommend-hd .subtitle { font-size: .7rem; color: var(--g4); margin-left: auto; }
.ai-cards { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 4px; }
.ai-cards::-webkit-scrollbar { display: none; }
.ai-card {
    flex-shrink: 0;
    width: 150px;
    background: #fff;
    border-radius: var(--r);
    padding: 10px;
    box-shadow: 0 1px 6px rgba(0,0,0,.04);
    cursor: pointer;
    transition: transform .15s;
}
.ai-card:hover { transform: translateY(-2px); }
.ai-card-img {
    width: 100%;
    height: 72px;
    background: linear-gradient(135deg, #ffe4d6, #fff0e8);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin-bottom: 8px;
}
.ai-card-name {
    font-size: .8rem;
    font-weight: 600;
    color: var(--g8);
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.ai-card-desc { font-size: .65rem; color: var(--g4); margin-bottom: 6px; }
.ai-card-tag {
    font-size: .55rem;
    padding: 2px 5px;
    background: linear-gradient(135deg, var(--ai), var(--ai-l));
    color: #fff;
    border-radius: 4px;
    display: inline-block;
}

/* Mini Map & Full Map */
.map-preview {
    height: 140px;
    border-radius: var(--r2);
    margin-bottom: 12px;
    position: relative;
    overflow: hidden;
}
#mini-map { height: 100%; width: 100%; border-radius: var(--r2); }
.full-map-wrap {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 70px;
    z-index: 400;
}
.full-map-wrap.show { display: block; }
#full-map { width: 100%; height: 100%; }

/* Promo Banner */
.promo {
    height: 110px;
    background: linear-gradient(135deg, var(--pri), var(--pri-l));
    border-radius: var(--r2);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    padding: 0 20px;
    color: #fff;
    position: relative;
    overflow: hidden;
}
.promo h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; }
.promo p { font-size: .8rem; opacity: .85; }
.promo .deco {
    position: absolute;
    right: -10px;
    top: -10px;
    width: 100px;
    height: 100px;
    background: rgba(255,255,255,.1);
    border-radius: 50%;
}
.promo .deco2 {
    position: absolute;
    right: 30px;
    bottom: -20px;
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,.08);
    border-radius: 50%;
}

/* ========== VENDOR CARD ========== */
.v-card {
    background: #fff;
    border-radius: var(--r2);
    margin-bottom: 12px;
    overflow: hidden;
    box-shadow: 0 1px 6px rgba(0,0,0,.04);
    display: flex;
    gap: 12px;
    padding: 12px;
    cursor: pointer;
    transition: transform .15s;
}
.v-card:active { transform: scale(.99); }
.v-img {
    width: 88px;
    height: 88px;
    border-radius: var(--r);
    background: linear-gradient(135deg, #ffe4d6, #fff0e8);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
}
.v-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.v-name {
    font-size: .95rem;
    font-weight: 600;
    color: var(--g8);
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.v-rate {
    font-size: .78rem;
    color: var(--g5);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.v-rate .star { color: #ffb800; }
.v-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
.v-tag {
    font-size: .65rem;
    padding: 2px 7px;
    background: #fff5f2;
    color: var(--pri);
    border-radius: 4px;
}
.v-tag-ai {
    font-size: .65rem;
    padding: 2px 7px;
    background: linear-gradient(135deg, var(--ai), var(--ai-l));
    color: #fff;
    border-radius: 4px;
}
.v-meta {
    display: flex;
    justify-content: space-between;
    font-size: .72rem;
    color: var(--g4);
}
.v-meta .open { color: var(--green); }

/* Menu Expand inside card */
.menu-expand {
    display: none;
    width: 100%;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
}
.menu-expand.show { display: block; animation: slideDown .25s ease; }
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: none; }
}
.menu-category {
    font-size: 12px;
    font-weight: 600;
    color: var(--g5);
    margin: 12px 0 8px;
    text-transform: uppercase;
    letter-spacing: .5px;
}
.menu-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f3f4f6;
}
.menu-item:last-child { border-bottom: none; }
.menu-item-info { flex: 1; }
.menu-item-name { font-size: 14px; font-weight: 500; }
.menu-item-price { color: var(--pri-d); font-size: 14px; font-weight: 700; margin-top: 2px; }
.menu-item-add {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--pri);
    color: #fff;
    border: none;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform .15s;
}
.menu-item-add:active { transform: scale(.9); }

/* Empty State */
.empty-state { text-align: center; padding: 40px 20px; color: var(--g4); }
.empty-state .em-icon { font-size: 48px; margin-bottom: 12px; }

/* ========== BOTTOM NAV ========== */
.bnav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    display: flex;
    border-top: 1px solid var(--g1);
    padding: 8px 0 28px;
    z-index: 500;
}
.bnav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    font-size: .62rem;
    color: var(--g4);
    cursor: pointer;
    padding: 4px 0;
    transition: color .15s;
}
.bnav-item.on { color: var(--pri); }
.bnav-item.ai-on { color: var(--ai); }
.bnav-item .ico { font-size: 1.3rem; }

/* ========== PLACEHOLDER PAGES ========== */
.pg-placeholder {
    display: none;
    flex: 1;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
}
.pg-placeholder.show { display: flex; }
.pg-placeholder .ph-ico { font-size: 3.5rem; margin-bottom: 16px; }
.pg-placeholder h3 { font-size: 1.1rem; color: var(--g8); margin-bottom: 8px; }
.pg-placeholder p { font-size: .85rem; color: var(--g4); line-height: 1.6; }

/* ========== CART FLOAT ========== */
.cart-float {
    position: fixed;
    bottom: 90px;
    right: 16px;
    z-index: 450;
    background: var(--pri);
    color: #fff;
    border: none;
    border-radius: 28px;
    padding: 12px 20px;
    font-size: .9rem;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(255,107,53,.4);
    display: none;
    align-items: center;
    gap: 8px;
    font-family: inherit;
    transition: transform .2s;
}
.cart-float.show { display: flex; }
.cart-float:active { transform: scale(.95); }
.cart-badge {
    background: var(--red);
    color: #fff;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: .7rem;
    font-weight: 700;
}

/* ========== CART PANEL ========== */
.cart-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.4);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all .3s;
}
.cart-overlay.show { opacity: 1; visibility: visible; }
.cart-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--card);
    border-radius: var(--r3) var(--r3) 0 0;
    max-height: 80vh;
    transform: translateY(100%);
    transition: transform .3s ease;
    z-index: 1001;
    display: flex;
    flex-direction: column;
}
.cart-overlay.show .cart-panel { transform: translateY(0); }
.cart-handle {
    width: 40px;
    height: 4px;
    background: var(--g2);
    border-radius: 2px;
    margin: 12px auto;
}
.cart-header {
    padding: 0 20px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
}
.cart-title { font-size: 18px; font-weight: 700; }
.cart-close {
    background: var(--g1);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.cart-items { flex: 1; overflow-y: auto; padding: 12px 20px; }
.cart-empty { text-align: center; padding: 40px; color: var(--g4); }
.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}
.cart-item-info { flex: 1; }
.cart-item-name { font-size: 14px; font-weight: 500; }
.cart-item-price { color: var(--pri-d); font-size: 13px; }
.cart-item-qty { display: flex; align-items: center; gap: 12px; }
.qty-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--g1);
    border: none;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.cart-item-total { font-weight: 700; min-width: 60px; text-align: right; }
.cart-footer {
    padding: 16px 20px 24px;
    border-top: 1px solid var(--border);
    background: var(--card);
}
.cart-total {
    display: flex;
    justify-content: space-between;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 12px;
}
.cart-total-amount { color: var(--pri-d); }
.cart-note {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    margin-bottom: 12px;
    resize: none;
}
.cart-note:focus { border-color: var(--pri); outline: none; }
.checkout-btn {
    width: 100%;
    padding: 16px;
    background: var(--pri);
    color: #fff;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    font-family: inherit;
    box-shadow: 0 4px 16px rgba(255,107,53,.3);
    transition: all .2s;
}
.checkout-btn:active { transform: scale(.98); }

/* ========== ORDER PANEL ========== */
.order-panel {
    position: fixed;
    top: 60px;
    left: 16px;
    right: 16px;
    background: var(--card);
    border-radius: var(--r2);
    box-shadow: var(--sh-lg);
    padding: 20px;
    z-index: 800;
    display: none;
}
.order-panel.show { display: block; animation: slideDown .3s ease; }
.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}
.order-id { font-size: 12px; color: var(--g5); }
.order-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--g5);
}
.order-status-title {
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 20px;
}
.status-progress {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-bottom: 20px;
}
.status-progress::before {
    content: '';
    position: absolute;
    top: 14px;
    left: 20px;
    right: 20px;
    height: 4px;
    background: var(--g2);
    border-radius: 2px;
}
.status-progress-fill {
    position: absolute;
    top: 14px;
    left: 20px;
    height: 4px;
    background: var(--green);
    border-radius: 2px;
    transition: width .5s ease;
}
.status-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 1;
}
.status-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--g1);
    border: 3px solid var(--g2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    margin-bottom: 6px;
    transition: all .3s;
}
.status-step.done .status-icon {
    background: var(--green);
    border-color: var(--green);
    color: #fff;
}
.status-step.active .status-icon {
    background: var(--pri);
    border-color: var(--pri);
    color: #fff;
    animation: pulse 1s infinite;
}
.status-label { font-size: 10px; color: var(--g4); text-align: center; }
.status-step.done .status-label,
.status-step.active .status-label { color: var(--g8); font-weight: 600; }
@keyframes pulse { 50% { opacity: .4; } }
.order-action { text-align: center; margin-top: 16px; }
.order-action button {
    padding: 10px 20px;
    background: var(--g1);
    border: none;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    font-family: inherit;
}

/* ========== TOAST ========== */
.toast-container {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: none;
}
.toast {
    background: var(--card);
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
    box-shadow: var(--sh-lg);
    animation: toastIn .3s ease;
}
.toast.success { border-left: 4px solid var(--green); }
.toast.error { border-left: 4px solid var(--red); }
.toast.info { border-left: 4px solid #3b82f6; }
@keyframes toastIn {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: none; }
}

/* ========== LOADING ========== */
.loading-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}
.loading-overlay.active { display: flex; }
.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--g2);
    border-top-color: var(--pri);
    border-radius: 50%;
    animation: spin .6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-msg { margin-top: 12px; font-size: 13px; color: var(--g5); }

/* ========== LEAFLET OVERRIDES ========== */
.leaflet-popup-content-wrapper { border-radius: 12px !important; }
.leaflet-popup-content { margin: 12px 16px !important; font-family: inherit !important; }
.popup-rich .pr-name { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
.popup-rich .pr-type { font-size: 12px; color: var(--g5); margin-bottom: 4px; }
.popup-rich .pr-stars { color: #f59e0b; font-size: 12px; }
.popup-rich .pr-dist { font-size: 12px; color: var(--pri); font-weight: 600; }
.popup-rich .pr-action {
    margin-top: 8px;
    padding: 6px 12px;
    background: var(--pri);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    width: 100%;
}
/* ========== PHASE 2C: FOLLOW + SCHEDULE + PROFILE ========== */

/* Merchant Expand Header - Meituan Style */
.menu-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--g1);
  margin-bottom: 8px;
}
.menu-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}
.menu-header-emoji {
  font-size: 2rem;
}
.menu-header-name {
  font-size: 16px;
  font-weight: 700;
  color: var(--g8);
}
.menu-header-status {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
}
.menu-header-status.open {
  background: rgba(16,185,129,.12);
  color: var(--green);
}
.menu-header-status.closed {
  background: var(--g1);
  color: var(--g4);
}
.menu-header-right {
  display: flex;
  align-items: center;
}
/* Follow Button - Meituan Style */
.btn-follow {
  padding: 6px 16px;
  border-radius: 20px;
  border: 2px solid var(--pri);
  background: #fff;
  color: var(--pri);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
  font-family: inherit;
  display: flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
}
.btn-follow:hover {
  background: var(--pri-bg);
}
.btn-follow:active {
  transform: scale(.96);
}
.btn-follow.followed {
  background: var(--pri);
  border-color: var(--pri);
  color: #fff;
}
.btn-follow.followed:hover {
  background: var(--pri-d);
}
.btn-follow:disabled {
  opacity: .5;
  cursor: not-allowed;
  transform: none;
  background: var(--g1);
  border-color: var(--g2);
  color: var(--g4);
}

/* Merchant Meta Row */
.menu-meta-row {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 8px 0 12px;
  font-size: 13px;
  color: var(--g5);
  border-bottom: 1px solid var(--g1);
  margin-bottom: 12px;
}
.menu-meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
}
.menu-meta-item .star {
  color: #ffb800;
}
.menu-meta-item .dist {
  color: var(--pri);
}
.menu-meta-item .fol {
  color: var(--g6);
}
.menu-meta-item strong {
  font-weight: 700;
  color: var(--g8);
}

/* Expand Tabs */
.expand-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}
.expand-tab {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid var(--g2);
  background: #fff;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  color: var(--g6);
  transition: all .15s;
  font-family: inherit;
}
.expand-tab:hover {
  border-color: var(--pri);
  color: var(--pri);
}
.expand-tab.on {
  background: var(--pri);
  border-color: var(--pri);
  color: #fff;
  font-weight: 600;
}

/* Schedule Cards */
.schedule-card {
  background: linear-gradient(135deg, #fff7ed, #fff);
  border: 1px solid var(--pri-bg);
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 10px;
}
.schedule-date {
  font-size: 14px;
  font-weight: 600;
  color: var(--g8);
}
.schedule-time {
  font-size: 13px;
  color: var(--g5);
  margin-top: 3px;
}
.schedule-addr {
  font-size: 13px;
  color: var(--pri);
  margin-top: 4px;
}
.schedule-note {
  font-size: 12px;
  color: var(--g4);
  margin-top: 4px;
  font-style: italic;
}
.schedule-empty {
  text-align: center;
  padding: 24px;
  color: var(--g4);
  font-size: 14px;
}

/* ========== PROFILE PAGE ========== */
#pgProfile {
  display: none;
  padding: 0 16px 100px;
  text-align: left;
  flex: 1;
  overflow-y: auto;
  background: var(--bg);
}
#pgProfile.show {
  display: block;
}

/* Profile Hero - User Info */
.profile-hero {
  text-align: center;
  padding: 28px 0 24px;
  background: linear-gradient(180deg, var(--pri-bg) 0%, transparent 100%);
  margin: 0 -16px;
  padding-left: 16px;
  padding-right: 16px;
  border-radius: 0 0 28px 28px;
}
.profile-hero .ph-ico {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, var(--pri) 0%, var(--pri-l) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.2rem;
  margin: 0 auto 14px;
  box-shadow: 0 6px 20px rgba(255,107,53,.35);
}
.profile-hero h3 {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--g8);
  margin-bottom: 4px;
}
.profile-hero .profile-phone {
  font-size: 14px;
  color: var(--g5);
  font-weight: 500;
}

/* Profile Section */
.profile-section {
  margin-top: 24px;
}
.profile-section-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--g8);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.profile-section-title .count {
  font-size: 12px;
  font-weight: 600;
  color: #fff;
  background: var(--pri);
  padding: 2px 10px;
  border-radius: 12px;
}

/* Followed Merchant Cards - Meituan Style */
.followed-card {
  display: flex;
  align-items: center;
  gap: 14px;
  background: var(--card);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
  transition: transform .15s, box-shadow .15s;
}
.followed-card:active {
  transform: scale(.98);
}
.followed-left {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  min-width: 0;
}
.followed-emoji {
  font-size: 1.8rem;
  width: 52px;
  height: 52px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--pri-bg), #fff);
  border-radius: 14px;
  flex-shrink: 0;
}
.followed-info {
  flex: 1;
  min-width: 0;
}
.followed-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--g8);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
}
.followed-meta {
  font-size: 12px;
  color: var(--g5);
  display: flex;
  align-items: center;
  gap: 10px;
}
.followed-meta .status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--green);
}
.followed-meta .status-dot.closed {
  background: var(--g3);
}
.followed-meta .status-text {
  color: var(--green);
  font-weight: 500;
}
.followed-meta .status-text.closed {
  color: var(--g4);
}
.followed-meta .distance {
  color: var(--pri);
  font-weight: 600;
}
.followed-view-btn {
  padding: 8px 14px;
  background: var(--pri);
  color: #fff;
  border: none;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(255,107,53,.25);
  transition: all .15s;
}
.followed-view-btn:hover {
  background: var(--pri-d);
  transform: translateY(-1px);
}
.followed-view-btn:active {
  transform: scale(.96);
}

/* Empty State - Meituan Style */
.followed-empty {
  text-align: center;
  padding: 40px 20px;
  background: var(--card);
  border-radius: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
}
.followed-empty .empty-icon {
  font-size: 3.5rem;
  margin-bottom: 16px;
  display: block;
}
.followed-empty .empty-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--g7);
  margin-bottom: 6px;
}
.followed-empty .empty-desc {
  font-size: 13px;
  color: var(--g4);
  margin-bottom: 16px;
}
.followed-empty .empty-action {
  padding: 10px 24px;
  background: var(--pri);
  color: #fff;
  border: none;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  box-shadow: 0 4px 12px rgba(255,107,53,.3);
  transition: all .15s;
}
.followed-empty .empty-action:hover {
  background: var(--pri-d);
  transform: translateY(-1px);
}

/* Logout Button */
.profile-logout-btn {
  width: 100%;
  padding: 16px;
  margin-top: 24px;
  background: #fff;
  border: 2px solid var(--red);
  color: var(--red);
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all .15s;
}
.profile-logout-btn:hover {
  background: #fef2f2;
}

/* ========== HOME: MY FOLLOWING BAR ========== */
.my-following-bar {
  display: none;
  padding: 12px 0;
  margin-bottom: 8px;
}
.my-following-bar.show {
  display: block;
}
.my-following-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--g7);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.my-following-scroll {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  padding-bottom: 4px;
}
.my-following-scroll::-webkit-scrollbar {
  display: none;
}
.my-following-chip {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--card);
  border-radius: 20px;
  box-shadow: var(--sh);
  cursor: pointer;
  transition: transform .15s;
}
.my-following-chip:active {
  transform: scale(.96);
}
.my-following-chip .chip-emoji {
  font-size: 1.2rem;
}
.my-following-chip .chip-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--g8);
  white-space: nowrap;
}
.my-following-chip .chip-status {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
}
.my-following-chip .chip-status.closed {
  background: var(--g3);
}

/* ========== PHASE 3A: FRIEND SYSTEM ========== */
.friend-add-row {
  display: flex;
  gap: 8px;
  margin-bottom: 14px;
}
.friend-search-input {
  flex: 1;
  height: 40px;
  border: 2px solid var(--g2);
  border-radius: var(--r);
  padding: 0 14px;
  font-size: 14px;
  outline: none;
  transition: border .2s;
  font-family: inherit;
}
.friend-search-input:focus {
  border-color: var(--pri);
}
.friend-search-btn {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: var(--r);
  background: var(--pri);
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  transition: transform .15s;
}
.friend-search-btn:active {
  transform: scale(.95);
}

.friend-search-results {
  margin-bottom: 14px;
}
.friend-search-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--card);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 8px;
  box-shadow: 0 1px 4px rgba(0,0,0,.04);
}
.friend-search-info {
  display: flex;
  align-items: center;
  gap: 10px;
}
.friend-search-emoji {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--ai-bg), #fff);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
}
.friend-search-phone {
  font-size: 14px;
  font-weight: 500;
  color: var(--g8);
}
.friend-search-actions {
  display: flex;
  gap: 8px;
}
.btn-add-friend {
  padding: 6px 14px;
  border-radius: 16px;
  border: none;
  background: var(--pri);
  color: #fff;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
  font-family: inherit;
}
.btn-add-friend:hover {
  background: var(--pri-d);
}
.btn-add-friend:disabled {
  background: var(--g2);
  color: var(--g4);
  cursor: not-allowed;
}
.btn-add-friend.is-friend {
  background: var(--green);
}

/* 好友请求卡片 */
.friend-request-card {
  background: linear-gradient(135deg, #fff7ed, #fff);
  border: 1px solid var(--pri-bg);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 10px;
}
.friend-request-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.friend-request-info {
  display: flex;
  align-items: center;
  gap: 10px;
}
.friend-request-emoji {
  width: 44px;
  height: 44px;
  background: var(--card);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
}
.friend-request-phone {
  font-size: 14px;
  font-weight: 600;
  color: var(--g8);
}
.friend-request-actions {
  display: flex;
  gap: 8px;
}
.btn-accept-friend {
  padding: 8px 18px;
  border-radius: 16px;
  border: none;
  background: var(--pri);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
}
.btn-reject-friend {
  padding: 8px 18px;
  border-radius: 16px;
  border: 2px solid var(--g2);
  background: #fff;
  color: var(--g6);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
}

/* 好友卡片 */
.friend-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--card);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
}
.friend-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}
.friend-emoji {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, var(--ai-bg), #fff);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}
.friend-phone {
  font-size: 15px;
  font-weight: 600;
  color: var(--g8);
}
.friend-since {
  font-size: 12px;
  color: var(--g4);
  margin-top: 2px;
}
.btn-delete-friend {
  padding: 8px 14px;
  border-radius: 16px;
  border: 2px solid var(--red);
  background: #fff;
  color: var(--red);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all .15s;
}
.btn-delete-friend:hover {
  background: #fef2f2;
}

.friend-empty {
  text-align: center;
  padding: 40px 20px;
  background: var(--card);
  border-radius: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
}
.friend-empty .empty-icon {
  font-size: 3.5rem;
  margin-bottom: 16px;
  display: block;
}
.friend-empty .empty-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--g7);
  margin-bottom: 6px;
}
.friend-empty .empty-desc {
  font-size: 13px;
  color: var(--g4);
}
</style>
</head>
<body>

<!-- ==================== LOGIN OVERLAY ==================== -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-page">
    <div class="login-icon">🍔</div>
    <h1 class="login-title">NearBite</h1>
    <p class="login-subtitle" data-i18n="loginSlogan">发现身边的美味餐车</p>
    <div class="login-card">
      <!-- Login Form (default) -->
      <div id="loginForm">
        <div class="f-group">
          <label class="f-label" data-i18n="phone">手机号</label>
          <div class="f-row">
            <div class="f-prefix">+64</div>
            <input class="f-input flex" id="loginPhone" type="tel" data-i18n-placeholder="phonePh" placeholder="请输入手机号">
          </div>
        </div>
        <div class="f-group">
          <label class="f-label" data-i18n="password">密码</label>
          <input class="f-input" id="loginPass" type="password" data-i18n-placeholder="passwordPh" placeholder="请输入密码">
        </div>
        <div class="login-err" id="loginErr"></div>
        <button class="btn btn-pri" onclick="doFullLogin()" data-i18n="loginBtn">登 录</button>
        <div class="login-or"><span data-i18n="or">或</span></div>
        <div class="social-row">
          <div class="social-btn" title="Apple">🍎</div>
          <div class="social-btn" title="Google">G</div>
          <div class="social-btn" title="WeChat">💬</div>
        </div>
        <div class="login-link"><span data-i18n="noAccount">还没有账号？</span> <a onclick="toggleLoginRegister(true)" data-i18n="registerNow">立即注册</a></div>
      </div>
      <!-- Register Form (hidden by default) -->
      <div id="registerForm" style="display:none">
        <div class="f-group">
          <label class="f-label" data-i18n="username">用户名</label>
          <input class="f-input" id="regName" data-i18n-placeholder="usernamePh" placeholder="请输入用户名">
        </div>
        <div class="f-group">
          <label class="f-label" data-i18n="phone">手机号</label>
          <div class="f-row">
            <div class="f-prefix">+64</div>
            <input class="f-input flex" id="regPhone" type="tel" data-i18n-placeholder="phonePh" placeholder="请输入手机号">
          </div>
        </div>
        <div class="f-group">
          <label class="f-label" data-i18n="password">密码</label>
          <input class="f-input" id="regPass" type="password" data-i18n-placeholder="passwordPh" placeholder="请输入密码">
        </div>
        <div class="login-err" id="regErr"></div>
        <button class="btn btn-pri" onclick="doFullRegister()" data-i18n="registerBtn">注 册</button>
        <div style="height:16px"></div>
        <div class="login-link"><span data-i18n="hasAccount">已有账号？</span> <a onclick="toggleLoginRegister(false)" data-i18n="loginNow">立即登录</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MAIN APP ==================== -->
<div class="app" id="appContainer">
  <!-- Header -->
  <header class="app-hd">
    <div class="hd-left">
      <span class="hd-logo">🍔</span>
      <span class="hd-brand">NearBite</span>
    </div>
    <div class="hd-right">
      <select class="lang-sel" id="langSelect" onchange="switchLang(this.value)">
        <option value="zh">中文</option>
        <option value="en">English</option>
      </select>
    </div>
  </header>

  <!-- ===== HOME PAGE ===== -->
  <div class="pg-home show" id="pgHome">
    <div class="home-hd">
      <div class="loc-row" id="locRow">📍 <span id="locText">Christchurch CBD</span> <span class="arr">▼</span></div>
      <div class="search-bar">
        <span class="ico">🔍</span>
        <input id="searchInput" data-i18n-placeholder="searchPh" placeholder="我想吃辣的、$15以内..." oninput="onSearchInput(this.value)">
        <span class="search-ai-badge">✨ AI</span>
      </div>
    </div>
    <div class="tabs-row" id="contentTabs">
      <div class="tab on" data-tab="recommend" onclick="switchContentTab('recommend')" data-i18n="tabRecommend">推荐</div>
      <div class="tab" data-tab="nearby" onclick="switchContentTab('nearby')" data-i18n="tabNearby">附近</div>
      <div class="tab" data-tab="map" onclick="switchContentTab('map')" data-i18n="tabMap">地图</div>
      <div class="tab" data-tab="rating" onclick="switchContentTab('rating')" data-i18n="tabRating">评分</div>
    </div>
    <div class="home-cats" id="homeCats">
      <div class="cats-scroll" id="catsScroll">
        <div class="cat on" data-cat="all" onclick="selectCategory('all')"><div class="cat-ico">🔥</div><span data-i18n="catAll">全部</span></div>
        <div class="cat" data-cat="burger" onclick="selectCategory('burger')"><div class="cat-ico">🍔</div><span data-i18n="catBurger">汉堡</span></div>
        <div class="cat" data-cat="mexican" onclick="selectCategory('mexican')"><div class="cat-ico">🌮</div><span data-i18n="catMexican">墨西哥</span></div>
        <div class="cat" data-cat="noodle" onclick="selectCategory('noodle')"><div class="cat-ico">🍜</div><span data-i18n="catNoodle">面食</span></div>
        <div class="cat" data-cat="pizza" onclick="selectCategory('pizza')"><div class="cat-ico">🍕</div><span data-i18n="catPizza">披萨</span></div>
        <div class="cat" data-cat="coffee" onclick="selectCategory('coffee')"><div class="cat-ico">☕</div><span data-i18n="catCoffee">咖啡</span></div>
      </div>
    </div>
    <div class="filter-row" id="filterRow">
      <button class="chip on" data-filter="hot" onclick="selectFilter('hot')">🔥 <span data-i18n="filterHot">热门</span></button>
      <button class="chip" data-filter="near" onclick="selectFilter('near')">📍 <span data-i18n="filterNear">最近</span></button>
      <button class="chip" data-filter="deal" onclick="selectFilter('deal')">💰 <span data-i18n="filterDeal">优惠</span></button>
      <button class="chip" data-filter="top" onclick="selectFilter('top')">⭐ <span data-i18n="filterTop">好评</span></button>
    </div>
    <!-- Scrollable home body -->
    <div class="home-body" id="homeBody">
      <!-- My Following Bar -->
      <div class="my-following-bar" id="myFollowingBar">
        <div class="my-following-title">❤️ 我的关注</div>
        <div class="my-following-scroll" id="myFollowingScroll"></div>
      </div>
      <!-- AI Recommend -->
      <div class="ai-recommend" id="aiRecommendSection">
        <div class="ai-recommend-hd">
          <div class="icon">✨</div>
          <span class="title" data-i18n="aiRecommendTitle">AI 为你推荐</span>
          <span class="subtitle" data-i18n="aiRecommendSub">基于你的口味偏好</span>
        </div>
        <div class="ai-cards" id="aiCards"></div>
      </div>
      <!-- Mini Map Preview -->
      <div class="map-preview" id="mapPreview" onclick="switchContentTab('map')">
        <div id="mini-map"></div>
      </div>
      <!-- Promo Banner -->
      <div class="promo" id="promoBanner">
        <div><h3 data-i18n="promoTitle">新用户首单立减$5</h3><p data-i18n="promoCode">使用优惠码 NEARBITE5</p></div>
        <div class="deco"></div><div class="deco2"></div>
      </div>
      <!-- Merchant List -->
      <div id="merchantList"></div>
      <div id="emptyState" class="empty-state" style="display:none">
        <div class="em-icon">🔍</div>
        <p data-i18n="noMerchants">暂无商家，请稍后再试</p>
      </div>
    </div>
  </div>

  <!-- ===== FULL MAP VIEW ===== -->
  <div class="full-map-wrap" id="fullMapWrap">
    <div id="full-map"></div>
  </div>

  <!-- ===== DISCOVER PAGE (placeholder) ===== -->
  <div class="pg-placeholder" id="pgDiscover">
    <div class="ph-ico">🔍</div>
    <h3 data-i18n="discoverTitle">发现</h3>
    <p data-i18n="discoverDesc">探索更多美食分类和主题推荐<br>功能即将上线，敬请期待</p>
  </div>

  <!-- ===== AI ASSISTANT PAGE (placeholder) ===== -->
  <div class="pg-placeholder" id="pgAI">
    <div class="ph-ico">✨</div>
    <h3 data-i18n="aiTitle">AI 美食助手</h3>
    <p data-i18n="aiDesc">用自然语言发现美食、智能点餐<br>功能即将上线，敬请期待</p>
  </div>

  <!-- ===== ORDERS PAGE (placeholder) ===== -->
  <div class="pg-placeholder" id="pgOrders">
    <div class="ph-ico">📋</div>
    <h3 data-i18n="ordersTitle">我的订单</h3>
    <p data-i18n="ordersDesc">查看历史订单和当前订单状态<br>下单后订单会出现在这里</p>
  </div>

  <!-- ===== PROFILE PAGE ===== -->
  <div id="pgProfile">
    <div class="profile-hero">
      <div class="ph-ico">👤</div>
      <h3 id="profileUserName">个人中心</h3>
      <div class="profile-phone" id="profileUserPhone">--</div>
    </div>
    <div class="profile-section">
      <div class="profile-section-title">❤️ 我的关注 <span class="count" id="followCount">0</span></div>
      <div id="followedList">
        <div class="followed-empty">
          <span class="empty-icon">🔍</span>
          <div class="empty-title">还没有关注的商家</div>
          <div class="empty-desc">去首页发现更多美食餐车</div>
          <button class="empty-action" onclick="switchBottomTab('home')">发现商家</button>
        </div>
      </div>
    </div>
    <!-- Phase 3A: 好友系统 -->
    <div class="profile-section" id="friendsSection">
      <div class="profile-section-title">👥 我的好友 <span class="count" id="friendCount">0</span></div>
      <!-- 添加好友 -->
      <div class="friend-add-row">
        <input type="text" id="friendSearchInput" class="friend-search-input" placeholder="输入手机号搜索用户...">
        <button class="friend-search-btn" onclick="searchUsersForFriend()">🔍</button>
      </div>
      <!-- 搜索结果 -->
      <div id="friendSearchResults" class="friend-search-results"></div>
      <!-- 待处理好友请求 -->
      <div id="pendingFriendRequests"></div>
      <!-- 好友列表 -->
      <div id="friendsList">
        <div class="followed-empty">
          <span class="empty-icon">👥</span>
          <div class="empty-title">还没有好友</div>
          <div class="empty-desc">搜索手机号添加好友</div>
        </div>
      </div>
    </div>
    <button class="profile-logout-btn" onclick="doLogout()">退出登录</button>
  </div>

  <!-- ===== BOTTOM NAV ===== -->
  <nav class="bnav" id="bottomNav">
    <div class="bnav-item on" data-bnav="home" onclick="switchBottomTab('home')"><span class="ico">🏠</span><span data-i18n="navHome">首页</span></div>
    <div class="bnav-item" data-bnav="discover" onclick="switchBottomTab('discover')"><span class="ico">🔍</span><span data-i18n="navDiscover">发现</span></div>
    <div class="bnav-item" data-bnav="ai" onclick="switchBottomTab('ai')"><span class="ico">✨</span><span data-i18n="navAI">AI助手</span></div>
    <div class="bnav-item" data-bnav="orders" onclick="switchBottomTab('orders')"><span class="ico">📋</span><span data-i18n="navOrders">订单</span></div>
    <div class="bnav-item" data-bnav="profile" onclick="switchBottomTab('profile')"><span class="ico">👤</span><span data-i18n="navProfile">我的</span></div>
  </nav>
</div>

<!-- ==================== CART FLOAT ==================== -->
<button class="cart-float" id="cartFloat" onclick="openCart()">
  🛒 <span data-i18n="viewCart">查看购物车</span>
  <div class="cart-badge" id="cartBadge">0</div>
</button>

<!-- ==================== CART OVERLAY ==================== -->
<div class="cart-overlay" id="cartOverlay" onclick="closeCart()">
  <div class="cart-panel" onclick="event.stopPropagation()">
    <div class="cart-handle"></div>
    <div class="cart-header">
      <span class="cart-title" data-i18n="cart">购物车</span>
      <button class="cart-close" onclick="closeCart()">✕</button>
    </div>
    <div class="cart-items" id="cartItems">
      <div class="cart-empty" data-i18n="cartEmpty">购物车是空的</div>
    </div>
    <div class="cart-footer" id="cartFooter" style="display:none">
      <div class="cart-total">
        <span data-i18n="total">合计</span>
        <span class="cart-total-amount" id="cartTotal">$0</span>
      </div>
      <textarea class="cart-note" id="cartNote" rows="2" data-i18n-placeholder="cartNotePh" placeholder="备注（可选）"></textarea>
      <button class="checkout-btn" onclick="submitOrder()" data-i18n="placeOrder">提交订单</button>
    </div>
  </div>
</div>

<!-- ==================== ORDER STATUS PANEL ==================== -->
<div class="order-panel" id="orderPanel">
  <div class="order-header">
    <span class="order-id" id="orderIdText"></span>
    <button class="order-close" onclick="closeOrderPanel()">✕</button>
  </div>
  <div class="order-status-title" id="orderStatusTitle"></div>
  <div class="status-progress">
    <div class="status-progress-fill" id="statusProgressFill" style="width:0"></div>
    <div class="status-step" id="step-pending"><div class="status-icon">📝</div><div class="status-label" data-i18n="sPending">已下单</div></div>
    <div class="status-step" id="step-confirmed"><div class="status-icon">✅</div><div class="status-label" data-i18n="sConfirmed">已接单</div></div>
    <div class="status-step" id="step-preparing"><div class="status-icon">👨‍🍳</div><div class="status-label" data-i18n="sPreparing">制作中</div></div>
    <div class="status-step" id="step-ready"><div class="status-icon">🎉</div><div class="status-label" data-i18n="sReady">可取餐</div></div>
  </div>
  <div class="order-action"><button onclick="closeOrderPanel()" data-i18n="close">关闭</button></div>
</div>

<!-- ==================== TOAST ==================== -->
<div class="toast-container" id="toastContainer"></div>

<!-- ==================== LOADING ==================== -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-msg" id="loadingMsg" data-i18n="loading">加载中...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ============================================================
   NearBite Consumer Frontend — Complete JS
   ============================================================ */

// ========== CONFIG ==========
const BASE_URL = 'https://wcp-merchant-platform-production-dcdb.up.railway.app';
const API_BASE = '/api';
const DEFAULT_CENTER = { lat: -43.532, lng: 172.636 };
const DEFAULT_RADIUS = 5000;

// ========== STATE ==========
let currentLang = localStorage.getItem('nb_lang') || 'zh';
let allMerchants = [];
let currentCategory = 'all';
let currentFilter = 'hot';
let currentContentTab = 'recommend';
let currentBottomTab = 'home';
let miniMap = null;
let fullMap = null;
let miniMapMarkers = [];
let fullMapMarkers = [];
let cart = JSON.parse(localStorage.getItem('nb_cart') || '[]');
let currentMerchantId = localStorage.getItem('nb_cartMerchant') || null;
let expandedCardId = null;
let orderSSE = null;

// ========== i18n ==========
const LANG = {
  zh: {
    loginSlogan: '发现身边的美味餐车',
    phone: '手机号', phonePh: '请输入手机号',
    password: '密码', passwordPh: '请输入密码',
    loginBtn: '登 录', or: '或',
    noAccount: '还没有账号？', registerNow: '立即注册',
    hasAccount: '已有账号？', loginNow: '立即登录',
    username: '用户名', usernamePh: '请输入用户名',
    registerBtn: '注 册',
    searchPh: '我想吃辣的、$15以内...',
    tabRecommend: '推荐', tabNearby: '附近', tabMap: '地图', tabRating: '评分',
    catAll: '全部', catBurger: '汉堡', catMexican: '墨西哥', catNoodle: '面食', catPizza: '披萨', catCoffee: '咖啡',
    filterHot: '热门', filterNear: '最近', filterDeal: '优惠', filterTop: '好评',
    aiRecommendTitle: 'AI 为你推荐', aiRecommendSub: '基于你的口味偏好',
    promoTitle: '新用户首单立减$5', promoCode: '使用优惠码 NEARBITE5',
    noMerchants: '暂无商家，请稍后再试',
    viewCart: '查看购物车', cart: '购物车', cartEmpty: '购物车是空的',
    total: '合计', cartNotePh: '备注（可选）', placeOrder: '提交订单',
    close: '关闭', loading: '加载中...',
    sPending: '已下单', sConfirmed: '已接单', sPreparing: '制作中', sReady: '可取餐',
    monthSales: '月销', km: 'km', pickup: '到店自取', open: '营业中', closed: '休息中',
    menu: '菜单', addToCart: '+',
    navHome: '首页', navDiscover: '发现', navAI: 'AI助手', navOrders: '订单', navProfile: '我的',
    discoverTitle: '发现', discoverDesc: '探索更多美食分类和主题推荐\n功能即将上线，敬请期待',
    aiTitle: 'AI 美食助手', aiDesc: '用自然语言发现美食、智能点餐\n功能即将上线，敬请期待',
    ordersTitle: '我的订单', ordersDesc: '查看历史订单和当前订单状态\n下单后订单会出现在这里',
    profileTitle: '个人中心', profileDesc: '管理账户、收藏、设置\n功能即将上线，敬请期待',
    logoutBtn: '退出登录',
    loginFail: '登录失败，请检查手机号和密码',
    regFail: '注册失败，请重试',
    orderSuccess: '下单成功！',
    orderFail: '下单失败，请重试',
    cartDiffMerchant: '购物车中有其他商家的商品，是否清空？',
    aiTag: 'AI推荐', topReview: '好评最多', spicyPick: '辣味首选',
    viewMap: '查看地图'
  },
  en: {
    loginSlogan: 'Discover nearby food trucks',
    phone: 'Phone', phonePh: 'Enter phone number',
    password: 'Password', passwordPh: 'Enter password',
    loginBtn: 'Log In', or: 'or',
    noAccount: "Don't have an account?", registerNow: 'Sign Up',
    hasAccount: 'Already have an account?', loginNow: 'Log In',
    username: 'Username', usernamePh: 'Enter username',
    registerBtn: 'Sign Up',
    searchPh: 'I want spicy food under $15...',
    tabRecommend: 'For You', tabNearby: 'Nearby', tabMap: 'Map', tabRating: 'Top Rated',
    catAll: 'All', catBurger: 'Burger', catMexican: 'Mexican', catNoodle: 'Noodles', catPizza: 'Pizza', catCoffee: 'Coffee',
    filterHot: 'Popular', filterNear: 'Nearest', filterDeal: 'Deals', filterTop: 'Top Rated',
    aiRecommendTitle: 'AI Picks for You', aiRecommendSub: 'Based on your preferences',
    promoTitle: '$5 off your first order', promoCode: 'Use code NEARBITE5',
    noMerchants: 'No merchants found. Try again later.',
    viewCart: 'View Cart', cart: 'Cart', cartEmpty: 'Your cart is empty',
    total: 'Total', cartNotePh: 'Notes (optional)', placeOrder: 'Place Order',
    close: 'Close', loading: 'Loading...',
    sPending: 'Placed', sConfirmed: 'Confirmed', sPreparing: 'Preparing', sReady: 'Ready',
    monthSales: 'monthly', km: 'km', pickup: 'Self Pickup', open: 'Open', closed: 'Closed',
    menu: 'Menu', addToCart: '+',
    navHome: 'Home', navDiscover: 'Explore', navAI: 'AI', navOrders: 'Orders', navProfile: 'Me',
    discoverTitle: 'Explore', discoverDesc: 'Discover more food categories\nComing soon',
    aiTitle: 'AI Food Assistant', aiDesc: 'Discover food with natural language\nComing soon',
    ordersTitle: 'My Orders', ordersDesc: 'View order history and status\nOrders will appear here',
    profileTitle: 'Profile', profileDesc: 'Manage account, favorites, settings\nComing soon',
    logoutBtn: 'Log Out',
    loginFail: 'Login failed. Check phone & password.',
    regFail: 'Registration failed. Please try again.',
    orderSuccess: 'Order placed!',
    orderFail: 'Order failed. Try again.',
    cartDiffMerchant: 'Cart has items from another merchant. Clear cart?',
    aiTag: 'AI Pick', topReview: 'Most Liked', spicyPick: 'Spicy Pick',
    viewMap: 'View Map'
  }
};

function t(key) { return (LANG[currentLang] || LANG.zh)[key] || key; }

function applyI18n() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    const val = t(k);
    if (val) el.textContent = val;
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const k = el.getAttribute('data-i18n-placeholder');
    const val = t(k);
    if (val) el.placeholder = val;
  });
}

function switchLang(lang) {
  currentLang = lang;
  localStorage.setItem('nb_lang', lang);
  document.getElementById('langSelect').value = lang;
  applyI18n();
  renderMerchants();
  renderAICards();
}

// ========== API ==========
async function apiCall(path, options = {}) {
  const token = localStorage.getItem('token');
  const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const url = path.startsWith('http') ? path : `${BASE_URL}${path}`;
  const res = await fetch(url, { ...options, headers });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw { status: res.status, ...err };
  }
  return res.json();
}

// ========== TOAST ==========
function showToast(msg, type = 'info') {
  const c = document.getElementById('toastContainer');
  const d = document.createElement('div');
  d.className = `toast ${type}`;
  d.textContent = msg;
  c.appendChild(d);
  setTimeout(() => d.remove(), 3000);
}

// ========== LOADING ==========
function showLoading(show, msg) {
  const el = document.getElementById('loadingOverlay');
  if (show) { el.classList.add('active'); if (msg) document.getElementById('loadingMsg').textContent = msg; }
  else el.classList.remove('active');
}

// ========== AUTH ==========
function showFullLoginPage() {
  document.getElementById('loginOverlay').classList.add('show');
  document.getElementById('appContainer').classList.remove('show');
}

function hideLoginPage() {
  document.getElementById('loginOverlay').classList.remove('show');
  document.getElementById('appContainer').classList.add('show');
}

function toggleLoginRegister(showReg) {
  document.getElementById('loginForm').style.display = showReg ? 'none' : '';
  document.getElementById('registerForm').style.display = showReg ? '' : 'none';
  document.getElementById('loginErr').textContent = '';
  document.getElementById('regErr').textContent = '';
}

async function doFullLogin() {
  const phone = document.getElementById('loginPhone').value.trim();
  const pass = document.getElementById('loginPass').value;
  if (!phone || !pass) { document.getElementById('loginErr').textContent = t('loginFail'); return; }
  showLoading(true);
  try {
    const data = await apiCall(`${API_BASE}/auth/login`, {
      method: 'POST',
      body: JSON.stringify({ phone, password: pass })
    });
    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify(data.user || data));
    showLoading(false);
    routeByRole(data.user || data);
  } catch (e) {
    showLoading(false);
    document.getElementById('loginErr').textContent = t('loginFail');
  }
}

async function doFullRegister() {
  const name = document.getElementById('regName').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const pass = document.getElementById('regPass').value;
  if (!name || !phone || !pass) { document.getElementById('regErr').textContent = t('regFail'); return; }
  showLoading(true);
  try {
    const data = await apiCall(`${API_BASE}/auth/register`, {
      method: 'POST',
      body: JSON.stringify({ name, phone, password: pass, role: 'consumer' })
    });
    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify(data.user || data));
    showLoading(false);
    routeByRole(data.user || data);
  } catch (e) {
    showLoading(false);
    document.getElementById('regErr').textContent = t('regFail');
  }
}

function routeByRole(user) {
  if (!user) { showFullLoginPage(); return; }
  const role = user.role || 'consumer';
  if (role === 'merchant') { window.location.href = 'merchant.html'; return; }
  if (role === 'admin') { window.location.href = 'admin.html'; return; }
  hideLoginPage();
  initConsumerPage();
}

async function checkAuthAndInit() {
  const token = localStorage.getItem('token');
  // Check QR entry
  const params = new URLSearchParams(window.location.search);
  const qrMerchant = params.get('merchant');
  const qrTable = params.get('table');

  if (!token) {
    if (qrMerchant) {
      // Allow browsing without login for QR entry
      hideLoginPage();
      initConsumerPage(qrMerchant, qrTable);
    } else {
      showFullLoginPage();
    }
    return;
  }
  showLoading(true);
  try {
    const data = await apiCall(`${API_BASE}/auth/me`);
    const user = data.user || data;
    localStorage.setItem('user', JSON.stringify(user));
    showLoading(false);
    routeByRole(user);
  } catch (e) {
    showLoading(false);
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    if (qrMerchant) {
      hideLoginPage();
      initConsumerPage(qrMerchant, qrTable);
    } else {
      showFullLoginPage();
    }
  }
}

function doLogout() {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  localStorage.removeItem('nb_cart');
  localStorage.removeItem('nb_cartMerchant');
  cart = [];
  currentMerchantId = null;
  showFullLoginPage();
}

// ========== CONSUMER PAGE INIT ==========
async function initConsumerPage(qrMerchantId, qrTable) {
  applyI18n();
  updateCartUI();
  await loadMerchants();
  initMiniMap();
  loadMyFollowingBar();
  if (qrMerchantId) {
    // Auto-expand QR merchant
    setTimeout(() => {
      const card = document.querySelector(`.v-card[data-id="${qrMerchantId}"]`);
      if (card) { card.click(); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }, 500);
  }
}

// ========== LOAD MERCHANTS ==========
async function loadMerchants() {
  try {
    const data = await apiCall(`${API_BASE}/merchants/nearby?lat=${DEFAULT_CENTER.lat}&lng=${DEFAULT_CENTER.lng}&radius=${DEFAULT_RADIUS}`);
    allMerchants = (Array.isArray(data) ? data : (data.merchants || [])).map(m => ({ ...m, _id: m._id || m.id }));
  } catch (e) {
    console.warn('API failed, using mock data', e);
    allMerchants = getMockMerchants();
  }
  if (!allMerchants.length) allMerchants = getMockMerchants();
  renderMerchants();
  renderAICards();
}

function getMockMerchants() {
  return [
    { _id:'m1', name:'墨西哥 Taco 餐车', name_en:'Mexican Taco Truck', type:'mexican', emoji:'🌮', rating:4.8, monthlySales:520, distance:1.2, isOpen:true, location:{coordinates:[172.636,-43.530]}, menu:[{name:'经典牛肉Taco',name_en:'Classic Beef Taco',price:12,category:'招牌'},{name:'鸡肉卷饼',name_en:'Chicken Burrito',price:14,category:'招牌'},{name:'玉米片',name_en:'Nachos',price:8,category:'小食'}] },
    { _id:'m2', name:'Burger Brothers 餐车', name_en:'Burger Brothers Truck', type:'burger', emoji:'🍔', rating:4.6, monthlySales:380, distance:0.8, isOpen:true, location:{coordinates:[172.638,-43.533]}, menu:[{name:'经典安格斯牛堡',name_en:'Classic Angus Burger',price:16,category:'汉堡'},{name:'芝士培根堡',name_en:'Cheese Bacon Burger',price:18,category:'汉堡'},{name:'薯条',name_en:'Fries',price:5,category:'小食'}] },
    { _id:'m3', name:'重庆小面', name_en:'Chongqing Noodles', type:'noodle', emoji:'🍜', rating:4.7, monthlySales:290, distance:2.1, isOpen:true, location:{coordinates:[172.634,-43.531]}, menu:[{name:'重庆小面',name_en:'Chongqing Noodles',price:13,category:'面食'},{name:'担担面',name_en:'Dan Dan Noodles',price:14,category:'面食'},{name:'冰粉',name_en:'Ice Jelly',price:5,category:'饮品'}] },
    { _id:'m4', name:'Pizza Wheels', name_en:'Pizza Wheels', type:'pizza', emoji:'🍕', rating:4.5, monthlySales:210, distance:1.5, isOpen:false, location:{coordinates:[172.640,-43.534]}, menu:[{name:'玛格丽特披萨',name_en:'Margherita Pizza',price:15,category:'披萨'},{name:'夏威夷披萨',name_en:'Hawaiian Pizza',price:17,category:'披萨'}] },
    { _id:'m5', name:'Kiwi Coffee Cart', name_en:'Kiwi Coffee Cart', type:'coffee', emoji:'☕', rating:4.9, monthlySales:600, distance:0.3, isOpen:true, location:{coordinates:[172.637,-43.532]}, menu:[{name:'Flat White',name_en:'Flat White',price:5,category:'咖啡'},{name:'Long Black',name_en:'Long Black',price:4.5,category:'咖啡'},{name:'抹茶拿铁',name_en:'Matcha Latte',price:6,category:'咖啡'}] }
  ];
}

// ========== RENDER MERCHANTS ==========
function getFilteredMerchants() {
  let list = [...allMerchants];
  // Category filter
  if (currentCategory !== 'all') {
    list = list.filter(m => (m.type || '').toLowerCase() === currentCategory);
  }
  // Sort by filter
  if (currentFilter === 'near') list.sort((a, b) => (a.distance || 99) - (b.distance || 99));
  else if (currentFilter === 'top') list.sort((a, b) => (b.rating || 0) - (a.rating || 0));
  else if (currentFilter === 'hot') list.sort((a, b) => (b.monthlySales || 0) - (a.monthlySales || 0));
  return list;
}

function renderMerchants() {
  const list = getFilteredMerchants();
  const container = document.getElementById('merchantList');
  const empty = document.getElementById('emptyState');

  if (!list.length) {
    container.innerHTML = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';

  container.innerHTML = list.map(m => {
    const name = currentLang === 'en' && m.name_en ? m.name_en : m.name;
    const emoji = m.emoji || '🍽️';
    const rating = m.rating ? m.rating.toFixed(1) : '—';
    const dist = m.distance ? m.distance.toFixed(1) : '?';
    const sales = m.monthlySales || 0;
    const isOpen = m.isOpen !== false;
    const tags = [];
    if (sales > 300) tags.push(`<span class="v-tag">🔥 ${t('filterHot')}</span>`);
    if (m.rating >= 4.7) tags.push(`<span class="v-tag-ai">✨ ${t('aiTag')}</span>`);

    return `
      <div class="v-card" data-id="${m._id}" onclick="toggleMerchantMenu('${m._id}')">
        <div class="v-img">${emoji}</div>
        <div class="v-info">
          <div class="v-name">${name}</div>
          <div class="v-rate"><span class="star">⭐</span> ${rating} · ${t('monthSales')} ${sales}+</div>
          <div class="v-tags">${tags.join('')}</div>
          <div class="v-meta">
            <span>${dist} ${t('km')} · ${t('pickup')}</span>
            <span class="${isOpen ? 'open' : ''}">${isOpen ? '● ' + t('open') : '● ' + t('closed')}</span>
          </div>
          <div class="menu-expand" id="menu-${m._id}"></div>
        </div>
      </div>
    `;
  }).join('');
}

// ========== RENDER AI CARDS ==========
function renderAICards() {
  const top = [...allMerchants].sort((a, b) => (b.rating || 0) - (a.rating || 0)).slice(0, 4);
  const aiLabels = [t('aiTag'), t('topReview'), t('spicyPick'), '🆕 New'];
  const container = document.getElementById('aiCards');
  container.innerHTML = top.map((m, i) => {
    const name = currentLang === 'en' && m.name_en ? m.name_en : m.name;
    const emoji = m.emoji || '🍽️';
    return `
      <div class="ai-card" onclick="toggleMerchantMenu('${m._id}');scrollToCard('${m._id}')">
        <div class="ai-card-img">${emoji}</div>
        <div class="ai-card-name">${name}</div>
        <div class="ai-card-desc">⭐${(m.rating||0).toFixed(1)} · ${(m.distance||0).toFixed(1)}km</div>
        <span class="ai-card-tag">${aiLabels[i] || t('aiTag')}</span>
      </div>
    `;
  }).join('');
}

function scrollToCard(id) {
  setTimeout(() => {
    const card = document.querySelector(`.v-card[data-id="${id}"]`);
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

// ========== MENU EXPAND ==========
async function toggleMerchantMenu(merchantId) {
  const menuEl = document.getElementById(`menu-${merchantId}`);
  if (!menuEl) return;

  if (expandedCardId === merchantId) {
    menuEl.classList.remove('show');
    menuEl.innerHTML = '';
    expandedCardId = null;
    return;
  }

  // Close previous
  if (expandedCardId) {
    const prev = document.getElementById(`menu-${expandedCardId}`);
    if (prev) { prev.classList.remove('show'); prev.innerHTML = ''; }
  }
  expandedCardId = merchantId;

  const merchant = allMerchants.find(m => m._id === merchantId);
  if (!merchant) return;

  // Get merchant name
  const name = currentLang === 'en' && merchant.name_en ? merchant.name_en : merchant.name;
  const emoji = merchant.emoji || '🍽️';
  const rating = merchant.rating ? merchant.rating.toFixed(1) : '—';
  const dist = merchant.distance ? merchant.distance.toFixed(1) : '?';
  const isOpen = merchant.isOpen !== false;
  const followerCount = merchant.followerCount || merchant.follower_count || 0;

  let menuItems = merchant.menu || [];
  if (!menuItems.length) {
    try {
      const data = await apiCall(`${API_BASE}/merchants/${merchantId}`);
      menuItems = (data.merchant || data).menu || [];
      merchant.menu = menuItems;
    } catch (e) { /* use empty */ }
  }

  // Build menu HTML
  let menuHTML = '';
  if (!menuItems.length) {
    menuHTML = `<p style="color:var(--g4);font-size:13px;text-align:center;padding:12px">${t('noMerchants')}</p>`;
  } else {
    const groups = {};
    menuItems.forEach(item => {
      const cat = item.category || 'Menu';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(item);
    });
    for (const [cat, items] of Object.entries(groups)) {
      menuHTML += `<div class="menu-category">${cat}</div>`;
      items.forEach(item => {
        const itemName = currentLang === 'en' && item.name_en ? item.name_en : item.name;
        menuHTML += `
          <div class="menu-item">
            <div class="menu-item-info">
              <div class="menu-item-name">${itemName}</div>
              <div class="menu-item-price">$${(item.price || 0).toFixed(2)}</div>
            </div>
            <button class="menu-item-add" onclick="event.stopPropagation();addToCart('${merchantId}','${(item.name||'').replace(/'/g,"\\'")}',${item.price||0})">+</button>
          </div>
        `;
      });
    }
  }

  // Render: header + meta row + tabs + content
  menuEl.innerHTML = `
    <div class="menu-header">
      <div class="menu-header-left">
        <span class="menu-header-emoji">${emoji}</span>
        <span class="menu-header-name">${name}</span>
        <span class="menu-header-status ${isOpen ? 'open' : 'closed'}">${isOpen ? '营业中' : '休息中'}</span>
      </div>
      <div class="menu-header-right">
        <button class="btn-follow" id="follow-btn-${merchantId}" onclick="event.stopPropagation();toggleFollow('${merchantId}')">+ 关注</button>
      </div>
    </div>
    <div class="menu-meta-row">
      <span class="menu-meta-item"><span class="star">⭐</span> <strong>${rating}</strong></span>
      <span class="menu-meta-item"><span class="dist">📍</span> <strong>${dist} km</strong></span>
      <span class="menu-meta-item"><span class="fol">👥</span> <strong id="follow-count-${merchantId}">${followerCount}</strong> 粉丝</span>
    </div>
    <div class="expand-tabs">
      <button class="expand-tab on" id="tab-menu-${merchantId}" onclick="event.stopPropagation();switchExpandTab('${merchantId}','menu')">🍽️ 菜单</button>
      <button class="expand-tab" id="tab-sched-${merchantId}" onclick="event.stopPropagation();switchExpandTab('${merchantId}','sched')">📅 日程</button>
    </div>
    <div id="expand-menu-${merchantId}">${menuHTML}</div>
    <div id="expand-sched-${merchantId}" style="display:none"><div class="schedule-empty">加载中…</div></div>
  `;
  menuEl.classList.add('show');

  // Async: load follow status
  loadFollowStatus(merchantId);
}

// ========== SEARCH ==========
function onSearchInput(val) {
  const q = val.trim().toLowerCase();
  if (!q) { renderMerchants(); return; }
  const container = document.getElementById('merchantList');
  const filtered = allMerchants.filter(m => {
    const name = (m.name || '').toLowerCase();
    const nameEn = (m.name_en || '').toLowerCase();
    const type = (m.type || '').toLowerCase();
    return name.includes(q) || nameEn.includes(q) || type.includes(q);
  });
  // Temporarily override and render
  const origAll = allMerchants;
  allMerchants = filtered;
  renderMerchants();
  allMerchants = origAll;
}

// ========== TABS & FILTERS ==========
function switchContentTab(tab) {
  currentContentTab = tab;
  document.querySelectorAll('#contentTabs .tab').forEach(el => {
    el.classList.toggle('on', el.dataset.tab === tab);
  });

  const homeBody = document.getElementById('homeBody');
  const homeCats = document.getElementById('homeCats');
  const filterRow = document.getElementById('filterRow');
  const fullMapWrap = document.getElementById('fullMapWrap');

  if (tab === 'map') {
    homeBody.style.display = 'none';
    homeCats.style.display = 'none';
    filterRow.style.display = 'none';
    fullMapWrap.classList.add('show');
    initFullMap();
  } else {
    homeBody.style.display = '';
    homeCats.style.display = '';
    filterRow.style.display = '';
    fullMapWrap.classList.remove('show');

    if (tab === 'nearby') {
      currentFilter = 'near';
      updateFilterUI();
    } else if (tab === 'rating') {
      currentFilter = 'top';
      updateFilterUI();
    } else {
      currentFilter = 'hot';
      updateFilterUI();
    }
    renderMerchants();
  }
}

function selectCategory(cat) {
  currentCategory = cat;
  document.querySelectorAll('#catsScroll .cat').forEach(el => {
    el.classList.toggle('on', el.dataset.cat === cat);
  });
  renderMerchants();
}

function selectFilter(filter) {
  currentFilter = filter;
  updateFilterUI();
  renderMerchants();
}

function updateFilterUI() {
  document.querySelectorAll('#filterRow .chip').forEach(el => {
    el.classList.toggle('on', el.dataset.filter === currentFilter);
  });
}

// ========== BOTTOM NAV ==========
function switchBottomTab(tab) {
  currentBottomTab = tab;

  // Update nav items
  document.querySelectorAll('#bottomNav .bnav-item').forEach(el => {
    el.classList.remove('on', 'ai-on');
    if (el.dataset.bnav === tab) {
      el.classList.add(tab === 'ai' ? 'ai-on' : 'on');
    }
  });

  // Hide all pages
  document.getElementById('pgHome').classList.remove('show');
  document.getElementById('pgDiscover').classList.remove('show');
  document.getElementById('pgAI').classList.remove('show');
  document.getElementById('pgOrders').classList.remove('show');
  document.getElementById('pgProfile').classList.remove('show');
  document.getElementById('pgProfile').classList.remove('show');
  document.getElementById('fullMapWrap').classList.remove('show');

  // Show selected page
  const pageMap = { home: 'pgHome', discover: 'pgDiscover', ai: 'pgAI', orders: 'pgOrders', profile: 'pgProfile' };
  const pg = document.getElementById(pageMap[tab]);
  if (pg) pg.classList.add('show');

  // If going back to home, ensure map is closed
  if (tab === 'home' && currentContentTab === 'map') {
    document.getElementById('fullMapWrap').classList.add('show');
  }
  // Load profile data
  if (tab === 'profile') {
    // Update user info
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const phone = user.phone || '--';
    document.getElementById('profileUserName').textContent = user.name || '个人中心';
    document.getElementById('profileUserPhone').textContent = phone;
    loadFollowedList();
    loadFriendsList();
  }
  // Refresh following bar when switching to home
  if (tab === 'home') loadMyFollowingBar();
}

// ========== MAPS ==========
function initMiniMap() {
  if (miniMap) return;
  const el = document.getElementById('mini-map');
  if (!el) return;
  miniMap = L.map(el, {
    center: [DEFAULT_CENTER.lat, DEFAULT_CENTER.lng],
    zoom: 14,
    zoomControl: false,
    attributionControl: false,
    dragging: false,
    scrollWheelZoom: false,
    doubleClickZoom: false,
    touchZoom: false
  });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(miniMap);
  addMapMarkers(miniMap, miniMapMarkers);
  setTimeout(() => miniMap.invalidateSize(), 300);
}

function initFullMap() {
  if (fullMap) { fullMap.invalidateSize(); addMapMarkers(fullMap, fullMapMarkers); return; }
  const el = document.getElementById('full-map');
  if (!el) return;
  fullMap = L.map(el, {
    center: [DEFAULT_CENTER.lat, DEFAULT_CENTER.lng],
    zoom: 14,
    zoomControl: true,
    attributionControl: false
  });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(fullMap);

  // User location marker
  L.circleMarker([DEFAULT_CENTER.lat, DEFAULT_CENTER.lng], {
    radius: 8, fillColor: '#ff6b35', fillOpacity: 1, color: '#fff', weight: 3
  }).addTo(fullMap).bindPopup('<b>📍 You are here</b>');

  addMapMarkers(fullMap, fullMapMarkers);
  setTimeout(() => fullMap.invalidateSize(), 300);
}

function addMapMarkers(map, markersArray) {
  // Clear existing
  markersArray.forEach(m => map.removeLayer(m));
  markersArray.length = 0;

  allMerchants.forEach(m => {
    if (!m.location || !m.location.coordinates) return;
    const [lng, lat] = m.location.coordinates;
    const name = currentLang === 'en' && m.name_en ? m.name_en : m.name;
    const emoji = m.emoji || '🍽️';
    const icon = L.divIcon({
      className: '',
      html: `<div style="background:#ff6b35;color:#fff;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(255,107,53,.3)">${emoji} ${name.slice(0,6)}</div>`,
      iconSize: [0, 0],
      iconAnchor: [0, 0]
    });
    const marker = L.marker([lat, lng], { icon }).addTo(map);
    marker.bindPopup(`
      <div class="popup-rich">
        <div class="pr-name">${emoji} ${name}</div>
        <div class="pr-type">${m.type || ''}</div>
        <div class="pr-stars">⭐ ${(m.rating||0).toFixed(1)}</div>
        <div class="pr-dist">${(m.distance||0).toFixed(1)} km</div>
      </div>
    `);
    markersArray.push(marker);
  });
}

// ========== CART ==========
function addToCart(merchantId, itemName, price) {
  if (currentMerchantId && currentMerchantId !== merchantId && cart.length > 0) {
    if (!confirm(t('cartDiffMerchant'))) return;
    cart = [];
  }
  currentMerchantId = merchantId;
  localStorage.setItem('nb_cartMerchant', merchantId);

  const existing = cart.find(c => c.name === itemName && c.merchantId === merchantId);
  if (existing) {
    existing.qty++;
  } else {
    cart.push({ merchantId, name: itemName, price, qty: 1 });
  }
  saveCart();
  updateCartUI();
  showToast(`${itemName} +1`, 'success');
}

function removeFromCart(index) {
  cart.splice(index, 1);
  if (!cart.length) { currentMerchantId = null; localStorage.removeItem('nb_cartMerchant'); }
  saveCart();
  updateCartUI();
  renderCartPanel();
}

function changeQty(index, delta) {
  cart[index].qty += delta;
  if (cart[index].qty <= 0) { removeFromCart(index); return; }
  saveCart();
  updateCartUI();
  renderCartPanel();
}

function saveCart() {
  localStorage.setItem('nb_cart', JSON.stringify(cart));
}

function updateCartUI() {
  const total = cart.reduce((s, c) => s + c.qty, 0);
  const floatEl = document.getElementById('cartFloat');
  const badge = document.getElementById('cartBadge');
  if (total > 0) {
    floatEl.classList.add('show');
    badge.textContent = total;
  } else {
    floatEl.classList.remove('show');
  }
}

function openCart() {
  renderCartPanel();
  document.getElementById('cartOverlay').classList.add('show');
}

function closeCart() {
  document.getElementById('cartOverlay').classList.remove('show');
}

function renderCartPanel() {
  const container = document.getElementById('cartItems');
  const footer = document.getElementById('cartFooter');

  if (!cart.length) {
    container.innerHTML = `<div class="cart-empty">${t('cartEmpty')}</div>`;
    footer.style.display = 'none';
    return;
  }

  footer.style.display = '';
  let total = 0;
  container.innerHTML = cart.map((item, i) => {
    const itemTotal = item.price * item.qty;
    total += itemTotal;
    return `
      <div class="cart-item">
        <div class="cart-item-info">
          <div class="cart-item-name">${item.name}</div>
          <div class="cart-item-price">$${item.price.toFixed(2)}</div>
        </div>
        <div class="cart-item-qty">
          <button class="qty-btn" onclick="changeQty(${i},-1)">−</button>
          <span>${item.qty}</span>
          <button class="qty-btn" onclick="changeQty(${i},1)">+</button>
        </div>
        <div class="cart-item-total">$${itemTotal.toFixed(2)}</div>
      </div>
    `;
  }).join('');

  document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
}

// ========== ORDERS ==========
async function submitOrder() {
  if (!cart.length) return;
  const token = localStorage.getItem('token');
  if (!token) { showToast(t('loginFail'), 'error'); return; }

  const note = document.getElementById('cartNote').value.trim();
  const items = cart.map(c => ({ name: c.name, quantity: c.qty, price: c.price }));
  const totalAmount = cart.reduce((s, c) => s + c.price * c.qty, 0);

  showLoading(true);
  try {
    // Get pickup methods
    let pickupMethod = 'counter';
    try {
      const methods = await apiCall(`${API_BASE}/merchants/${currentMerchantId}/pickup-methods`);
      if (methods && methods.length) pickupMethod = methods[0].type || 'counter';
    } catch (e) { /* use default */ }

    const order = await apiCall(`${API_BASE}/orders`, {
      method: 'POST',
      body: JSON.stringify({
        merchantId: currentMerchantId,
        items,
        totalAmount,
        pickupMethod,
        note,
        tableNumber: null
      })
    });

    showLoading(false);
    closeCart();
    cart = [];
    currentMerchantId = null;
    saveCart();
    updateCartUI();
    showToast(t('orderSuccess'), 'success');

    if (order._id || order.id) {
      showOrderPanel(order);
      startOrderSSE(order._id || order.id);
    }
  } catch (e) {
    showLoading(false);
    showToast(t('orderFail'), 'error');
  }
}

function showOrderPanel(order) {
  const panel = document.getElementById('orderPanel');
  document.getElementById('orderIdText').textContent = `#${(order._id || order.id || '').slice(-8)}`;
  updateOrderStatus(order.status || 'pending');
  panel.classList.add('show');
}

function closeOrderPanel() {
  document.getElementById('orderPanel').classList.remove('show');
  if (orderSSE) { orderSSE.close(); orderSSE = null; }
}

function updateOrderStatus(status) {
  const steps = ['pending', 'confirmed', 'preparing', 'ready'];
  const idx = steps.indexOf(status);
  const titles = {
    pending: '⏳ ' + t('sPending'),
    confirmed: '✅ ' + t('sConfirmed'),
    preparing: '👨‍🍳 ' + t('sPreparing'),
    ready: '🎉 ' + t('sReady')
  };
  document.getElementById('orderStatusTitle').textContent = titles[status] || status;

  steps.forEach((s, i) => {
    const el = document.getElementById(`step-${s}`);
    el.classList.remove('done', 'active');
    if (i < idx) el.classList.add('done');
    else if (i === idx) el.classList.add('active');
  });

  const fill = document.getElementById('statusProgressFill');
  const pct = idx >= 0 ? (idx / (steps.length - 1)) * 100 : 0;
  fill.style.width = `calc(${pct}% - 40px)`;
}

function startOrderSSE(orderId) {
  if (orderSSE) orderSSE.close();
  const token = localStorage.getItem('token');
  try {
    orderSSE = new EventSource(`${BASE_URL}${API_BASE}/orders/${orderId}/stream?token=${token}`);
    orderSSE.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);
        if (data.status) updateOrderStatus(data.status);
      } catch (err) { /* ignore parse errors */ }
    };
    orderSSE.onerror = () => { /* silent */ };
  } catch (e) { /* SSE not supported */ }
}

// ========== GEOLOCATION ==========
function tryGeolocate() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      DEFAULT_CENTER.lat = pos.coords.latitude;
      DEFAULT_CENTER.lng = pos.coords.longitude;
      document.getElementById('locText').textContent = `${pos.coords.latitude.toFixed(3)}, ${pos.coords.longitude.toFixed(3)}`;
      if (miniMap) miniMap.setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lng], 14);
      loadMerchants();
    },
    () => { /* use default */ },
    { timeout: 5000 }
  );
}

// ========== PHASE 2C: FOLLOW & SCHEDULE ==========

// 缓存关注的商家列表
let cachedFollowedList = [];
let followedListLoading = false;

async function loadFollowStatus(merchantId) {
  const token = localStorage.getItem('token');
  const btn = document.getElementById(`follow-btn-${merchantId}`);
  if (!token) {
    if (btn) btn.style.display = 'none';
    return;
  }
  try {
    const isFol = await apiCall(`${API_BASE}/merchants/${merchantId}/is-following`);
    if (btn) {
      btn.textContent = isFol.following ? '✓ 已关注' : '+ 关注';
      btn.classList.toggle('followed', !!isFol.following);
    }
    // Update follower count from merchant data
    const m = (allMerchants || []).find(x => x.id === merchantId || x._id === merchantId);
    const cntEl = document.getElementById(`follow-count-${merchantId}`);
    if (cntEl && m) cntEl.textContent = m.followerCount || m.follower_count || 0;
  } catch (e) { }
}

async function toggleFollow(merchantId) {
  const token = localStorage.getItem('token');
  if (!token) { showToast('请先登录', 'error'); return; }
  const btn = document.getElementById(`follow-btn-${merchantId}`);
  const isFollowed = btn && btn.classList.contains('followed');
  // Optimistic update immediately
  if (btn) {
    btn.disabled = true;
    btn.textContent = isFollowed ? '取消中…' : '关注中…';
  }
  try {
    const method = isFollowed ? 'DELETE' : 'POST';
    await apiCall(`${API_BASE}/merchants/${merchantId}/follow`, { method });
    showToast(isFollowed ? '已取消关注' : '关注成功 ✓', 'success');
    await loadFollowStatus(merchantId);
    // Update follower count optimistically
    const cntEl = document.getElementById(`follow-count-${merchantId}`);
    if (cntEl) {
      const current = parseInt(cntEl.textContent) || 0;
      cntEl.textContent = isFollowed ? Math.max(0, current - 1) : current + 1;
    }
    // 立即更新本地缓存（乐观更新）
    if (isFollowed) {
      // 取消关注：从缓存中移除
      cachedFollowedList = cachedFollowedList.filter(m => (m._id || m.id) !== merchantId);
    } else {
      // 关注：添加到缓存（从 allMerchants 获取商家信息）
      const merchant = allMerchants.find(m => m._id === merchantId || m.id === merchantId);
      if (merchant) {
        cachedFollowedList = [...cachedFollowedList, merchant];
      }
    }
    // 如果在 profile 页面，立即更新列表显示
    if (currentBottomTab === 'profile') {
      const container = document.getElementById('followedList');
      const countEl = document.getElementById('followCount');
      if (container && cachedFollowedList.length >= 0) {
        renderFollowedList(cachedFollowedList, container, countEl);
      }
    }
    // Refresh home following bar
    loadMyFollowingBar();
  } catch (e) {
    if (btn) {
      btn.textContent = isFollowed ? '✓ 已关注' : '+ 关注';
      btn.classList.toggle('followed', isFollowed);
    }
    showToast('操作失败，请重试', 'error');
  } finally {
    if (btn) btn.disabled = false;
  }
}

function switchExpandTab(merchantId, tab) {
  const menuDiv = document.getElementById(`expand-menu-${merchantId}`);
  const schedDiv = document.getElementById(`expand-sched-${merchantId}`);
  const menuTab = document.getElementById(`tab-menu-${merchantId}`);
  const schedTab = document.getElementById(`tab-sched-${merchantId}`);
  if (!menuDiv || !schedDiv) return;
  if (tab === 'menu') {
    menuDiv.style.display = '';
    schedDiv.style.display = 'none';
    menuTab && menuTab.classList.add('on');
    schedTab && schedTab.classList.remove('on');
  } else {
    menuDiv.style.display = 'none';
    schedDiv.style.display = '';
    menuTab && menuTab.classList.remove('on');
    schedTab && schedTab.classList.add('on');
    loadSchedules(merchantId);
  }
}

async function loadSchedules(merchantId) {
  const schedDiv = document.getElementById(`expand-sched-${merchantId}`);
  if (!schedDiv || schedDiv.dataset.loaded) return;
  schedDiv.dataset.loaded = '1';
  const DAY_NAMES = ['周日','周一','周二','周三','周四','周五','周六'];
  try {
    const data = await apiCall(`${API_BASE}/merchants/${merchantId}/schedules`);
    const schedules = Array.isArray(data) ? data : (data.schedules || []);
    const active = schedules.filter(s => s.enabled !== false);
    if (!active.length) {
      schedDiv.innerHTML = '<div class="schedule-empty">📅 暂无出摊计划</div>';
      return;
    }
    schedDiv.innerHTML = active.map(s => {
      const dayName = DAY_NAMES[s.dayOfWeek] || '';
      const timeStr = s.openTime && s.closeTime ? `${s.openTime} – ${s.closeTime}` : '';
      return `
        <div class="schedule-card">
          <div class="schedule-date">📅 ${dayName}</div>
          ${timeStr ? `<div class="schedule-time">⏰ ${timeStr}</div>` : ''}
          ${s.address ? `<div class="schedule-addr">📍 ${s.address}</div>` : ''}
        </div>
      `;
    }).join('');
  } catch (e) {
    const schedDiv2 = document.getElementById(`expand-sched-${merchantId}`);
    if (schedDiv2) schedDiv2.innerHTML = '<div class="schedule-empty">加载失败</div>';
  }
}

async function loadFollowedList() {
  const token = localStorage.getItem('token');
  const container = document.getElementById('followedList');
  const countEl = document.getElementById('followCount');
  if (!container) return;
  if (!token) { 
    container.innerHTML = '<div class="followed-empty"><span class="empty-icon">🔒</span><div class="empty-title">登录后查看关注</div><div class="empty-desc">登录后可查看关注的商家</div></div>'; 
    if (countEl) countEl.textContent = '0';
    return; 
  }
  
  // 如果正在加载，不重复请求
  if (followedListLoading) return;
  followedListLoading = true;
  
  // 先显示缓存数据（如果有）
  if (cachedFollowedList.length > 0) {
    renderFollowedList(cachedFollowedList, container, countEl);
  } else {
    // 显示加载骨架屏
    container.innerHTML = `
      <div class="followed-loading" style="padding:20px;text-align:center;color:var(--g4);">
        <div style="display:flex;gap:12px;flex-direction:column;">
          <div style="height:80px;background:var(--g1);border-radius:14px;animation:pulse 1.5s infinite;"></div>
          <div style="height:80px;background:var(--g1);border-radius:14px;animation:pulse 1.5s infinite;"></div>
          <div style="height:80px;background:var(--g1);border-radius:14px;animation:pulse 1.5s infinite;"></div>
        </div>
        <style>@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}</style>
      </div>
    `;
  }
  
  try {
    const data = await apiCall(`${API_BASE}/user/following`);
    const merchants = Array.isArray(data) ? data : (data.merchants || []);
    // 更新缓存
    cachedFollowedList = merchants;
    renderFollowedList(merchants, container, countEl);
  } catch (e) {
    if (cachedFollowedList.length === 0) {
      container.innerHTML = '<div class="followed-empty"><span class="empty-icon">⚠️</span><div class="empty-title">加载失败</div><div class="empty-desc">请稍后重试</div></div>';
    }
  } finally {
    followedListLoading = false;
  }
}

function renderFollowedList(merchants, container, countEl) {
  if (countEl) countEl.textContent = merchants.length || '0';
  if (!merchants.length) {
    container.innerHTML = `
      <div class="followed-empty">
        <span class="empty-icon">🔍</span>
        <div class="empty-title">还没有关注的商家</div>
        <div class="empty-desc">去首页发现更多美食餐车</div>
        <button class="empty-action" onclick="switchBottomTab('home')">发现商家</button>
      </div>
    `;
    return;
  }
  container.innerHTML = merchants.map(m => {
    const name = currentLang === 'en' && m.name_en ? m.name_en : m.name;
    const emoji = m.emoji || '🍽️';
    const isOpen = m.isOpen !== false;
    const dist = m.distance ? m.distance.toFixed(1) : '?';
    const type = m.type || '';
    return `
      <div class="followed-card">
        <div class="followed-left" onclick="switchBottomTab('home');setTimeout(()=>toggleMerchantMenu('${m._id || m.id}'),300)">
          <div class="followed-emoji">${emoji}</div>
          <div class="followed-info">
            <div class="followed-name">${name}</div>
            <div class="followed-meta">
              <span class="status-dot ${isOpen ? '' : 'closed'}"></span>
              <span class="status-text ${isOpen ? '' : 'closed'}">${isOpen ? '营业中' : '休息中'}</span>
              <span class="distance">📍 ${dist} km</span>
            </div>
          </div>
        </div>
        <button class="followed-view-btn" onclick="switchBottomTab('home');setTimeout(()=>toggleMerchantMenu('${m._id || m.id}'),300)">去看看</button>
      </div>
    `;
  }).join('');
}

// Load "My Following" bar on home page
async function loadMyFollowingBar() {
  const token = localStorage.getItem('token');
  const bar = document.getElementById('myFollowingBar');
  const scroll = document.getElementById('myFollowingScroll');
  if (!bar || !scroll) return;
  if (!token) { bar.classList.remove('show'); return; }
  try {
    const data = await apiCall(`${API_BASE}/user/following`);
    const merchants = Array.isArray(data) ? data : (data.merchants || []);
    if (!merchants.length) { bar.classList.remove('show'); return; }
    bar.classList.add('show');
    scroll.innerHTML = merchants.map(m => {
      const name = currentLang === 'en' && m.name_en ? m.name_en : m.name;
      const emoji = m.emoji || '🍽️';
      const isOpen = m.isOpen !== false;
      return `
        <div class="my-following-chip" onclick="toggleMerchantMenu('${m._id || m.id}');scrollToCard('${m._id || m.id}')">
          <span class="chip-emoji">${emoji}</span>
          <span class="chip-name">${name.slice(0, 6)}${name.length > 6 ? '…' : ''}</span>
          <span class="chip-status ${isOpen ? '' : 'closed'}"></span>
        </div>
      `;
    }).join('');
  } catch (e) {
    bar.classList.remove('show');
  }
}

// ========== PHASE 3A: FRIEND SYSTEM ==========

// 缓存好友列表
let cachedFriendsList = [];
let cachedPendingRequests = [];

// 加载好友列表
async function loadFriendsList() {
  const token = localStorage.getItem('token');
  const container = document.getElementById('friendsList');
  const countEl = document.getElementById('friendCount');
  if (!container) return;
  if (!token) {
    container.innerHTML = '<div class="friend-empty"><span class="empty-icon">🔒</span><div class="empty-title">登录后查看好友</div><div class="empty-desc">登录后可添加和管理好友</div></div>';
    if (countEl) countEl.textContent = '0';
    return;
  }

  try {
    // 并行加载好友列表和待处理请求
    const [friendsData, pendingData] = await Promise.all([
      apiCall(`${API_BASE}/friends`),
      apiCall(`${API_BASE}/friends/requests/pending`)
    ]);

    cachedFriendsList = Array.isArray(friendsData) ? friendsData : (friendsData.friends || []);
    cachedPendingRequests = Array.isArray(pendingData) ? pendingData : (pendingData.requests || []);

    // 更新计数
    if (countEl) countEl.textContent = cachedFriendsList.length;

    // 渲染待处理请求
    renderPendingRequests();

    // 渲染好友列表
    renderFriendsList();
  } catch (e) {
    console.error('加载好友列表错误:', e);
    container.innerHTML = '<div class="friend-empty"><span class="empty-icon">⚠️</span><div class="empty-title">加载失败</div><div class="empty-desc">请稍后重试</div></div>';
  }
}

// 渲染待处理好友请求
function renderPendingRequests() {
  const container = document.getElementById('pendingFriendRequests');
  if (!container) return;

  if (!cachedPendingRequests.length) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = `
    <div class="profile-section-title" style="font-size:14px;margin-bottom:10px;">📨 好友请求 <span class="count">${cachedPendingRequests.length}</span></div>
    ${cachedPendingRequests.map(r => `
      <div class="friend-request-card" id="request-${r.id}">
        <div class="friend-request-header">
          <div class="friend-request-info">
            <div class="friend-request-emoji">👤</div>
            <div class="friend-request-phone">+64 ****${r.fromUser?.phoneLast4 || '****'}</div>
          </div>
          <div class="friend-request-actions">
            <button class="btn-accept-friend" onclick="acceptFriend('${r.id}')">接受</button>
            <button class="btn-reject-friend" onclick="rejectFriend('${r.id}')">拒绝</button>
          </div>
        </div>
      </div>
    `).join('')}
  `;
}

// 渲染好友列表
function renderFriendsList() {
  const container = document.getElementById('friendsList');
  if (!container) return;

  if (!cachedFriendsList.length) {
    container.innerHTML = `
      <div class="friend-empty">
        <span class="empty-icon">👥</span>
        <div class="empty-title">还没有好友</div>
        <div class="empty-desc">搜索手机号添加好友</div>
      </div>
    `;
    return;
  }

  container.innerHTML = cachedFriendsList.map(f => `
    <div class="friend-card" id="friend-${f.id}">
      <div class="friend-info">
        <div class="friend-emoji">👤</div>
        <div>
          <div class="friend-phone">+64 ****${f.phoneLast4 || '****'}</div>
          <div class="friend-since">好友</div>
        </div>
      </div>
      <button class="btn-delete-friend" onclick="deleteFriend('${f.id}')">删除</button>
    </div>
  `).join('');
}

// 搜索用户
async function searchUsersForFriend() {
  const input = document.getElementById('friendSearchInput');
  const resultsContainer = document.getElementById('friendSearchResults');
  const query = (input?.value || '').trim();

  if (!query || query.length < 3) {
    showToast('请输入至少3位手机号', 'error');
    return;
  }

  try {
    const data = await apiCall(`${API_BASE}/friends/search?q=${encodeURIComponent(query)}`);
    const users = Array.isArray(data) ? data : (data.users || []);

    if (!users.length) {
      resultsContainer.innerHTML = '<div style="text-align:center;padding:20px;color:var(--g4);font-size:14px;">未找到用户</div>';
      return;
    }

    resultsContainer.innerHTML = users.map(u => `
      <div class="friend-search-card">
        <div class="friend-search-info">
          <div class="friend-search-emoji">👤</div>
          <div class="friend-search-phone">+64 ****${u.phoneLast4 || '****'}</div>
        </div>
        <div class="friend-search-actions">
          ${u.isFriend 
            ? '<button class="btn-add-friend is-friend" disabled>已好友</button>'
            : `<button class="btn-add-friend" onclick="sendFriendReq('${u.id}')">+ 添加</button>`
          }
        </div>
      </div>
    `).join('');
  } catch (e) {
    console.error('搜索用户错误:', e);
    showToast('搜索失败，请重试', 'error');
  }
}

// 发送好友请求
async function sendFriendReq(toUserId) {
  try {
    const result = await apiCall(`${API_BASE}/friends/request/${toUserId}`, { method: 'POST' });
    showToast(result.message || '请求已发送', 'success');
    // 刷新搜索结果
    searchUsersForFriend();
  } catch (e) {
    const msg = e.error || e.message || '发送失败';
    showToast(msg, 'error');
  }
}

// 接受好友请求
async function acceptFriend(requestId) {
  try {
    await apiCall(`${API_BASE}/friends/accept/${requestId}`, { method: 'POST' });
    showToast('已添加为好友', 'success');
    // 从待处理列表移除
    cachedPendingRequests = cachedPendingRequests.filter(r => r.id !== requestId);
    // 重新加载好友列表
    await loadFriendsList();
  } catch (e) {
    showToast('接受失败，请重试', 'error');
  }
}

// 拒绝好友请求
async function rejectFriend(requestId) {
  try {
    await apiCall(`${API_BASE}/friends/reject/${requestId}`, { method: 'POST' });
    showToast('已拒绝', 'info');
    // 从待处理列表移除
    cachedPendingRequests = cachedPendingRequests.filter(r => r.id !== requestId);
    renderPendingRequests();
  } catch (e) {
    showToast('操作失败，请重试', 'error');
  }
}

// 删除好友
async function deleteFriend(friendId) {
  if (!confirm('确定要删除这个好友吗？')) return;

  try {
    await apiCall(`${API_BASE}/friends/${friendId}`, { method: 'DELETE' });
    showToast('已删除好友', 'info');
    // 从列表移除
    cachedFriendsList = cachedFriendsList.filter(f => f.id !== friendId);
    const countEl = document.getElementById('friendCount');
    if (countEl) countEl.textContent = cachedFriendsList.length;
    renderFriendsList();
  } catch (e) {
    showToast('删除失败，请重试', 'error');
  }
}

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', () => {
  // Restore language
  document.getElementById('langSelect').value = currentLang;
  applyI18n();
  checkAuthAndInit();
  tryGeolocate();
});
</script>
</body>
</html>
