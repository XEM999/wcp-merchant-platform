<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NearBite ‚Äî ÂèëÁé∞ÁæéÈ£ü</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçú</text></svg>">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Vant CSS -->
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css"/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --van-primary-color: #ff6b35;
            --van-success-color: #22c55e;
            --van-danger-color: #ef4444;
            --van-warning-color: #f59e0b;
            --van-background: #f7f8fa;
            --van-text-color: #111827;
            --van-text-color-2: #6b7280;
            --van-text-color-3: #9ca3af;
            --van-border-color: #e5e7eb;
            --van-radius-lg: 16px;
            --van-radius-md: 10px;
            --primary-light: #fff7ed;
            --primary-dark: #ea580c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--van-background);
            color: var(--van-text-color);
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom, 20px);
            -webkit-font-smoothing: antialiased;
        }

        /* App Container */
        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Customization */
        .app-header .van-nav-bar {
            --van-nav-bar-background: rgba(255,255,255,.95);
            --van-nav-bar-title-font-size: 20px;
            --van-nav-bar-title-font-weight: 800;
            backdrop-filter: blur(20px);
        }

        .header-logo {
            font-size: 28px;
            margin-right: 4px;
        }

        .header-brand {
            font-size: 20px;
            font-weight: 800;
            color: var(--van-primary-color);
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .merchant-link {
            padding: 8px 14px;
            background: var(--primary-light);
            color: var(--primary-dark);
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all .2s;
        }

        .merchant-link:active {
            background: var(--van-primary-color);
            color: white;
        }

        /* Location Bar */
        .location-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            font-size: 13px;
            color: var(--van-text-color-2);
            background: white;
            border-bottom: 1px solid var(--van-border-color);
        }

        .loc-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .loc-dot.ok {
            background: var(--van-success-color);
            box-shadow: 0 0 6px rgba(34,197,94,.4);
        }

        .loc-dot.wait {
            background: var(--van-warning-color);
            animation: pulse 1s infinite;
        }

        .loc-dot.fail {
            background: var(--van-danger-color);
        }

        @keyframes pulse {
            50% { opacity: .4; }
        }

        /* Map Container */
        #map-container {
            height: 55vh;
            min-height: 300px;
            position: relative;
            border-bottom: 1px solid var(--van-border-color);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-refresh-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 1000;
        }

        /* Search Section */
        .search-section {
            padding: 12px 16px;
            background: white;
        }

        .search-section .van-search {
            padding: 0;
        }

        /* Merchant Section */
        .merchant-section {
            padding: 16px;
            background: var(--van-background);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
        }

        .section-count {
            font-size: 13px;
            color: var(--van-text-color-3);
            font-weight: 500;
        }

        /* Merchant Card */
        .merchant-card {
            background: white;
            border-radius: var(--van-radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
            transition: all .2s;
        }

        .merchant-card:active {
            transform: scale(.99);
        }

        .mc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .mc-info {
            display: flex;
            gap: 12px;
            flex: 1;
        }

        .mc-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .mc-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .mc-meta {
            font-size: 12px;
            color: var(--van-text-color-2);
        }

        .mc-dist {
            background: var(--primary-light);
            color: var(--van-primary-color);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .mc-rating {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 8px 0;
        }

        .mc-rating-num {
            font-weight: 700;
            font-size: 14px;
        }

        .mc-rating-cnt {
            color: var(--van-text-color-3);
            font-size: 12px;
        }

        .mc-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* Menu Expand */
        .menu-expand {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--van-border-color);
        }

        .menu-category {
            font-size: 12px;
            font-weight: 600;
            color: var(--van-text-color-2);
            margin: 12px 0 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item-info {
            flex: 1;
        }

        .menu-item-name {
            font-size: 14px;
            font-weight: 500;
        }

        .menu-item-price {
            color: var(--primary-dark);
            font-size: 14px;
            font-weight: 700;
            margin-top: 2px;
        }

        /* Cart Floating Button */
        .cart-float {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            right: 20px;
            z-index: 900;
        }

        /* Cart Panel */
        .cart-panel {
            border-radius: 24px 24px 0 0;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .cart-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--van-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-title {
            font-size: 18px;
            font-weight: 700;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 12px 20px;
            max-height: 40vh;
        }

        .cart-empty {
            text-align: center;
            padding: 40px;
            color: var(--van-text-color-3);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--van-border-color);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-size: 14px;
            font-weight: 500;
        }

        .cart-item-price {
            color: var(--primary-dark);
            font-size: 13px;
        }

        .cart-item-total {
            font-weight: 700;
            min-width: 70px;
            text-align: right;
        }

        .cart-footer {
            padding: 16px 20px calc(24px + env(safe-area-inset-bottom, 0px));
            border-top: 1px solid var(--van-border-color);
            background: white;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .cart-total-amount {
            color: var(--primary-dark);
        }

        .order-options {
            margin-bottom: 12px;
        }

        .option-label {
            font-size: 13px;
            color: var(--van-text-color-2);
            margin-bottom: 8px;
        }

        .option-row {
            display: flex;
            gap: 8px;
        }

        .cart-note {
            width: 100%;
            margin-bottom: 12px;
        }

        /* Order Status Panel */
        .order-panel {
            border-radius: var(--van-radius-lg);
            padding: 20px;
            margin: 16px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .order-id {
            font-size: 12px;
            color: var(--van-text-color-2);
        }

        .order-status-title {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
        }

        .status-progress {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 20px;
        }

        .status-progress::before {
            content: '';
            position: absolute;
            top: 14px;
            left: 20px;
            right: 20px;
            height: 4px;
            background: var(--van-border-color);
            border-radius: 2px;
        }

        .status-progress-fill {
            position: absolute;
            top: 14px;
            left: 20px;
            height: 4px;
            background: var(--van-success-color);
            border-radius: 2px;
            transition: width .5s ease;
        }

        .status-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
        }

        .status-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--van-background);
            border: 3px solid var(--van-border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-bottom: 6px;
            transition: all .3s;
        }

        .status-step.done .status-icon {
            background: var(--van-success-color);
            border-color: var(--van-success-color);
            color: white;
        }

        .status-step.active .status-icon {
            background: var(--van-primary-color);
            border-color: var(--van-primary-color);
            color: white;
            animation: pulse 1s infinite;
        }

        .status-label {
            font-size: 10px;
            color: var(--van-text-color-3);
            text-align: center;
        }

        .status-step.done .status-label,
        .status-step.active .status-label {
            color: var(--van-text-color);
            font-weight: 600;
        }

        .order-action {
            text-align: center;
            margin-top: 16px;
        }

        /* Login Modal */
        .login-modal {
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
        }

        .form-toggle {
            text-align: center;
            font-size: 13px;
            color: var(--van-text-color-2);
            margin-top: 12px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--van-text-color-3);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Leaflet Popup Overrides */
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
        }

        .leaflet-popup-content {
            margin: 12px 16px !important;
            font-family: 'Inter', sans-serif !important;
        }

        .popup-rich .pr-name {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .popup-rich .pr-type {
            font-size: 12px;
            color: var(--van-text-color-2);
            margin-bottom: 4px;
        }

        .popup-rich .pr-stars {
            color: #f59e0b;
            font-size: 12px;
        }

        .popup-rich .pr-dist {
            font-size: 12px;
            color: var(--van-primary-color);
            font-weight: 600;
        }

        .popup-rich .pr-action {
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--van-primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
        }

        /* Responsive adjustments */
        @media screen and (max-width: 320px) {
            .mc-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            .mc-name {
                font-size: 14px;
            }
            .section-title {
                font-size: 16px;
            }
        }

        @media screen and (min-width: 430px) {
            .merchant-section {
                max-width: 430px;
                margin: 0 auto;
            }
            #map-container {
                max-height: 350px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <van-nav-bar class="app-header" fixed placeholder>
            <template #left>
                <div class="header-actions" style="display: flex; align-items: center;">
                    <span class="header-logo">üçú</span>
                    <span class="header-brand">NearBite</span>
                </div>
            </template>
            <template #right>
                <div class="header-actions">
                    <a href="/merchant" class="merchant-link">{{ t('im_merchant') }}</a>
                    <van-button 
                        type="primary" 
                        size="small" 
                        round 
                        icon="user-o"
                        @click="showLoginModal = true"
                    ></van-button>
                    <van-button 
                        size="small" 
                        round 
                        plain
                        @click="toggleLang"
                    >{{ currentLang === 'zh' ? '‰∏≠Êñá' : 'EN' }}</van-button>
                </div>
            </template>
        </van-nav-bar>

        <!-- Location Bar -->
        <div class="location-bar">
            <span class="loc-dot" :class="locationStatus"></span>
            <span>{{ locationText }}</span>
        </div>

        <!-- Map -->
        <div id="map-container">
            <div id="map"></div>
            <van-button 
                class="map-refresh-btn" 
                icon="replay" 
                round 
                type="default"
                size="small"
                @click="refreshLocation"
            ></van-button>
        </div>

        <!-- Search -->
        <div class="search-section">
            <van-search 
                v-model="searchQuery" 
                :placeholder="t('search_placeholder')"
                shape="round"
                background="transparent"
                @search="onSearch"
            />
        </div>

        <!-- Merchant List -->
        <div class="merchant-section">
            <div class="section-header">
                <h3 class="section-title">{{ t('nearby_merchants') }}</h3>
                <span class="section-count">{{ t('merchant_count', { n: merchants.length }) }}</span>
            </div>

            <!-- Pull Refresh -->
            <van-pull-refresh v-model="refreshing" @refresh="onRefresh">
                <div v-if="loading && !merchants.length" style="padding: 20px;">
                    <van-skeleton title avatar :row="3" />
                    <van-skeleton title avatar :row="3" style="margin-top: 16px;" />
                </div>

                <div v-else-if="!merchants.length" class="empty-state">
                    <div class="empty-icon">üîç</div>
                    <div>{{ t('no_merchants_nearby') }}</div>
                </div>

                <div v-else class="merchant-list">
                    <div 
                        v-for="merchant in filteredMerchants" 
                        :key="merchant.id" 
                        class="merchant-card"
                    >
                        <div class="mc-header">
                            <div class="mc-info">
                                <div class="mc-icon">{{ getTypeIcon(merchant.type) }}</div>
                                <div>
                                    <div class="mc-name">{{ merchant.name }}</div>
                                    <div class="mc-meta">
                                        {{ typeName(merchant.type) }}
                                        <span v-if="merchant.address"> ¬∑ {{ merchant.address }}</span>
                                    </div>
                                </div>
                            </div>
                            <van-tag type="primary" round>{{ merchant.distance || '?' }}km</van-tag>
                        </div>

                        <div class="mc-rating">
                            <van-rate 
                                :model-value="merchant.rating" 
                                :count="5" 
                                readonly 
                                size="14"
                                color="#f59e0b"
                                void-color="#e5e7eb"
                            />
                            <span class="mc-rating-num">{{ merchant.rating }}</span>
                            <span class="mc-rating-cnt">({{ merchant.reviewCount || 0 }})</span>
                        </div>

                        <div class="mc-actions">
                            <van-button 
                                type="default" 
                                size="small" 
                                round
                                icon="orders-o"
                                @click="toggleMenu(merchant.id)"
                            >
                                {{ t('view_menu') }}
                            </van-button>
                        </div>

                        <!-- Menu Expand -->
                        <van-collapse v-model="expandedMenus">
                            <van-collapse-item :name="merchant.id" v-show="expandedMenus.includes(merchant.id)">
                                <template #title></template>
                                <div class="menu-expand" v-if="merchant.menu && merchant.menu.length">
                                    <div 
                                        v-for="(item, idx) in merchant.menu" 
                                        :key="idx" 
                                        class="menu-item"
                                    >
                                        <div class="menu-item-info">
                                            <div class="menu-item-name">{{ item.name }}</div>
                                            <div class="menu-item-price">NZD ${{ item.price }}</div>
                                        </div>
                                        <van-button 
                                            type="primary" 
                                            size="small" 
                                            round 
                                            icon="plus"
                                            @click="addToCart(merchant.id, item.name, item.price)"
                                        />
                                    </div>
                                </div>
                            </van-collapse-item>
                        </van-collapse>
                    </div>
                </div>
            </van-pull-refresh>
        </div>

        <!-- Cart Floating Button -->
        <van-badge 
            :content="cartTotalQty" 
            :show="cartTotalQty > 0"
            class="cart-float"
        >
            <van-button 
                type="primary" 
                round 
                size="large"
                icon="shopping-cart-o"
                @click="showCartPopup = true"
            />
        </van-badge>

        <!-- Cart Popup -->
        <van-popup 
            v-model:show="showCartPopup" 
            position="bottom" 
            round
            :style="{ height: '70%' }"
        >
            <div class="cart-panel">
                <div class="cart-header">
                    <span class="cart-title">{{ t('cart') }}</span>
                    <van-button icon="cross" round size="small" @click="showCartPopup = false" />
                </div>

                <div class="cart-items">
                    <div v-if="!cart.length" class="cart-empty">
                        {{ t('cart_empty') }}
                    </div>
                    <div v-for="(item, idx) in cart" :key="idx" class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">{{ item.name }}</div>
                            <div class="cart-item-price">NZD ${{ item.price }} √ó {{ item.qty }}</div>
                        </div>
                        <van-stepper 
                            :model-value="item.qty" 
                            @change="(val) => updateCartQty(item.name, item.price, val)"
                            min="0"
                            theme="round"
                        />
                        <div class="cart-item-total">NZD ${{ (item.price * item.qty).toFixed(2) }}</div>
                    </div>
                </div>

                <div class="cart-footer">
                    <div class="cart-total">
                        <span>{{ t('total') }}</span>
                        <span class="cart-total-amount">NZD ${{ cartTotalAmount.toFixed(2) }}</span>
                    </div>

                    <div class="order-options">
                        <div class="option-label">{{ t('pickup_method') }}</div>
                        <van-radio-group v-model="pickupMethod" direction="horizontal">
                            <van-radio name="self">{{ t('self_pickup') }}</van-radio>
                            <van-radio name="table">{{ t('delivery_table') }}</van-radio>
                        </van-radio-group>
                    </div>

                    <van-field
                        v-model="orderNote"
                        :placeholder="t('order_note')"
                        type="textarea"
                        rows="1"
                        autosize
                        class="cart-note"
                    />

                    <van-button 
                        type="primary" 
                        block 
                        round 
                        size="large"
                        @click="submitOrder"
                    >
                        {{ t('confirm_order') }}
                    </van-button>
                </div>
            </div>
        </van-popup>

        <!-- Order Status Panel -->
        <van-popup 
            v-model:show="showOrderPanel" 
            position="top"
            :style="{ padding: '0' }"
            round
        >
            <div class="order-panel">
                <div class="order-header">
                    <span class="order-id">{{ t('order_id') }}{{ currentOrder?.id?.substring(0, 8) || '---' }}</span>
                    <van-button icon="cross" round size="small" @click="showOrderPanel = false" />
                </div>

                <div class="order-status-title">{{ orderStatusTitle }}</div>

                <div class="status-progress">
                    <div class="status-progress-fill" :style="{ width: orderProgress + '%' }"></div>
                    <div 
                        v-for="(step, idx) in statusSteps" 
                        :key="idx"
                        class="status-step"
                        :class="{
                            'done': statusStepClass(step.status) === 'done',
                            'active': statusStepClass(step.status) === 'active'
                        }"
                    >
                        <div class="status-icon">{{ step.icon }}</div>
                        <span class="status-label">{{ step.label }}</span>
                    </div>
                </div>

                <div class="order-action">
                    <van-button size="small" round @click="showOrderPanel = false">
                        {{ t('close') }}
                    </van-button>
                </div>
            </div>
        </van-popup>

        <!-- Login Modal -->
        <van-dialog 
            v-model:show="showLoginModal" 
            :title="isRegister ? t('register') : t('login')"
            show-cancel-button
            :confirm-button-text="isRegister ? t('register_btn') : t('login_btn')"
            :cancel-button-text="isRegister ? t('login_btn') : t('register_btn')"
            @confirm="isRegister ? doRegister() : doLogin()"
            @cancel="isRegister = !isRegister"
        >
            <div class="login-modal">
                <van-cell-group inset>
                    <van-field
                        v-model="loginPhone"
                        :label="t('phone')"
                        :placeholder="t('phone_placeholder')"
                        type="tel"
                        clearable
                    />
                    <van-field
                        v-model="loginPassword"
                        :label="t('password')"
                        :placeholder="t('password_placeholder')"
                        type="password"
                        clearable
                    />
                </van-cell-group>
                <div class="form-toggle">
                    <span>{{ t('no_account') }}</span>
                    <van-button type="primary" size="small" plain @click="isRegister = !isRegister">
                        {{ t('register_now') }}
                    </van-button>
                </div>
            </div>
        </van-dialog>

        <!-- Loading Overlay -->
        <van-overlay :show="loading">
            <div class="loading-wrapper" style="display: flex; align-items: center; justify-content: center; height: 100%;">
                <van-loading type="spinner" size="36px" vertical>{{ loadingText }}</van-loading>
            </div>
        </van-overlay>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Vue 3 -->
    <script src="https://fastly.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <!-- Vant 4 -->
    <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>

    <script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    const app = createApp({
        setup() {
            // ===== i18n =====
            const LANG = {
                zh: {
                    im_merchant: 'ÊàëÊòØÂïÜÂÆ∂',
                    locating: 'Ê≠£Âú®Ëé∑Âèñ‰ΩçÁΩÆ‚Ä¶',
                    located: 'Â∑≤ÂÆö‰Ωç',
                    location_fail: 'ÂÆö‰ΩçÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆ',
                    search_placeholder: 'ÊêúÁ¥¢ÂïÜÊà∑ÊàñËèúÂìÅ...',
                    nearby_merchants: 'ÈôÑËøëÂïÜÊà∑',
                    merchant_count: '{n} ÂÆ∂',
                    view_menu: 'Êü•ÁúãËèúÂçï',
                    add_to_cart: 'Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶',
                    cart: 'Ë¥≠Áâ©ËΩ¶',
                    cart_empty: 'Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑ',
                    total: 'ÂêàËÆ°',
                    pickup_method: 'ÂèñÈ§êÊñπÂºè',
                    self_pickup: 'Ëá™Âèñ',
                    delivery_table: 'ÈÄÅÂà∞Ê°å',
                    order_note: 'Â§áÊ≥®ÔºöÊ°åÂè∑ÊàñÁâπÊÆäË¶ÅÊ±Ç',
                    confirm_order: 'Á°ÆËÆ§‰∏ãÂçï',
                    order_pending: 'Á≠âÂæÖÂïÜÂÆ∂Êé•Âçï...',
                    order_accepted: 'ÂïÜÂÆ∂Â∑≤Êé•Âçï',
                    order_preparing: 'Ê≠£Âú®ÂáÜÂ§á‰∏≠',
                    order_ready: 'ËØ∑ÂèñÈ§ê',
                    order_delivered: 'Â∑≤ÈÄÅÂà∞ Table {n}',
                    status_pending: 'ÂæÖÊé•Âçï',
                    status_accepted: 'Â∑≤Êé•Âçï',
                    status_preparing: 'Âà∂‰Ωú‰∏≠',
                    status_ready: 'Â∑≤ÂÆåÊàê',
                    close: 'ÂÖ≥Èó≠',
                    login: 'ÁôªÂΩï',
                    phone: 'ÊâãÊú∫Âè∑',
                    password: 'ÂØÜÁ†Å',
                    phone_placeholder: '+64 ...',
                    password_placeholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                    login_btn: 'ÁôªÂΩï',
                    register_btn: 'Ê≥®ÂÜåÊñ∞Ë¥¶Âè∑',
                    no_account: 'ËøòÊ≤°ÊúâË¥¶Âè∑Ôºü',
                    register_now: 'Á´ãÂç≥Ê≥®ÂÜå',
                    register: 'Ê≥®ÂÜå',
                    login_success: 'ÁôªÂΩïÊàêÂäü',
                    register_success: 'Ê≥®ÂÜåÊàêÂäü',
                    order_success: '‰∏ãÂçïÊàêÂäüÔºÅ',
                    added_to_cart: 'Â∑≤Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶',
                    cart_updated: 'Ë¥≠Áâ©ËΩ¶Â∑≤Êõ¥Êñ∞',
                    no_merchants_nearby: 'ÈôÑËøëÊ≤°ÊúâÂú®Á∫øÂïÜÊà∑',
                    empty_cart_warning: 'Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑ',
                    select_merchant: 'ËØ∑ÂÖàÈÄâÊã©ÂïÜÊà∑',
                    order_id: 'ËÆ¢Âçï #',
                    type_food_truck: 'ÁæéÈ£üËΩ¶',
                    type_cafe: 'ÂíñÂï°ÂéÖ',
                    type_bakery: 'ÁÉòÁÑôÂ∫ó',
                    type_other: 'ÂÖ∂‰ªñ',
                    searching: 'ÊêúÁ¥¢‰∏≠‚Ä¶',
                    logging_in: 'ÁôªÂΩï‰∏≠‚Ä¶',
                    registering: 'Ê≥®ÂÜå‰∏≠‚Ä¶',
                    placing_order: '‰∏ãÂçï‰∏≠‚Ä¶'
                },
                en: {
                    im_merchant: 'Merchant',
                    locating: 'Getting location...',
                    located: 'üìç Located',
                    location_fail: 'Location failed, using default',
                    search_placeholder: 'Search merchants or dishes...',
                    nearby_merchants: 'Nearby Merchants',
                    merchant_count: '{n} found',
                    view_menu: 'View Menu',
                    add_to_cart: 'Add to Cart',
                    cart: 'Cart',
                    cart_empty: 'Cart is empty',
                    total: 'Total',
                    pickup_method: 'Pickup Method',
                    self_pickup: 'Self Pickup',
                    delivery_table: 'Delivery to Table',
                    order_note: 'Note: Table# or special requests',
                    confirm_order: 'Confirm Order',
                    order_pending: 'Waiting for merchant...',
                    order_accepted: 'Merchant accepted',
                    order_preparing: 'Preparing your order',
                    order_ready: 'Ready for pickup!',
                    order_delivered: 'Delivered to Table {n}',
                    status_pending: 'Pending',
                    status_accepted: 'Accepted',
                    status_preparing: 'Preparing',
                    status_ready: 'Ready',
                    close: 'Close',
                    login: 'Login',
                    phone: 'Phone',
                    password: 'Password',
                    phone_placeholder: '+64 ...',
                    password_placeholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                    login_btn: 'Login',
                    register_btn: 'Create Account',
                    no_account: 'No account?',
                    register_now: 'Register now',
                    register: 'Register',
                    login_success: 'Login successful',
                    register_success: 'Registration successful',
                    order_success: 'Order placed!',
                    added_to_cart: 'Added to cart',
                    cart_updated: 'Cart updated',
                    no_merchants_nearby: 'No merchants nearby',
                    empty_cart_warning: 'Cart is empty',
                    select_merchant: 'Please select a merchant',
                    order_id: 'Order #',
                    type_food_truck: 'Food Truck',
                    type_cafe: 'Cafe',
                    type_bakery: 'Bakery',
                    type_other: 'Other',
                    searching: 'Searching‚Ä¶',
                    logging_in: 'Logging in...',
                    registering: 'Registering...',
                    placing_order: 'Placing order...'
                }
            };

            const currentLang = ref(localStorage.getItem('lang') || 'zh');

            function t(key, vars) {
                let s = (LANG[currentLang.value] && LANG[currentLang.value][key]) || (LANG.zh[key]) || key;
                if (vars) {
                    Object.keys(vars).forEach(k => {
                        s = s.replace('{' + k + '}', vars[k]);
                    });
                }
                return s;
            }

            function toggleLang() {
                currentLang.value = currentLang.value === 'zh' ? 'en' : 'zh';
                localStorage.setItem('lang', currentLang.value);
            }

            // ===== Config =====
            const API_BASE = '/api';
            const DEFAULT_CENTER = { lat: -43.532, lng: 172.636 };
            const TYPE_ICON = { food_truck: 'üöö', cafe: '‚òï', bakery: 'üçû', other: 'üì¶' };

            function getTypeIcon(type) {
                return TYPE_ICON[type] || 'üì¶';
            }

            function typeName(type) {
                return t('type_' + type) || type;
            }

            // ===== State =====
            const map = ref(null);
            const markers = ref([]);
            const merchants = ref([]);
            const expandedMenus = ref([]);
            const userLoc = ref(null);
            const userLocMarker = ref(null);
            const searchQuery = ref('');

            // Cart state
            const cart = ref(JSON.parse(localStorage.getItem('cart') || '[]'));
            const currentMerchantId = ref(null);
            const showCartPopup = ref(false);
            const pickupMethod = ref('self');
            const orderNote = ref('');

            // Order state
            const currentOrder = ref(null);
            const showOrderPanel = ref(false);
            const sseConnection = ref(null);

            // Auth state
            const showLoginModal = ref(false);
            const isRegister = ref(false);
            const loginPhone = ref('');
            const loginPassword = ref('');

            // UI state
            const loading = ref(false);
            const loadingText = ref('');
            const refreshing = ref(false);

            // Location state
            const locationStatus = ref('wait');
            const locationText = ref('');

            // Status steps
            const statusSteps = computed(() => [
                { status: 'pending', icon: '‚è≥', label: t('status_pending') },
                { status: 'accepted', icon: '‚úì', label: t('status_accepted') },
                { status: 'preparing', icon: 'üë®‚Äçüç≥', label: t('status_preparing') },
                { status: 'ready', icon: 'üçΩÔ∏è', label: t('status_ready') }
            ]);

            // Computed
            const cartTotalQty = computed(() => {
                return cart.value.reduce((sum, item) => sum + item.qty, 0);
            });

            const cartTotalAmount = computed(() => {
                return cart.value.reduce((sum, item) => sum + item.price * item.qty, 0);
            });

            const filteredMerchants = computed(() => {
                if (!searchQuery.value) return merchants.value;
                const q = searchQuery.value.toLowerCase();
                return merchants.value.filter(m => {
                    const nameMatch = m.name?.toLowerCase().includes(q);
                    const nameEnMatch = m.nameEn?.toLowerCase().includes(q);
                    const menuMatch = m.menu?.some(item => item.name?.toLowerCase().includes(q));
                    return nameMatch || nameEnMatch || menuMatch;
                });
            });

            const orderStatusTitle = computed(() => {
                const status = currentOrder.value?.status || 'pending';
                const map = {
                    pending: t('order_pending'),
                    accepted: t('order_accepted'),
                    preparing: t('order_preparing'),
                    ready: t('order_ready')
                };
                return map[status] || t('order_pending');
            });

            const orderProgress = computed(() => {
                const status = currentOrder.value?.status || 'pending';
                const map = { pending: 0, accepted: 33, preparing: 66, ready: 100 };
                return map[status] || 0;
            });

            function statusStepClass(stepStatus) {
                const status = currentOrder.value?.status || 'pending';
                const order = ['pending', 'accepted', 'preparing', 'ready'];
                const stepIdx = order.indexOf(stepStatus);
                const currentIdx = order.indexOf(status);
                if (stepIdx < currentIdx) return 'done';
                if (stepIdx === currentIdx) return 'active';
                return '';
            }

            // ===== API =====
            async function apiCall(endpoint, options = {}) {
                const token = localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;

                const r = await fetch(API_BASE + endpoint, {
                    method: 'GET',
                    headers,
                    ...options
                });

                if (!r.ok) {
                    let err = {};
                    try { err = await r.json(); } catch (e) {}
                    throw new Error(err.error || err.message || 'Failed');
                }
                return r.json();
            }

            // ===== GPS =====
            function getGPS() {
                return new Promise((resolve) => {
                    if (!navigator.geolocation) return resolve(null);
                    navigator.geolocation.getCurrentPosition(
                        (p) => resolve({ lat: p.coords.latitude, lng: p.coords.longitude }),
                        () => resolve(null),
                        { enableHighAccuracy: true, timeout: 8000 }
                    );
                });
            }

            async function initUserLocation() {
                locationStatus.value = 'wait';
                locationText.value = t('locating');

                const loc = await getGPS();
                if (loc) {
                    userLoc.value = loc;
                    locationStatus.value = 'ok';
                    locationText.value = t('located') + ` (${loc.lat.toFixed(3)}, ${loc.lng.toFixed(3)})`;
                    if (map.value) {
                        map.value.setView([loc.lat, loc.lng], 14);
                    }
                    showUserMarker();
                } else {
                    userLoc.value = DEFAULT_CENTER;
                    locationStatus.value = 'fail';
                    locationText.value = t('location_fail');
                }
            }

            function refreshLocation() {
                initUserLocation().then(() => searchMerchants());
            }

            function showUserMarker() {
                if (!map.value || !userLoc.value) return;
                if (userLocMarker.value) {
                    map.value.removeLayer(userLocMarker.value);
                }
                userLocMarker.value = L.circleMarker([userLoc.value.lat, userLoc.value.lng], {
                    radius: 8,
                    fillColor: '#ff6b35',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(map.value).bindPopup('üìç You');
            }

            // ===== Map =====
            function initMap() {
                if (map.value) return;
                const c = userLoc.value || DEFAULT_CENTER;
                map.value = L.map('map').setView([c.lat, c.lng], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map.value);
            }

            function updateMapMarkers() {
                markers.value.forEach(m => map.value.removeLayer(m));
                markers.value = [];

                merchants.value.forEach(m => {
                    const icon = TYPE_ICON[m.type] || 'üì¶';
                    const divIcon = L.divIcon({
                        html: `<div style="font-size:26px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3));">${icon}</div>`,
                        className: '',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });
                    const mk = L.marker([m.lat, m.lng], { icon: divIcon }).addTo(map.value);
                    mk.bindPopup(`<div class="popup-rich">
                        <div class="pr-name">${icon} ${m.name}</div>
                        <div class="pr-type">${typeName(m.type)}</div>
                        <div class="pr-stars">${'‚òÖ'.repeat(Math.round(m.rating))}${'‚òÜ'.repeat(5 - Math.round(m.rating))} ${m.rating}</div>
                        <div class="pr-dist">üìç ${m.distance || '?'}km</div>
                        <button class="pr-action" onclick="window.scrollToMerchant(${m.id})">${t('view_menu')}</button>
                    </div>`);
                    markers.value.push(mk);
                });

                if (merchants.value.length) {
                    const group = L.featureGroup(markers.value);
                    if (userLocMarker.value) group.addLayer(userLocMarker.value);
                    map.value.fitBounds(group.getBounds().pad(0.15));
                }
                showUserMarker();
            }

            // Expose scrollToMerchant globally for popup button
            window.scrollToMerchant = function(id) {
                expandedMenus.value.push(id);
                nextTick(() => {
                    const el = document.querySelector(`.merchant-card:nth-child(${merchants.value.findIndex(m => m.id === id) + 1})`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            };

            // ===== Mock Data =====
            function getMockMerchants() {
                return [
                    {
                        id: 1, name: 'Â∑ùÂë≥Â∞èÈ¶Ü', nameEn: 'Sichuan Kitchen', type: 'food_truck',
                        lat: -43.529, lng: 172.638, rating: 4.5, reviewCount: 28, distance: 0.5,
                        status: 'online', phone: '+64 21 123 456', address: 'Cathedral Square',
                        menu: [
                            { name: 'È∫ªÂ©ÜË±ÜËÖê Mapo Tofu', price: 18 },
                            { name: 'ÂÆ´‰øùÈ∏°‰∏Å Kung Pao Chicken', price: 22 },
                            { name: 'ÈÖ∏Ëæ£Ê±§ Hot & Sour Soup', price: 10 }
                        ]
                    },
                    {
                        id: 2, name: 'ÂØøÂè∏Â§™ÈÉé', nameEn: 'Sushi Taro', type: 'food_truck',
                        lat: -43.535, lng: 172.634, rating: 4.8, reviewCount: 56, distance: 0.8,
                        status: 'online', phone: '+64 21 234 567', address: 'Riccarton',
                        menu: [
                            { name: '‰∏âÊñáÈ±ºÂà∫Ë∫´ Salmon Sashimi', price: 28 },
                            { name: 'È≥óÈ±ºÂØøÂè∏ Eel Sushi', price: 15 }
                        ]
                    },
                    {
                        id: 3, name: 'ÂíñÂï°Â∞èÈïá', nameEn: 'Coffee Town', type: 'cafe',
                        lat: -43.533, lng: 172.635, rating: 4.6, reviewCount: 42, distance: 0.3,
                        status: 'online', phone: '+64 21 345 678', address: 'New Regent Street',
                        menu: [
                            { name: 'ÊãøÈìÅ Latte', price: 6 },
                            { name: 'Âç°Â∏ÉÂ•áËØ∫ Cappuccino', price: 6.5 },
                            { name: 'ÁâõËßíÂåÖ Croissant', price: 5 }
                        ]
                    },
                    {
                        id: 4, name: 'ÁîúËúúÊó∂ÂÖâ', nameEn: 'Sweet Time', type: 'bakery',
                        lat: -43.531, lng: 172.637, rating: 4.7, reviewCount: 33, distance: 0.4,
                        status: 'online', phone: '+64 21 456 789', address: 'Colombo Street',
                        menu: [
                            { name: 'Ê≥ïÂºèÂèØÈ¢Ç Croissant', price: 5.5 },
                            { name: 'Â∑ßÂÖãÂäõËõãÁ≥ï Chocolate Cake', price: 12 },
                            { name: 'ËÇâÊ°ÇÂç∑ Cinnamon Roll', price: 7 }
                        ]
                    }
                ];
            }

            // ===== Search =====
            async function searchMerchants() {
                loading.value = true;
                loadingText.value = t('searching');
                const loc = userLoc.value || DEFAULT_CENTER;

                try {
                    const data = await apiCall(`/merchants/nearby?lat=${loc.lat}&lng=${loc.lng}&radius=10`);
                    merchants.value = data.merchants || [];
                    if (!merchants.value.length) throw new Error('empty');
                } catch (e) {
                    merchants.value = getMockMerchants().filter(m => m.status === 'online');
                }

                updateMapMarkers();
                loading.value = false;
            }

            async function onRefresh() {
                refreshing.value = true;
                await searchMerchants();
                refreshing.value = false;
            }

            function onSearch() {
                // Search is handled by filteredMerchants computed
            }

            // ===== Menu =====
            function toggleMenu(id) {
                const idx = expandedMenus.value.indexOf(id);
                if (idx > -1) {
                    expandedMenus.value.splice(idx, 1);
                } else {
                    expandedMenus.value.push(id);
                }
            }

            // ===== Cart =====
            function addToCart(merchantId, name, price) {
                const token = localStorage.getItem('token');
                if (!token) {
                    showLoginModal.value = true;
                    return;
                }

                if (currentMerchantId.value && currentMerchantId.value !== merchantId) {
                    const confirmMsg = currentLang.value === 'zh'
                        ? 'Ê∏ÖÁ©∫ÂΩìÂâçË¥≠Áâ©ËΩ¶Âπ∂Ê∑ªÂä†Êñ∞ÂïÜÊà∑ÁöÑËèúÂìÅÔºü'
                        : 'Clear cart and add items from different merchant?';
                    if (!confirm(confirmMsg)) return;
                    cart.value = [];
                }
                currentMerchantId.value = merchantId;

                const existing = cart.value.find(item => item.name === name && item.price === price);
                if (existing) {
                    existing.qty++;
                } else {
                    cart.value.push({ merchantId, name, price, qty: 1 });
                }

                saveCart();
                vant.showToast(t('added_to_cart'));
            }

            function updateCartQty(name, price, newQty) {
                const item = cart.value.find(i => i.name === name && i.price === price);
                if (!item) return;

                item.qty = newQty;
                if (item.qty <= 0) {
                    cart.value = cart.value.filter(i => i !== item);
                }

                saveCart();
            }

            function saveCart() {
                localStorage.setItem('cart', JSON.stringify(cart.value));
            }

            // ===== Order =====
            async function submitOrder() {
                if (!cart.value.length) {
                    vant.showToast(t('empty_cart_warning'));
                    return;
                }

                const token = localStorage.getItem('token');
                if (!token) {
                    showLoginModal.value = true;
                    return;
                }

                const items = cart.value.map(item => ({
                    name: item.name,
                    qty: item.qty,
                    price: item.price
                }));

                loading.value = true;
                loadingText.value = t('placing_order');

                try {
                    const data = await apiCall('/orders', {
                        method: 'POST',
                        body: JSON.stringify({
                            merchantId: currentMerchantId.value,
                            items,
                            pickupMethod: pickupMethod.value,
                            note: orderNote.value
                        })
                    });

                    cart.value = [];
                    currentMerchantId.value = null;
                    saveCart();
                    showCartPopup.value = false;

                    currentOrder.value = data.order;
                    showOrderPanel.value = true;

                    connectSSE(data.order.id);

                    vant.showToast(t('order_success'));
                } catch (e) {
                    vant.showToast.fail(e.message || (currentLang.value === 'zh' ? '‰∏ãÂçïÂ§±Ë¥•' : 'Order failed'));
                } finally {
                    loading.value = false;
                }
            }

            // ===== SSE =====
            function connectSSE(orderId) {
                if (sseConnection.value) {
                    sseConnection.value.close();
                }

                const token = localStorage.getItem('token');
                if (!token) return;

                sseConnection.value = new EventSource(`/api/orders/${orderId}/stream`);

                sseConnection.value.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'connected' || data.type === 'ping') return;

                        if (data.type === 'order_status_changed' || data.type === 'order_updated') {
                            const order = data.data || data.order;
                            if (order) {
                                currentOrder.value = order;
                            }
                        }
                    } catch (e) {
                        console.error('SSE parse error:', e);
                    }
                };

                sseConnection.value.onerror = function() {
                    console.log('SSE connection error, retrying...');
                };
            }

            // ===== Auth =====
            async function doLogin() {
                if (!loginPhone.value || !loginPassword.value) {
                    vant.showToast(currentLang.value === 'zh' ? 'ËØ∑Â°´ÂÜôÊâãÊú∫Âè∑ÂíåÂØÜÁ†Å' : 'Please fill in all fields');
                    return;
                }

                loading.value = true;
                loadingText.value = t('logging_in');

                try {
                    const data = await apiCall('/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({
                            phone: loginPhone.value,
                            password: loginPassword.value
                        })
                    });
                    localStorage.setItem('token', data.token);
                    showLoginModal.value = false;
                    vant.showToast(t('login_success'));
                } catch (e) {
                    vant.showToast.fail(e.message || (currentLang.value === 'zh' ? 'ÁôªÂΩïÂ§±Ë¥•' : 'Login failed'));
                } finally {
                    loading.value = false;
                }
            }

            async function doRegister() {
                if (!loginPhone.value || !loginPassword.value) {
                    vant.showToast(currentLang.value === 'zh' ? 'ËØ∑Â°´ÂÜôÊâãÊú∫Âè∑ÂíåÂØÜÁ†Å' : 'Please fill in all fields');
                    return;
                }

                if (loginPassword.value.length < 6) {
                    vant.showToast(currentLang.value === 'zh' ? 'ÂØÜÁ†ÅËá≥Â∞ë6‰Ωç' : 'Password min 6 chars');
                    return;
                }

                loading.value = true;
                loadingText.value = t('registering');

                try {
                    const data = await apiCall('/auth/register', {
                        method: 'POST',
                        body: JSON.stringify({
                            phone: loginPhone.value,
                            password: loginPassword.value
                        })
                    });
                    localStorage.setItem('token', data.token);
                    showLoginModal.value = false;
                    vant.showToast(t('register_success'));
                } catch (e) {
                    vant.showToast.fail(e.message || (currentLang.value === 'zh' ? 'Ê≥®ÂÜåÂ§±Ë¥•' : 'Registration failed'));
                } finally {
                    loading.value = false;
                }
            }

            // ===== Init =====
            onMounted(async () => {
                initMap();
                await initUserLocation();
                showUserMarker();
                searchMerchants();
            });

            // Watch cart changes
            watch(cart, () => {
                saveCart();
            }, { deep: true });

            return {
                // i18n
                t,
                currentLang,
                toggleLang,
                typeName,
                getTypeIcon,

                // Location
                locationStatus,
                locationText,
                refreshLocation,

                // Map
                initMap,

                // Search
                searchQuery,
                onSearch,

                // Merchants
                merchants,
                filteredMerchants,
                expandedMenus,
                toggleMenu,

                // UI
                loading,
                loadingText,
                refreshing,
                onRefresh,

                // Cart
                cart,
                cartTotalQty,
                cartTotalAmount,
                showCartPopup,
                pickupMethod,
                orderNote,
                addToCart,
                updateCartQty,

                // Order
                currentOrder,
                showOrderPanel,
                orderStatusTitle,
                orderProgress,
                statusSteps,
                statusStepClass,
                submitOrder,

                // Auth
                showLoginModal,
                isRegister,
                loginPhone,
                loginPassword,
                doLogin,
                doRegister
            };
        }
    });

    // Register all Vant components
    app.use(vant);
    app.mount('#app');
    </script>
</body>
</html>
