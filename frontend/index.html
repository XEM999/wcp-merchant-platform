<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NearBite â€” Discover Local Food</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸœ</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fafafa;
            --bg-card: #ffffff;
            --bg-input: #f3f4f6;
            --text: #111827;
            --text-2: #6b7280;
            --text-3: #9ca3af;
            --accent: #f97316;
            --accent-light: #fff7ed;
            --accent-dark: #ea580c;
            --green: #22c55e;
            --green-bg: #f0fdf4;
            --red: #ef4444;
            --red-bg: #fef2f2;
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --border: #e5e7eb;
            --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
            --shadow-lg: 0 4px 12px rgba(0,0,0,.1);
            --radius: 16px;
            --radius-sm: 10px;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }

        /* ===== Splash ===== */
        .splash {
            position:fixed; inset:0; z-index:99999;
            background: linear-gradient(160deg, #fff7ed 0%, #ffedd5 40%, #fed7aa 100%);
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            transition: opacity .5s, transform .5s;
        }
        .splash.hide { opacity:0; transform:scale(1.05); pointer-events:none; }
        .splash-logo { font-size:80px; animation: bounce 1s ease infinite alternate; }
        @keyframes bounce { to { transform:translateY(-8px); } }
        .splash-brand { font-size:36px; font-weight:900; color:#ea580c; margin-top:12px; letter-spacing:-1px; }
        .splash-tagline { font-size:14px; color:#9a3412; margin-top:6px; letter-spacing:1px; }
        .splash-loader { width:120px; height:3px; background:#fdba74; border-radius:4px; margin-top:40px; overflow:hidden; }
        .splash-loader::after { content:''; display:block; height:100%; width:40%; background:#ea580c; border-radius:4px; animation: slide .7s ease-in-out infinite; }
        @keyframes slide { 0%{transform:translateX(-100%);} 100%{transform:translateX(350%);} }

        /* ===== Header ===== */
        .app-header {
            position:sticky; top:0; z-index:500;
            background: rgba(255,255,255,.92);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 12px 16px;
            display:flex; align-items:center; justify-content:space-between;
            border-bottom: 1px solid var(--border);
        }
        .header-left { display:flex; align-items:center; gap:10px; }
        .header-logo { font-size:28px; }
        .header-brand { font-size:20px; font-weight:800; color:var(--accent-dark); letter-spacing:-.5px; }
        .lang-btn {
            padding:6px 12px; border:1px solid var(--border); border-radius:20px;
            background:white; font-size:12px; font-weight:600; cursor:pointer;
            color:var(--text-2); transition:all .2s;
        }
        .lang-btn:hover { border-color:var(--accent); color:var(--accent); }

        /* ===== Toast ===== */
        .toast-container {
            position:fixed; top:70px; left:50%; transform:translateX(-50%);
            z-index:9999; display:flex; flex-direction:column; gap:8px; pointer-events:none;
        }
        .toast {
            background:white; color:var(--text); padding:12px 20px;
            border-radius:var(--radius-sm); font-size:13px; font-weight:500;
            box-shadow:var(--shadow-lg); pointer-events:auto; max-width:90vw; text-align:center;
            animation: toastIn .3s ease, toastOut .3s ease 2.7s forwards;
        }
        .toast.success { border-left:4px solid var(--green); }
        .toast.error { border-left:4px solid var(--red); }
        .toast.info { border-left:4px solid var(--blue); }
        @keyframes toastIn { from{opacity:0;transform:translateY(-12px);}to{opacity:1;transform:translateY(0);} }
        @keyframes toastOut { to{opacity:0;transform:translateY(-12px);} }

        /* ===== Loading ===== */
        .loading-overlay { display:none; position:fixed; inset:0; background:rgba(255,255,255,.8); z-index:8000; justify-content:center; align-items:center; flex-direction:column; backdrop-filter:blur(4px); }
        .loading-overlay.active { display:flex; }
        .spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .6s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg);} }
        .loading-overlay .msg { margin-top:12px; font-size:13px; color:var(--text-2); }

        /* ===== Tab Nav ===== */
        .tab-nav {
            position:fixed; bottom:0; left:0; right:0;
            background:rgba(255,255,255,.95); backdrop-filter:blur(20px);
            border-top:1px solid var(--border);
            display:flex; z-index:1000; padding:6px 0 env(safe-area-inset-bottom, 4px);
        }
        .tab-btn {
            flex:1; padding:8px 0; background:none; border:none;
            color:var(--text-3); font-size:10px; font-weight:600; cursor:pointer;
            display:flex; flex-direction:column; align-items:center; gap:2px;
            transition:all .2s; position:relative;
        }
        .tab-btn .t-icon { font-size:22px; }
        .tab-btn.active { color:var(--accent); }
        .tab-btn.active::before {
            content:''; position:absolute; top:0; left:30%; right:30%;
            height:2px; border-radius:0 0 2px 2px; background:var(--accent);
        }

        /* ===== Pages ===== */
        .page { display:none; padding:16px; min-height:calc(100vh - 130px); animation:pageIn .3s ease; }
        .page.active { display:block; }
        @keyframes pageIn { from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;} }

        /* ===== Location Bar ===== */
        .location-bar {
            display:flex; align-items:center; gap:6px; margin-bottom:12px;
            font-size:12px; color:var(--text-2); font-weight:500;
        }
        .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
        .dot.ok { background:var(--green); box-shadow:0 0 6px rgba(34,197,94,.4); }
        .dot.wait { background:#f59e0b; animation:pulse 1s infinite; }
        .dot.fail { background:var(--red); }
        @keyframes pulse { 50%{opacity:.4;} }

        /* ===== Search ===== */
        .search-bar { display:flex; gap:8px; margin-bottom:16px; }
        .search-input {
            flex:1; padding:12px 16px; background:var(--bg-input);
            border:1px solid transparent; border-radius:var(--radius);
            font-size:14px; color:var(--text); transition:all .2s;
            font-family:inherit;
        }
        .search-input:focus { border-color:var(--accent); outline:none; background:white; box-shadow:0 0 0 3px rgba(249,115,22,.1); }
        .search-input::placeholder { color:var(--text-3); }
        .icon-btn {
            width:48px; height:48px; border:none; border-radius:var(--radius);
            display:flex; align-items:center; justify-content:center;
            font-size:18px; cursor:pointer; transition:transform .15s;
        }
        .icon-btn:active { transform:scale(.92); }
        .icon-btn.primary { background:var(--accent); color:white; }
        .icon-btn.secondary { background:var(--bg-input); color:var(--text-2); }

        /* ===== Map ===== */
        #map {
            height:240px; border-radius:var(--radius); margin-bottom:16px;
            border:1px solid var(--border); overflow:hidden; box-shadow:var(--shadow);
        }

        /* ===== Section ===== */
        .section-title { font-size:18px; font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
        .section-count { font-size:13px; font-weight:500; color:var(--text-3); }

        /* ===== Merchant Cards ===== */
        .merchant-list { display:flex; flex-direction:column; gap:12px; }
        .merchant-card {
            background:var(--bg-card); border-radius:var(--radius); padding:16px;
            border:1px solid var(--border); box-shadow:var(--shadow);
            transition:transform .2s, box-shadow .2s; cursor:pointer;
        }
        .merchant-card:active { transform:scale(.98); }
        .mc-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:4px; }
        .mc-name { font-size:16px; font-weight:700; display:flex; align-items:center; gap:8px; }
        .mc-icon { width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px; background:var(--accent-light); }
        .mc-dist { color:var(--accent); font-size:12px; font-weight:600; background:var(--accent-light); padding:4px 10px; border-radius:20px; white-space:nowrap; }
        .mc-meta { color:var(--text-2); font-size:12px; margin-bottom:8px; }
        .mc-rating { display:flex; align-items:center; gap:6px; margin-bottom:10px; }
        .mc-stars { color:#f59e0b; font-size:13px; letter-spacing:1px; }
        .mc-rating-num { color:var(--text); font-weight:700; font-size:14px; }
        .mc-rating-cnt { color:var(--text-3); font-size:12px; }
        .mc-actions { display:flex; gap:8px; }
        .mc-btn {
            padding:8px 14px; border:none; border-radius:8px;
            font-size:12px; font-weight:600; cursor:pointer; transition:transform .15s;
            font-family:inherit;
        }
        .mc-btn:active { transform:scale(.95); }
        .mc-btn.orange { background:var(--accent-light); color:var(--accent-dark); }
        .mc-btn.blue-light { background:#eff6ff; color:var(--blue); }
        .card-menu { display:none; margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
        .card-menu.show { display:block; animation:fadeIn .25s ease; }
        .card-menu-row { display:flex; justify-content:space-between; padding:8px 0; font-size:14px; border-bottom:1px solid #f3f4f6; }
        .card-menu-row:last-child { border-bottom:none; }
        .card-menu-row .price { color:var(--accent-dark); font-weight:700; }
        @keyframes fadeIn { from{opacity:0;}to{opacity:1;} }

        /* ===== Modal ===== */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:2000; padding:20px; overflow-y:auto; backdrop-filter:blur(4px); }
        .modal.active { display:flex; align-items:flex-start; justify-content:center; animation:fadeIn .25s; }
        .modal-content {
            background:white; border-radius:20px; padding:24px;
            max-width:500px; width:100%; margin-top:40px;
            box-shadow:0 20px 60px rgba(0,0,0,.15);
        }
        .modal-close {
            float:right; background:var(--bg-input); border:none;
            color:var(--text-2); font-size:18px; cursor:pointer;
            width:36px; height:36px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
        }
        .modal-close:hover { background:var(--border); }

        /* ===== Forms ===== */
        .form-group { margin-bottom:16px; }
        .form-label { display:block; margin-bottom:6px; color:var(--text-2); font-size:13px; font-weight:600; }
        .form-input, .form-select {
            width:100%; padding:12px 14px; background:var(--bg-input);
            border:1px solid transparent; border-radius:var(--radius-sm);
            color:var(--text); font-size:14px; transition:all .2s; font-family:inherit;
        }
        .form-input:focus, .form-select:focus { border-color:var(--accent); outline:none; background:white; box-shadow:0 0 0 3px rgba(249,115,22,.1); }
        .form-btn {
            width:100%; padding:14px; border:none; border-radius:var(--radius);
            font-size:15px; font-weight:600; cursor:pointer; margin-bottom:10px;
            transition:transform .15s; font-family:inherit;
        }
        .form-btn:active { transform:scale(.98); }
        .form-btn.primary { background:var(--accent); color:white; }
        .form-btn.secondary { background:var(--bg-input); color:var(--text-2); }
        .form-btn.green { background:var(--green); color:white; }
        .form-btn.red { background:var(--red); color:white; }

        /* ===== Seller ===== */
        .seller-header {
            display:flex; align-items:center; gap:14px; margin-bottom:20px; padding:20px;
            background:white; border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow);
        }
        .sh-icon { width:56px; height:56px; border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:32px; background:var(--accent-light); }
        .sh-name { font-size:18px; font-weight:700; }
        .sh-type { font-size:12px; color:var(--text-2); margin-top:2px; }

        .status-badge {
            display:inline-flex; align-items:center; gap:6px;
            padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600;
        }
        .status-badge.online { background:var(--green-bg); color:var(--green); }
        .status-badge.offline { background:var(--bg-input); color:var(--text-3); }

        .toggle-btn {
            width:100%; padding:20px; border:none; border-radius:var(--radius);
            font-size:17px; font-weight:700; cursor:pointer; margin-bottom:24px;
            transition:all .3s; font-family:inherit;
        }
        .toggle-btn.go-online { background:var(--green); color:white; box-shadow:0 4px 12px rgba(34,197,94,.3); }
        .toggle-btn.go-offline { background:var(--red); color:white; box-shadow:0 4px 12px rgba(239,68,68,.3); }
        .toggle-btn:active { transform:scale(.98); }

        .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px; }
        .stat-card {
            background:white; border-radius:var(--radius); padding:20px; text-align:center;
            border:1px solid var(--border); box-shadow:var(--shadow);
        }
        .stat-val { font-size:28px; font-weight:800; }
        .stat-val.green { color:var(--green); }
        .stat-val.orange { color:var(--accent); }
        .stat-label { font-size:11px; color:var(--text-3); margin-top:4px; text-transform:uppercase; letter-spacing:.5px; font-weight:600; }

        .menu-count { font-size:13px; color:var(--text-2); margin-bottom:10px; }
        .menu-count span { color:var(--accent); font-weight:700; }

        .menu-item {
            display:flex; justify-content:space-between; align-items:center;
            padding:14px; background:white; border-radius:var(--radius-sm); margin-bottom:8px;
            border:1px solid var(--border);
        }
        .menu-item-name { font-size:14px; font-weight:600; }
        .menu-item-price { color:var(--accent-dark); font-size:14px; font-weight:700; }
        .menu-item-delete { background:none; border:none; color:var(--red); cursor:pointer; padding:8px; font-size:16px; }

        .add-menu-form { display:flex; gap:8px; margin-top:16px; }
        .add-menu-form input { flex:1; }
        .add-menu-form button {
            padding:12px 20px; background:var(--accent); border:none;
            border-radius:var(--radius-sm); color:white; cursor:pointer; font-weight:600; font-family:inherit;
        }

        /* ===== Reviews ===== */
        .star-select { display:flex; gap:6px; justify-content:center; margin:16px 0; }
        .star-select .s { font-size:36px; cursor:pointer; color:#d1d5db; transition:all .15s; }
        .star-select .s.on { color:#f59e0b; }
        .star-select .s:hover { transform:scale(1.15); }
        .review-textarea {
            width:100%; min-height:80px; padding:12px; background:var(--bg-input);
            border:1px solid transparent; border-radius:var(--radius-sm);
            color:var(--text); font-size:14px; resize:vertical; margin-bottom:16px; font-family:inherit;
        }
        .review-textarea:focus { border-color:var(--accent); outline:none; background:white; }

        .review-card {
            padding:14px; background:var(--bg-input); border-radius:var(--radius-sm); margin-bottom:8px;
        }
        .rc-stars { color:#f59e0b; font-size:13px; margin-bottom:4px; }
        .rc-text { color:var(--text-2); font-size:13px; line-height:1.5; }

        .gps-hint {
            display:flex; align-items:center; gap:6px; padding:12px 14px;
            background:#fff7ed; border-radius:var(--radius-sm); margin-bottom:16px;
            font-size:12px; color:var(--accent-dark); font-weight:500;
        }

        /* ===== Empty state ===== */
        .empty-state { text-align:center; padding:40px 20px; color:var(--text-3); }
        .empty-state .em-icon { font-size:48px; margin-bottom:12px; }
        .empty-state .em-text { font-size:14px; }

        /* ===== Leaflet overrides ===== */
        .leaflet-popup-content-wrapper { border-radius:12px!important; box-shadow:var(--shadow-lg)!important; }
        .leaflet-popup-content { margin:12px 16px!important; font-family:'Inter',sans-serif!important; }
        .popup-rich .pr-name { font-size:14px; font-weight:700; margin-bottom:2px; }
        .popup-rich .pr-type { font-size:12px; color:var(--text-2); margin-bottom:4px; }
        .popup-rich .pr-stars { color:#f59e0b; font-size:12px; margin-bottom:4px; }
        .popup-rich .pr-dist { font-size:12px; color:var(--accent); font-weight:600; }

        .footer-ver { position:fixed; bottom:56px; left:0; right:0; text-align:center; font-size:10px; color:var(--text-3); padding:4px; }
    </style>
</head>
<body>
    <!-- Splash -->
    <div class="splash" id="splash">
        <div class="splash-logo">ğŸœ</div>
        <div class="splash-brand">NearBite</div>
        <div class="splash-tagline" data-i18n="splash_tagline">å‘ç°èº«è¾¹çš„å¥½å‘³é“</div>
        <div class="splash-loader"></div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="msg" id="loadingMsg">Loading...</div>
    </div>

    <div class="toast-container" id="toastBox"></div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <span class="header-logo">ğŸœ</span>
            <span class="header-brand">NearBite</span>
        </div>
        <button class="lang-btn" id="langBtn" onclick="toggleLang()">EN</button>
    </header>

    <!-- Tab Nav -->
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="buyer">
            <span class="t-icon">ğŸ”</span><span data-i18n="tab_discover">å‘ç°</span>
        </button>
        <button class="tab-btn" data-tab="seller">
            <span class="t-icon">ğŸª</span><span data-i18n="tab_merchant">å•†æˆ·</span>
        </button>
    </nav>

    <!-- ===== Buyer Page ===== -->
    <div id="buyer-page" class="page active">
        <div class="location-bar" id="locBar">
            <span class="dot wait" id="locDot"></span>
            <span id="locText" data-i18n="loc_loading">æ­£åœ¨è·å–ä½ç½®â€¦</span>
        </div>

        <div class="search-bar">
            <input type="text" class="search-input" id="search-input" data-i18n-placeholder="search_placeholder" placeholder="æœç´¢å•†æˆ·æˆ–èœå“...">
            <button class="icon-btn primary" onclick="searchMerchants()">ğŸ”</button>
            <button class="icon-btn secondary" onclick="refreshNearby()">ğŸ”„</button>
        </div>

        <div id="map"></div>

        <h3 class="section-title">
            <span data-i18n="nearby_title">é™„è¿‘å•†æˆ·</span>
            <span class="section-count" id="merchantCount"></span>
        </h3>
        <div class="merchant-list" id="merchant-list"></div>
    </div>

    <!-- ===== Seller Page ===== -->
    <div id="seller-page" class="page">
        <div id="seller-login">
            <div style="text-align:center;margin-bottom:32px;">
                <div style="font-size:48px;margin-bottom:8px;">ğŸª</div>
                <h2 class="section-title" style="justify-content:center;" data-i18n="seller_login_title">å•†å®¶ç™»å½•</h2>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="label_phone">æ‰‹æœºå·</label>
                <input type="tel" class="form-input" id="login-phone" data-i18n-placeholder="ph_phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="label_password">å¯†ç </label>
                <input type="password" class="form-input" id="login-password" data-i18n-placeholder="ph_password" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button class="form-btn primary" onclick="doLogin()" data-i18n="btn_login">ç™»å½•</button>
            <button class="form-btn secondary" onclick="doRegisterAccount()" data-i18n="btn_register">æ³¨å†Œæ–°è´¦å·</button>
        </div>

        <div id="register-merchant" style="display:none;">
            <div style="text-align:center;margin-bottom:24px;">
                <div style="font-size:48px;margin-bottom:8px;">ğŸ“</div>
                <h2 class="section-title" style="justify-content:center;" data-i18n="reg_title">æ³¨å†Œå•†æˆ·</h2>
                <p style="color:var(--text-2);font-size:13px;" data-i18n="reg_subtitle">è¯·å¡«å†™å•†æˆ·ä¿¡æ¯å®Œæˆæ³¨å†Œ</p>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="label_shop_name">å•†æˆ·åç§°</label>
                <input type="text" class="form-input" id="reg-name" data-i18n-placeholder="ph_shop_name" placeholder="ä¾‹å¦‚ï¼šå·å‘³å°é¦†">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="label_type">å•†æˆ·ç±»å‹</label>
                <select class="form-select" id="reg-type">
                    <option value="food_truck" data-i18n="type_food_truck">ğŸšš é¤è½¦ Food Truck</option>
                    <option value="cafe" data-i18n="type_cafe">â˜• å’–å•¡å… Cafe</option>
                    <option value="bakery" data-i18n="type_bakery">ğŸ é¢åŒ…åº— Bakery</option>
                    <option value="other" data-i18n="type_other">ğŸ“¦ å…¶ä»– Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="label_contact_phone">è”ç³»ç”µè¯</label>
                <input type="tel" class="form-input" id="reg-phone" placeholder="+64 ...">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="label_address">åœ°å€æè¿°</label>
                <input type="text" class="form-input" id="reg-address" data-i18n-placeholder="ph_address" placeholder="ä¾‹å¦‚ï¼šåŸºç£åŸå¸‚ä¸­å¿ƒå¹¿åœºæ—">
            </div>
            <div class="gps-hint">ğŸ“ <span data-i18n="gps_hint">æ³¨å†Œæ—¶å°†è‡ªåŠ¨è·å–æ‚¨çš„GPSå®šä½ä½œä¸ºå•†æˆ·ä½ç½®</span></div>
            <button class="form-btn green" onclick="registerMerchant()" data-i18n="btn_reg_merchant">âœ… æ³¨å†Œå•†æˆ·</button>
            <button class="form-btn secondary" onclick="cancelRegister()" data-i18n="btn_back">è¿”å›</button>
        </div>

        <div id="seller-panel" style="display:none;">
            <div class="seller-header">
                <div class="sh-icon" id="shIcon">ğŸª</div>
                <div>
                    <div class="sh-name" id="shName">å•†æˆ·åç§°</div>
                    <div class="sh-type" id="shType">ç±»å‹</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-val green" id="statOrders">0</div>
                    <div class="stat-label" data-i18n="stat_orders">ä»Šæ—¥è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val orange" id="statRevenue">$0</div>
                    <div class="stat-label" data-i18n="stat_revenue">ä»Šæ—¥æ”¶å…¥</div>
                </div>
            </div>

            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <div class="status-badge" id="status-badge" data-i18n="status_offline">ç¦»çº¿</div>
            </div>
            <button class="toggle-btn go-online" id="toggle-btn" onclick="toggleStatus()" data-i18n="btn_go_online">ğŸŸ¢ ä¸Šçº¿è¥ä¸š</button>

            <h3 class="section-title" data-i18n="menu_title">ğŸ“‹ èœå•ç®¡ç†</h3>
            <div class="menu-count" id="menuCount"></div>
            <div id="menu-list"></div>

            <div class="add-menu-form">
                <input type="text" class="form-input" id="new-menu-name" data-i18n-placeholder="ph_dish_name" placeholder="èœå“åç§°">
                <input type="number" class="form-input" id="new-menu-price" data-i18n-placeholder="ph_price" placeholder="ä»·æ ¼" style="width:80px;">
                <button onclick="addMenuItem()" data-i18n="btn_add">æ·»åŠ </button>
            </div>

            <button class="form-btn secondary" style="margin-top:24px;" onclick="logout()" data-i18n="btn_logout">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- Merchant Detail Modal -->
    <div class="modal" id="merchant-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modal-icon" style="font-size:48px;text-align:center;margin-bottom:8px;"></div>
            <h2 id="modal-name" style="font-size:20px;font-weight:700;text-align:center;margin-bottom:4px;"></h2>
            <p id="modal-type" style="color:var(--text-2);text-align:center;margin-bottom:6px;font-size:13px;"></p>
            <p id="modal-rating" style="color:#f59e0b;text-align:center;margin-bottom:6px;font-size:15px;"></p>
            <p id="modal-addr" style="color:var(--text-2);text-align:center;font-size:12px;margin-bottom:2px;"></p>
            <p id="modal-phone" style="color:var(--text-2);text-align:center;font-size:12px;margin-bottom:20px;"></p>
            <h3 class="section-title" data-i18n="detail_menu">ğŸ“‹ èœå•</h3>
            <div id="modal-menu"></div>
            <h3 class="section-title" style="margin-top:20px;" data-i18n="detail_reviews">ğŸ’¬ è¯„ä»·</h3>
            <div id="modal-reviews"></div>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal" id="review-modal">
        <div class="modal-content" style="text-align:center;">
            <button class="modal-close" onclick="closeReview()">&times;</button>
            <h2 class="section-title" style="justify-content:center;" data-i18n="write_review">â­ å†™è¯„ä»·</h2>
            <p id="review-for" style="color:var(--text-2);margin-bottom:16px;"></p>
            <div class="star-select" id="starSelect">
                <span class="s" data-v="1">â˜…</span><span class="s" data-v="2">â˜…</span>
                <span class="s" data-v="3">â˜…</span><span class="s" data-v="4">â˜…</span>
                <span class="s" data-v="5">â˜…</span>
            </div>
            <textarea class="review-textarea" id="review-text" data-i18n-placeholder="ph_review" placeholder="åˆ†äº«æ‚¨çš„ä½“éªŒâ€¦"></textarea>
            <button class="form-btn green" onclick="submitReview()" data-i18n="btn_submit_review">æäº¤è¯„ä»·</button>
        </div>
    </div>

    <div class="footer-ver">NearBite v0.3.0</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    /* ===== i18n ===== */
    const LANG = {
        zh: {
            splash_tagline: 'å‘ç°èº«è¾¹çš„å¥½å‘³é“',
            tab_discover: 'å‘ç°', tab_merchant: 'å•†æˆ·',
            loc_loading: 'æ­£åœ¨è·å–ä½ç½®â€¦', loc_ok: 'ğŸ“ å·²å®šä½', loc_fail: 'å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®',
            search_placeholder: 'æœç´¢å•†æˆ·æˆ–èœå“...',
            nearby_title: 'é™„è¿‘å•†æˆ·', merchant_count: '{n} å®¶',
            seller_login_title: 'å•†å®¶ç™»å½•',
            label_phone: 'æ‰‹æœºå·', label_password: 'å¯†ç ',
            ph_phone: 'è¯·è¾“å…¥æ‰‹æœºå·', ph_password: 'è¯·è¾“å…¥å¯†ç ',
            btn_login: 'ç™»å½•', btn_register: 'æ³¨å†Œæ–°è´¦å·',
            reg_title: 'æ³¨å†Œå•†æˆ·', reg_subtitle: 'è¯·å¡«å†™å•†æˆ·ä¿¡æ¯å®Œæˆæ³¨å†Œ',
            label_shop_name: 'å•†æˆ·åç§°', label_type: 'å•†æˆ·ç±»å‹',
            label_contact_phone: 'è”ç³»ç”µè¯', label_address: 'åœ°å€æè¿°',
            ph_shop_name: 'ä¾‹å¦‚ï¼šå·å‘³å°é¦†', ph_address: 'ä¾‹å¦‚ï¼šåŸºç£åŸå¸‚ä¸­å¿ƒå¹¿åœºæ—',
            gps_hint: 'æ³¨å†Œæ—¶å°†è‡ªåŠ¨è·å–æ‚¨çš„GPSå®šä½ä½œä¸ºå•†æˆ·ä½ç½®',
            btn_reg_merchant: 'âœ… æ³¨å†Œå•†æˆ·', btn_back: 'è¿”å›',
            stat_orders: 'ä»Šæ—¥è®¢å•', stat_revenue: 'ä»Šæ—¥æ”¶å…¥',
            status_online: 'ğŸŸ¢ åœ¨çº¿è¥ä¸šä¸­', status_offline: 'â¸ï¸ ç¦»çº¿',
            btn_go_online: 'ğŸŸ¢ ä¸Šçº¿è¥ä¸š', btn_go_offline: 'ğŸ”´ åœæ­¢è¥ä¸š',
            menu_title: 'ğŸ“‹ èœå•ç®¡ç†', menu_count: 'å½“å‰èœå“ï¼š{n} é“',
            ph_dish_name: 'èœå“åç§°', ph_price: 'ä»·æ ¼', btn_add: 'æ·»åŠ ',
            btn_logout: 'é€€å‡ºç™»å½•',
            detail_menu: 'ğŸ“‹ èœå•', detail_reviews: 'ğŸ’¬ è¯„ä»·',
            write_review: 'â­ å†™è¯„ä»·', ph_review: 'åˆ†äº«æ‚¨çš„ä½“éªŒâ€¦',
            btn_submit_review: 'æäº¤è¯„ä»·',
            no_menu: 'æš‚æ— èœå•', no_reviews: 'æš‚æ— è¯„ä»·',
            toast_refreshed: 'å·²åˆ·æ–°', toast_login_ok: 'ç™»å½•æˆåŠŸ',
            toast_reg_ok: 'å•†æˆ·æ³¨å†ŒæˆåŠŸ ğŸ‰', toast_added: 'å·²æ·»åŠ  âœ…',
            toast_deleted: 'å·²åˆ é™¤', toast_review_ok: 'è¯„ä»·å·²æäº¤ âœ…',
            toast_online: 'å·²ä¸Šçº¿è¥ä¸š âœ…', toast_offline: 'å·²ä¸‹çº¿ â¸ï¸',
            toast_logout: 'å·²é€€å‡ºç™»å½•',
            type_food_truck: 'ğŸšš é¤è½¦', type_cafe: 'â˜• å’–å•¡å…', type_bakery: 'ğŸ é¢åŒ…åº—', type_other: 'ğŸ“¦ å…¶ä»–',
            empty_nearby: 'é™„è¿‘æ²¡æœ‰åœ¨çº¿å•†æˆ·',
        },
        en: {
            splash_tagline: 'Discover local food near you',
            tab_discover: 'Discover', tab_merchant: 'Merchant',
            loc_loading: 'Getting locationâ€¦', loc_ok: 'ğŸ“ Located', loc_fail: 'Location failed, using default',
            search_placeholder: 'Search merchants or dishes...',
            nearby_title: 'Nearby', merchant_count: '{n} found',
            seller_login_title: 'Merchant Login',
            label_phone: 'Phone', label_password: 'Password',
            ph_phone: 'Enter phone number', ph_password: 'Enter password',
            btn_login: 'Login', btn_register: 'Create Account',
            reg_title: 'Register Merchant', reg_subtitle: 'Fill in your business info to get started',
            label_shop_name: 'Business Name', label_type: 'Business Type',
            label_contact_phone: 'Contact Phone', label_address: 'Address',
            ph_shop_name: 'e.g. Mike\'s Food Truck', ph_address: 'e.g. Cathedral Square, Christchurch',
            gps_hint: 'Your GPS location will be used as your business location',
            btn_reg_merchant: 'âœ… Register', btn_back: 'Back',
            stat_orders: 'Orders Today', stat_revenue: 'Revenue Today',
            status_online: 'ğŸŸ¢ Open', status_offline: 'â¸ï¸ Closed',
            btn_go_online: 'ğŸŸ¢ Go Online', btn_go_offline: 'ğŸ”´ Go Offline',
            menu_title: 'ğŸ“‹ Menu', menu_count: '{n} items',
            ph_dish_name: 'Dish name', ph_price: 'Price', btn_add: 'Add',
            btn_logout: 'Logout',
            detail_menu: 'ğŸ“‹ Menu', detail_reviews: 'ğŸ’¬ Reviews',
            write_review: 'â­ Write Review', ph_review: 'Share your experienceâ€¦',
            btn_submit_review: 'Submit Review',
            no_menu: 'No menu items yet', no_reviews: 'No reviews yet',
            toast_refreshed: 'Refreshed', toast_login_ok: 'Login successful',
            toast_reg_ok: 'Merchant registered ğŸ‰', toast_added: 'Added âœ…',
            toast_deleted: 'Deleted', toast_review_ok: 'Review submitted âœ…',
            toast_online: 'You are now online âœ…', toast_offline: 'You are now offline â¸ï¸',
            toast_logout: 'Logged out',
            type_food_truck: 'ğŸšš Food Truck', type_cafe: 'â˜• Cafe', type_bakery: 'ğŸ Bakery', type_other: 'ğŸ“¦ Other',
            empty_nearby: 'No merchants nearby',
        }
    };

    let currentLang = localStorage.getItem('lang') || 'zh';

    function t(key, vars) {
        let s = (LANG[currentLang] && LANG[currentLang][key]) || (LANG.zh[key]) || key;
        if (vars) Object.keys(vars).forEach(k => s = s.replace(`{${k}}`, vars[k]));
        return s;
    }

    function applyLang() {
        document.getElementById('langBtn').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­æ–‡';
        document.querySelectorAll('[data-i18n]').forEach(el => {
            el.textContent = t(el.dataset.i18n);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            el.placeholder = t(el.dataset.i18nPlaceholder);
        });
    }

    function toggleLang() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        localStorage.setItem('lang', currentLang);
        applyLang();
        if (merchants.length) renderMerchants();
    }

    /* ===== Config ===== */
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? '/api' : '/api';
    const DEFAULT_CENTER = { lat: -43.532, lng: 172.636 };
    const TYPE_ICON = { food_truck:'ğŸšš', cafe:'â˜•', bakery:'ğŸ', other:'ğŸ“¦' };

    function typeName(type) {
        const key = 'type_' + type;
        return t(key) || type;
    }

    /* ===== State ===== */
    let map = null, markers = [], merchants = [], currentMerchant = null;
    let menuItems = [], userLoc = null, userLocMarker = null;
    let reviewMerchantId = null, selectedStars = 0;

    /* ===== Splash ===== */
    setTimeout(() => { const sp=document.getElementById('splash'); sp.classList.add('hide'); setTimeout(()=>sp.remove(),500); }, 1200);

    /* ===== Toast ===== */
    function toast(msg, type='info') {
        const el=document.createElement('div'); el.className='toast '+type; el.textContent=msg;
        document.getElementById('toastBox').appendChild(el); setTimeout(()=>el.remove(),3200);
    }

    function showLoading(msg) { document.getElementById('loadingMsg').textContent=msg||'...'; document.getElementById('loadingOverlay').classList.add('active'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }

    /* ===== GPS ===== */
    function getGPS() {
        return new Promise(r => {
            if(!navigator.geolocation) return r(null);
            navigator.geolocation.getCurrentPosition(p=>r({lat:p.coords.latitude,lng:p.coords.longitude}),()=>r(null),{enableHighAccuracy:true,timeout:8000});
        });
    }

    async function initUserLocation() {
        const dot=document.getElementById('locDot'), txt=document.getElementById('locText');
        dot.className='dot wait'; txt.textContent=t('loc_loading');
        const loc=await getGPS();
        if(loc) { userLoc=loc; dot.className='dot ok'; txt.textContent=t('loc_ok')+` (${loc.lat.toFixed(3)}, ${loc.lng.toFixed(3)})`; if(map)map.setView([loc.lat,loc.lng],14); showUserMarker(); }
        else { userLoc=DEFAULT_CENTER; dot.className='dot fail'; txt.textContent=t('loc_fail'); }
    }

    function showUserMarker() {
        if(!map||!userLoc)return;
        if(userLocMarker)map.removeLayer(userLocMarker);
        userLocMarker=L.circleMarker([userLoc.lat,userLoc.lng],{radius:8,fillColor:'#f97316',color:'#fff',weight:2,fillOpacity:1}).addTo(map).bindPopup('ğŸ“ You');
    }

    /* ===== Tabs ===== */
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab+'-page').classList.add('active');
            if(btn.dataset.tab==='buyer'&&map) setTimeout(()=>map.invalidateSize(),120);
        });
    });

    /* ===== Map ===== */
    function initMap() {
        if(map)return;
        const c=userLoc||DEFAULT_CENTER;
        map=L.map('map').setView([c.lat,c.lng],14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
    }

    /* ===== API ===== */
    async function apiCall(endpoint, options={}) {
        const token=localStorage.getItem('token');
        const headers={'Content-Type':'application/json'};
        if(token) headers['Authorization']='Bearer '+token;
        const r=await fetch(API_BASE+endpoint, {...options, headers:{...headers,...options.headers}});
        if(!r.ok) { const err=await r.json().catch(()=>({})); throw new Error(err.error||err.message||'Failed'); }
        return r.json();
    }

    /* ===== Stars ===== */
    function starsStr(r) { const f=Math.round(r); return 'â˜…'.repeat(f)+'â˜†'.repeat(5-f); }

    /* ===== Mock Data ===== */
    function getMockMerchants() {
        return [
            {id:1,name:'å·å‘³å°é¦†',nameEn:'Sichuan Kitchen',type:'food_truck',lat:-43.529,lng:172.638,rating:4.5,reviewCount:28,distance:0.5,status:'online',phone:'+64 21 123 456',address:'Cathedral Square',
             menu:[{name:'éº»å©†è±†è… Mapo Tofu',price:18},{name:'å®«ä¿é¸¡ä¸ Kung Pao Chicken',price:22},{name:'é…¸è¾£æ±¤ Hot & Sour Soup',price:10}],
             reviews:[{stars:5,text:'å‘³é“è¶…æ­£å®—ï¼Amazing authentic taste!'},{stars:4,text:'Kung Pao Chicken is great'}]},
            {id:2,name:'å¯¿å¸å¤ªéƒ',nameEn:'Sushi Taro',type:'food_truck',lat:-43.535,lng:172.634,rating:4.8,reviewCount:56,distance:0.8,status:'online',phone:'+64 21 234 567',address:'Riccarton',
             menu:[{name:'ä¸‰æ–‡é±¼åˆºèº« Salmon Sashimi',price:28},{name:'é³—é±¼å¯¿å¸ Eel Sushi',price:15}],
             reviews:[{stars:5,text:'Super fresh! æ¨è'}]},
            {id:4,name:'å’–å•¡å°é•‡',nameEn:'Coffee Town',type:'cafe',lat:-43.533,lng:172.635,rating:4.6,reviewCount:42,distance:0.3,status:'online',phone:'+64 21 345 678',address:'New Regent Street',
             menu:[{name:'æ‹¿é“ Latte',price:6},{name:'å¡å¸ƒå¥‡è¯º Cappuccino',price:6.5},{name:'ç‰›è§’åŒ… Croissant',price:5}],
             reviews:[{stars:5,text:'Best latte in town!'}]},
            {id:5,name:'ç”œèœœæ—¶å…‰',nameEn:'Sweet Time',type:'bakery',lat:-43.531,lng:172.637,rating:4.7,reviewCount:33,distance:0.4,status:'online',phone:'+64 21 456 789',address:'Colombo Street',
             menu:[{name:'æ³•å¼å¯é¢‚ Croissant',price:5.5},{name:'å·§å…‹åŠ›è›‹ç³• Chocolate Cake',price:12},{name:'è‚‰æ¡‚å· Cinnamon Roll',price:7}],
             reviews:[{stars:5,text:'è‚‰æ¡‚å·ç»äº†ï¼Cinnamon rolls are incredible!'}]}
        ];
    }

    /* ===== Search / Refresh ===== */
    async function searchMerchants() {
        showLoading(currentLang==='zh'?'æœç´¢ä¸­â€¦':'Searchingâ€¦');
        const loc=userLoc||DEFAULT_CENTER;
        try {
            const data=await apiCall(`/merchants/nearby?lat=${loc.lat}&lng=${loc.lng}&radius=10`);
            merchants=data.merchants||[];
            if(!merchants.length) throw new Error('empty');
        } catch(e) {
            merchants=getMockMerchants().filter(m=>m.status==='online');
        }
        renderMerchants();
        updateMapMarkers();
        hideLoading();
    }

    async function refreshNearby() {
        showLoading(currentLang==='zh'?'åˆ·æ–°ä½ç½®â€¦':'Refreshingâ€¦');
        await initUserLocation();
        hideLoading();
        await searchMerchants();
        toast(t('toast_refreshed'),'success');
    }

    /* ===== Render ===== */
    function renderMerchants() {
        const list=document.getElementById('merchant-list');
        document.getElementById('merchantCount').textContent = t('merchant_count',{n:merchants.length});

        if(!merchants.length) {
            list.innerHTML=`<div class="empty-state"><div class="em-icon">ğŸ”</div><div class="em-text">${t('empty_nearby')}</div></div>`;
            return;
        }

        list.innerHTML = merchants.map(m => {
            const icon = TYPE_ICON[m.type]||'ğŸ“¦';
            const tname = typeName(m.type);
            const dist = m.distance != null ? m.distance : '?';
            const menuHtml = (m.menu||[]).map(i=>`<div class="card-menu-row"><span>${i.name}</span><span class="price">$${i.price}</span></div>`).join('') || `<div style="color:var(--text-3);font-size:13px;">${t('no_menu')}</div>`;
            return `
            <div class="merchant-card" onclick="showMerchantDetail(${m.id})">
                <div class="mc-top">
                    <div class="mc-name"><div class="mc-icon">${icon}</div>${m.name}</div>
                    <span class="mc-dist">${dist}km</span>
                </div>
                <div class="mc-meta">${tname}${m.address?' Â· '+m.address:''}</div>
                <div class="mc-rating">
                    <span class="mc-stars">${starsStr(m.rating)}</span>
                    <span class="mc-rating-num">${m.rating}</span>
                    <span class="mc-rating-cnt">(${m.reviewCount||0})</span>
                </div>
                <div class="mc-actions" onclick="event.stopPropagation();">
                    <button class="mc-btn orange" onclick="toggleCardMenu(${m.id})">ğŸ“‹ ${currentLang==='zh'?'èœå•':'Menu'}</button>
                    <button class="mc-btn blue-light" onclick="openReview(${m.id})">â­ ${currentLang==='zh'?'è¯„ä»·':'Review'}</button>
                </div>
                <div class="card-menu" id="cmenu-${m.id}">${menuHtml}</div>
            </div>`;
        }).join('');
    }

    function toggleCardMenu(id) { const el=document.getElementById('cmenu-'+id); if(el)el.classList.toggle('show'); }

    function updateMapMarkers() {
        markers.forEach(m=>map.removeLayer(m)); markers=[];
        merchants.forEach(m => {
            const icon=TYPE_ICON[m.type]||'ğŸ“¦';
            const ci=L.divIcon({html:`<div style="font-size:26px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3));">${icon}</div>`,className:'',iconSize:[30,30],iconAnchor:[15,15]});
            const mk=L.marker([m.lat,m.lng],{icon:ci}).addTo(map);
            mk.bindPopup(`<div class="popup-rich"><div class="pr-name">${icon} ${m.name}</div><div class="pr-type">${typeName(m.type)}</div><div class="pr-stars">${starsStr(m.rating)} ${m.rating}</div><div class="pr-dist">ğŸ“ ${m.distance||'?'}km</div></div>`);
            markers.push(mk);
        });
        if(merchants.length) { const g=L.featureGroup(markers); if(userLocMarker)g.addLayer(userLocMarker); map.fitBounds(g.getBounds().pad(0.15)); }
        showUserMarker();
    }

    /* ===== Detail Modal ===== */
    function showMerchantDetail(id) {
        const m=merchants.find(x=>x.id===id); if(!m)return;
        currentMerchant=m;
        const icon=TYPE_ICON[m.type]||'ğŸ“¦';
        document.getElementById('modal-icon').textContent=icon;
        document.getElementById('modal-name').textContent=m.name;
        document.getElementById('modal-type').textContent=typeName(m.type);
        document.getElementById('modal-rating').textContent=starsStr(m.rating)+' '+m.rating+` (${m.reviewCount||0})`;
        document.getElementById('modal-addr').textContent=m.address?'ğŸ“ '+m.address:'';
        document.getElementById('modal-phone').textContent=m.phone?'ğŸ“ '+m.phone:'';

        document.getElementById('modal-menu').innerHTML=(m.menu||[]).length
            ? (m.menu||[]).map(i=>`<div class="menu-item"><div><div class="menu-item-name">${i.name}</div></div><div class="menu-item-price">$${i.price}</div></div>`).join('')
            : `<p style="color:var(--text-3)">${t('no_menu')}</p>`;

        document.getElementById('modal-reviews').innerHTML=(m.reviews||[]).length
            ? (m.reviews||[]).map(r=>`<div class="review-card"><div class="rc-stars">${starsStr(r.stars||5)}</div><div class="rc-text">${r.text||''}</div></div>`).join('')
            : `<p style="color:var(--text-3)">${t('no_reviews')}</p>`;

        document.getElementById('merchant-modal').classList.add('active');
    }
    function closeModal() { document.getElementById('merchant-modal').classList.remove('active'); }

    /* ===== Review ===== */
    function openReview(id) {
        const m=merchants.find(x=>x.id===id); if(!m)return;
        reviewMerchantId=id; selectedStars=0;
        document.getElementById('review-for').textContent=m.name;
        document.getElementById('review-text').value='';
        document.querySelectorAll('#starSelect .s').forEach(s=>s.classList.remove('on'));
        document.getElementById('review-modal').classList.add('active');
    }
    function closeReview() { document.getElementById('review-modal').classList.remove('active'); }

    document.querySelectorAll('#starSelect .s').forEach(s => {
        s.addEventListener('click',()=>{ selectedStars=parseInt(s.dataset.v); document.querySelectorAll('#starSelect .s').forEach((ss,i)=>ss.classList.toggle('on',i<selectedStars)); });
    });

    async function submitReview() {
        if(!selectedStars){toast(currentLang==='zh'?'è¯·é€‰æ‹©è¯„åˆ†':'Please rate','error');return;}
        const text=document.getElementById('review-text').value.trim();
        if(!text){toast(currentLang==='zh'?'è¯·è¾“å…¥è¯„ä»·':'Please write a review','error');return;}
        try { await apiCall(`/merchants/${reviewMerchantId}/reviews`,{method:'POST',body:JSON.stringify({score:selectedStars,comment:text})}); }
        catch(e) { const m=merchants.find(x=>x.id===reviewMerchantId); if(m){if(!m.reviews)m.reviews=[];m.reviews.unshift({stars:selectedStars,text});m.reviewCount=(m.reviewCount||0)+1;} }
        toast(t('toast_review_ok'),'success'); closeReview(); renderMerchants();
    }

    /* ===== Seller Auth ===== */
    async function doLogin() {
        const phone=document.getElementById('login-phone').value, pw=document.getElementById('login-password').value;
        if(!phone||!pw){toast(currentLang==='zh'?'è¯·å¡«å†™æ‰‹æœºå·å’Œå¯†ç ':'Please fill in all fields','error');return;}
        showLoading(currentLang==='zh'?'ç™»å½•ä¸­â€¦':'Logging inâ€¦');
        try {
            const data=await apiCall('/auth/login',{method:'POST',body:JSON.stringify({phone,password:pw})});
            localStorage.setItem('token',data.token);
            toast(t('toast_login_ok'),'success');
            showRegisterMerchant();
        } catch(e) {
            localStorage.setItem('token','demo-token');
            showRegisterMerchant();
            toast(t('toast_login_ok')+' (demo)','info');
        }
        hideLoading();
    }

    async function doRegisterAccount() {
        const phone=document.getElementById('login-phone').value, pw=document.getElementById('login-password').value;
        if(!phone||!pw){toast(currentLang==='zh'?'è¯·å…ˆå¡«æ‰‹æœºå·å’Œå¯†ç ':'Please fill phone & password first','error');return;}
        if(pw.length<6){toast(currentLang==='zh'?'å¯†ç è‡³å°‘6ä½':'Password min 6 chars','error');return;}
        showLoading(currentLang==='zh'?'æ³¨å†Œä¸­â€¦':'Registeringâ€¦');
        try {
            const data=await apiCall('/auth/register',{method:'POST',body:JSON.stringify({phone,password:pw})});
            localStorage.setItem('token',data.token);
            toast(currentLang==='zh'?'æ³¨å†ŒæˆåŠŸï¼':'Registered!','success');
            showRegisterMerchant();
        } catch(e) {
            toast(e.message,'error');
        }
        hideLoading();
    }

    function showRegisterMerchant() {
        document.getElementById('seller-login').style.display='none';
        document.getElementById('register-merchant').style.display='block';
        document.getElementById('seller-panel').style.display='none';
    }
    function cancelRegister() {
        localStorage.removeItem('token');
        document.getElementById('seller-login').style.display='block';
        document.getElementById('register-merchant').style.display='none';
    }

    async function registerMerchant() {
        const name=document.getElementById('reg-name').value.trim();
        const type=document.getElementById('reg-type').value;
        const phone=document.getElementById('reg-phone').value.trim();
        const address=document.getElementById('reg-address').value.trim();
        if(!name){toast(currentLang==='zh'?'è¯·è¾“å…¥å•†æˆ·åç§°':'Please enter business name','error');return;}
        if(!phone){toast(currentLang==='zh'?'è¯·è¾“å…¥ç”µè¯':'Please enter phone','error');return;}

        showLoading(currentLang==='zh'?'è·å–GPSâ€¦':'Getting GPSâ€¦');
        const loc=await getGPS();
        const lat=loc?loc.lat:DEFAULT_CENTER.lat, lng=loc?loc.lng:DEFAULT_CENTER.lng;

        try {
            const data=await apiCall('/merchants',{method:'POST',body:JSON.stringify({name,type,phone,address,location:{lat,lng}})});
            const seller={id:data.merchant.id,name,type,phone,address,status:'offline'};
            localStorage.setItem('seller',JSON.stringify(seller));
        } catch(e) {
            const seller={id:Date.now(),name,type,phone,address,status:'offline'};
            localStorage.setItem('seller',JSON.stringify(seller));
        }
        hideLoading();
        toast(t('toast_reg_ok'),'success');
        document.getElementById('register-merchant').style.display='none';
        showSellerPanel();
    }

    function showSellerPanel() {
        document.getElementById('seller-login').style.display='none';
        document.getElementById('register-merchant').style.display='none';
        document.getElementById('seller-panel').style.display='block';
        loadSellerData();
    }

    function loadSellerData() {
        const seller=JSON.parse(localStorage.getItem('seller')||'{}');
        updateSellerUI(seller);
        loadMenu();
    }

    function updateSellerUI(seller) {
        const badge=document.getElementById('status-badge'), btn=document.getElementById('toggle-btn');
        const icon=TYPE_ICON[seller.type]||'ğŸª';
        document.getElementById('shIcon').textContent=icon;
        document.getElementById('shName').textContent=seller.name||'My Business';
        document.getElementById('shType').textContent=typeName(seller.type)+(seller.address?' Â· '+seller.address:'');

        if(seller.status==='online') {
            badge.textContent=t('status_online'); badge.className='status-badge online';
            btn.textContent=t('btn_go_offline'); btn.className='toggle-btn go-offline';
        } else {
            badge.textContent=t('status_offline'); badge.className='status-badge offline';
            btn.textContent=t('btn_go_online'); btn.className='toggle-btn go-online';
        }
    }

    async function toggleStatus() {
        const seller=JSON.parse(localStorage.getItem('seller')||'{}');
        const newStatus=seller.status==='online'?'offline':'online';
        if(newStatus==='online') {
            showLoading(currentLang==='zh'?'è·å–å®šä½â€¦':'Getting locationâ€¦');
            await getGPS(); hideLoading();
        }
        try { await apiCall(`/merchants/${seller.id}/status`,{method:'PATCH',body:JSON.stringify({online:newStatus==='online'})}); } catch(e){}
        seller.status=newStatus;
        localStorage.setItem('seller',JSON.stringify(seller));
        updateSellerUI(seller);
        toast(newStatus==='online'?t('toast_online'):t('toast_offline'),'success');
    }

    async function loadMenu() {
        const seller=JSON.parse(localStorage.getItem('seller')||'{}');
        try { const data=await apiCall(`/merchants/${seller.id}`); menuItems=(data.menuItems||data.menu||[]); } catch(e) { menuItems=[]; }
        renderMenu();
    }

    function renderMenu() {
        document.getElementById('menuCount').innerHTML=t('menu_count',{n:menuItems.length});
        document.getElementById('menu-list').innerHTML=menuItems.map((item,i)=>`
            <div class="menu-item">
                <div><div class="menu-item-name">${item.name}</div></div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div class="menu-item-price">$${item.price}</div>
                    <button class="menu-item-delete" onclick="deleteMenuItem(${i})">ğŸ—‘</button>
                </div>
            </div>`).join('');
    }

    async function addMenuItem() {
        const name=document.getElementById('new-menu-name').value, price=document.getElementById('new-menu-price').value;
        const seller=JSON.parse(localStorage.getItem('seller')||'{}');
        if(!name||!price){toast(currentLang==='zh'?'è¯·è¾“å…¥èœå“å’Œä»·æ ¼':'Enter name and price','error');return;}
        menuItems.push({name,price:parseFloat(price)});
        try { await apiCall(`/merchants/${seller.id}/menu`,{method:'PUT',body:JSON.stringify({items:menuItems})}); } catch(e){}
        renderMenu();
        document.getElementById('new-menu-name').value='';
        document.getElementById('new-menu-price').value='';
        toast(t('toast_added'),'success');
    }

    async function deleteMenuItem(idx) {
        const seller=JSON.parse(localStorage.getItem('seller')||'{}');
        menuItems.splice(idx,1);
        try { await apiCall(`/merchants/${seller.id}/menu`,{method:'PUT',body:JSON.stringify({items:menuItems})}); } catch(e){}
        renderMenu();
        toast(t('toast_deleted'),'info');
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('seller');
        document.getElementById('seller-login').style.display='block';
        document.getElementById('register-merchant').style.display='none';
        document.getElementById('seller-panel').style.display='none';
        toast(t('toast_logout'),'info');
    }

    function checkSellerLogin() {
        const token=localStorage.getItem('token'), seller=localStorage.getItem('seller');
        if(token&&seller) { const s=JSON.parse(seller); if(s.name)showSellerPanel(); else showRegisterMerchant(); }
    }

    /* ===== Init ===== */
    window.addEventListener('DOMContentLoaded', async () => {
        applyLang();
        initMap();
        await initUserLocation();
        showUserMarker();
        searchMerchants();
        checkSellerLogin();
    });
    </script>
</body>
</html>
