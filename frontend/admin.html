<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NearBite Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--p:#1e40af;--pl:#3b82f6;--pd:#1e3a8a;--bg:#0f172a;--c:#1e293b;--h:#334155;--t1:#f1f5f9;--t2:#94a3b8;--bd:#475569;--ok:#22c55e;--no:#ef4444;--wn:#f59e0b;--or:#f97316}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--t1);min-height:100vh}
a{color:var(--pl);text-decoration:none}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--pd),var(--bg))}
.login-box{background:var(--c);padding:2.5rem;border-radius:16px;width:100%;max-width:400px;box-shadow:0 25px 50px -12px rgba(0,0,0,.5)}
.login-logo{text-align:center;margin-bottom:2rem}
.login-logo h1{font-size:1.75rem;color:var(--pl)}
.login-logo p{color:var(--t2);margin-top:.5rem}
.fg{margin-bottom:1.25rem}
.fg label{display:block;margin-bottom:.5rem;color:var(--t2);font-size:.875rem}
.fg input,.fg select,.fg textarea{width:100%;padding:.75rem 1rem;background:var(--bg);border:1px solid var(--bd);border-radius:8px;color:var(--t1);font-size:1rem;font-family:inherit}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--pl)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.5rem;border:none;border-radius:8px;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s;font-family:inherit}
.btn-p{background:var(--pl);color:#fff}.btn-p:hover{background:var(--p)}
.btn-d{background:var(--no);color:#fff}.btn-d:hover{background:#dc2626}
.btn-s{background:var(--ok);color:#fff}.btn-s:hover{background:#16a34a}
.btn-o{background:var(--bd);color:var(--t1)}.btn-o:hover{background:var(--h)}
.btn-w{width:100%}
.btn-sm{padding:.375rem .75rem;font-size:.75rem}
.btn-xs{padding:.25rem .5rem;font-size:.7rem}
.app{display:none;min-height:100vh}
.app.on{display:flex}
.side{width:240px;background:var(--c);border-right:1px solid var(--bd);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;overflow-y:auto}
.side-head{padding:1.5rem;border-bottom:1px solid var(--bd)}
.side-head h2{color:var(--pl);font-size:1.25rem}
.side-nav{flex:1;padding:1rem 0}
.ni{display:flex;align-items:center;gap:.75rem;padding:.875rem 1.5rem;color:var(--t2);cursor:pointer;transition:all .2s;border-left:3px solid transparent;font-size:.9rem}
.ni:hover{background:var(--h);color:var(--t1)}
.ni.on{background:rgba(59,130,246,.1);color:var(--pl);border-left-color:var(--pl)}
.ni em{font-style:normal;font-size:1.1rem;width:1.5rem;text-align:center}
.side-foot{padding:1rem 1.5rem;border-top:1px solid var(--bd)}
.um{display:flex;align-items:center;gap:.75rem;padding:.75rem;background:var(--bg);border-radius:8px}
.ua{width:36px;height:36px;border-radius:50%;background:var(--pl);display:flex;align-items:center;justify-content:center;font-weight:600;flex-shrink:0}
.ui{flex:1;min-width:0}
.ui .n{font-weight:500;font-size:.875rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ui .r{font-size:.75rem;color:var(--t2)}
.lt{display:flex;margin-top:1rem;background:var(--bg);border-radius:6px;overflow:hidden;cursor:pointer}
.lt span{flex:1;text-align:center;padding:.4rem;font-size:.75rem;transition:all .2s}
.lt span.on{background:var(--pl);color:#fff}
.main{flex:1;margin-left:240px;padding:1.5rem;min-height:100vh}
.pg{display:none}.pg.on{display:block}
.ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:.75rem}
.ph h1{font-size:1.5rem;font-weight:600}
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem}
.sc{background:var(--c);padding:1.25rem;border-radius:12px;border:1px solid var(--bd)}
.sc .ico{font-size:1.5rem;margin-bottom:.5rem}
.sc .lb{color:var(--t2);font-size:.75rem;text-transform:uppercase;letter-spacing:.05em}
.sc .vl{font-size:1.75rem;font-weight:700;color:var(--pl);margin-top:.25rem}
.tc{background:var(--c);border-radius:12px;border:1px solid var(--bd);overflow:hidden}
.th{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--bd);flex-wrap:wrap;gap:.75rem}
.sb{display:flex;gap:.5rem}
.sb input{padding:.5rem 1rem;background:var(--bg);border:1px solid var(--bd);border-radius:6px;color:var(--t1);font-size:.875rem;width:200px}
.sb input:focus{outline:none;border-color:var(--pl)}
.fs{padding:.5rem 1rem;background:var(--bg);border:1px solid var(--bd);border-radius:6px;color:var(--t1);font-size:.875rem}
table{width:100%;border-collapse:collapse}
th,td{padding:.75rem 1rem;text-align:left;border-bottom:1px solid var(--bd)}
th{background:var(--bg);color:var(--t2);font-weight:500;font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;white-space:nowrap}
td{font-size:.875rem}
tbody tr:hover{background:var(--h)}
.badge{display:inline-block;padding:.2rem .6rem;border-radius:9999px;font-size:.75rem;font-weight:500}
.b-ok{background:rgba(34,197,94,.1);color:var(--ok)}
.b-no{background:rgba(239,68,68,.1);color:var(--no)}
.b-wn{background:rgba(245,158,11,.1);color:var(--wn)}
.b-or{background:rgba(249,115,22,.1);color:var(--or)}
.b-bl{background:rgba(59,130,246,.1);color:var(--pl)}
.pg-bar{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-top:1px solid var(--bd)}
.pg-info{color:var(--t2);font-size:.875rem}
.pg-btns{display:flex;gap:.5rem}
.pg-btns button{padding:.5rem .875rem;background:var(--bg);border:1px solid var(--bd);border-radius:6px;color:var(--t1);cursor:pointer;font-size:.875rem}
.pg-btns button:hover:not(:disabled){background:var(--h)}
.pg-btns button:disabled{opacity:.4;cursor:not-allowed}
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
.mo.on{display:flex}
.modal{background:var(--c);padding:1.5rem;border-radius:12px;width:100%;max-width:400px;margin:1rem}
.modal h3{margin-bottom:1rem;font-size:1.125rem}
.modal-acts{display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.25rem}
.radio-group{display:flex;flex-direction:column;gap:.75rem}
.radio-item{display:flex;align-items:center;gap:.75rem;padding:.75rem;background:var(--bg);border-radius:8px;cursor:pointer;transition:all .2s}
.radio-item:hover{background:var(--h)}
.radio-item input{display:none}
.radio-item .check{width:20px;height:20px;border:2px solid var(--bd);border-radius:50%;display:flex;align-items:center;justify-content:center}
.radio-item input:checked+.check{border-color:var(--pl)}
.radio-item input:checked+.check::after{content:'â—';color:var(--pl);font-size:12px}
.radio-item .txt{flex:1}
.radio-item .txt .n{font-weight:500}
.radio-item .txt .d{font-size:.75rem;color:var(--t2)}
.ss{background:var(--c);padding:1.5rem;border-radius:12px;border:1px solid var(--bd);margin-bottom:1rem}
.ss h3{margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--bd)}
.sr{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0}
.sr .lb{color:var(--t2)}.sr .vl{font-weight:500}
.mn{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--c);border-top:1px solid var(--bd);z-index:100}
.mn-items{display:flex;justify-content:space-around;padding:.4rem 0}
.mi{display:flex;flex-direction:column;align-items:center;padding:.4rem;color:var(--t2);cursor:pointer;font-size:.6rem;gap:.15rem}
.mi.on{color:var(--pl)}
.mi em{font-style:normal;font-size:1.2rem}
.ld{display:flex;align-items:center;justify-content:center;padding:3rem;color:var(--t2)}
.sp{width:20px;height:20px;border:3px solid var(--bd);border-top-color:var(--pl);border-radius:50%;animation:spin 1s linear infinite;margin-right:.75rem}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;top:1rem;right:1rem;padding:.875rem 1.25rem;border-radius:8px;color:#fff;font-size:.875rem;z-index:2000;transform:translateX(calc(100% + 2rem));transition:transform .3s ease}
.toast.show{transform:translateX(0)}
.toast-ok{background:var(--ok)}.toast-no{background:var(--no)}
.btn-group{display:flex;gap:.25rem;flex-wrap:wrap}
@media(max-width:768px){
.side{display:none}
.main{margin-left:0;padding:1rem;padding-bottom:5rem}
.mn{display:block}
.sg{grid-template-columns:repeat(2,1fr)}
.th{flex-direction:column;align-items:stretch}
.sb{width:100%}.sb input{flex:1}
table{font-size:.75rem}th,td{padding:.5rem .5rem}
.ph{flex-direction:column;align-items:flex-start}
.btn-group{flex-direction:column}
.btn-group .btn{width:100%;justify-content:center}
}
@media(max-width:480px){.sg{grid-template-columns:1fr}}
.overflow-x{overflow-x:auto}
</style>
</head>
<body>

<div id="loginPage" class="login-wrap">
  <div class="login-box">
    <div class="login-logo"><h1>ğŸ” NearBite</h1><p data-i18n="adminPanel">ç®¡ç†åå°</p></div>
    <form id="loginForm">
      <div class="fg"><label data-i18n="phone">æ‰‹æœºå·</label><input type="tel" id="lPhone" placeholder="0210000000" required></div>
      <div class="fg"><label data-i18n="password">å¯†ç </label><input type="password" id="lPass" required></div>
      <button type="submit" class="btn btn-p btn-w" data-i18n="login">ç™»å½•</button>
    </form>
  </div>
</div>

<div id="app" class="app">
  <aside class="side">
    <div class="side-head"><h2>ğŸ” NearBite</h2></div>
    <nav class="side-nav">
      <div class="ni on" data-pg="dashboard"><em>ğŸ“Š</em><span data-i18n="nav_dashboard">æ¦‚è§ˆ</span></div>
      <div class="ni" data-pg="users"><em>ğŸ‘¥</em><span data-i18n="nav_users">ç”¨æˆ·</span></div>
      <div class="ni" data-pg="merchants"><em>ğŸª</em><span data-i18n="nav_merchants">å•†å®¶</span></div>
      <div class="ni" data-pg="orders"><em>ğŸ“‹</em><span data-i18n="nav_orders">è®¢å•</span></div>
      <div class="ni" data-pg="logs"><em>ğŸ“</em><span data-i18n="nav_logs">æ—¥å¿—</span></div>
      <div class="ni" data-pg="settings"><em>âš™ï¸</em><span data-i18n="nav_settings">è®¾ç½®</span></div>
    </nav>
    <div class="side-foot">
      <div class="um"><div class="ua" id="sAvatar">A</div><div class="ui"><div class="n" id="sName">Admin</div><div class="r" data-i18n="admin">ç®¡ç†å‘˜</div></div></div>
      <div class="lt" id="langToggle"><span class="on" data-l="zh">ä¸­æ–‡</span><span data-l="en">EN</span></div>
      <button onclick="doLogout()" style="width:100%;padding:8px;margin-top:8px;border:1px solid #e74c3c;border-radius:8px;background:white;color:#e74c3c;font-size:13px;font-weight:600;cursor:pointer" data-i18n="logout">é€€å‡ºç™»å½•</button>
    </div>
  </aside>

  <main class="main">

    <div id="pg_dashboard" class="pg on">
      <div class="ph"><h1 data-i18n="nav_dashboard">æ¦‚è§ˆ</h1></div>
      <div class="sg">
        <div class="sc"><div class="ico">ğŸ‘¥</div><div class="lb" data-i18n="s_users">æ€»ç”¨æˆ·</div><div class="vl" id="v_users">-</div></div>
        <div class="sc"><div class="ico">ğŸª</div><div class="lb" data-i18n="s_merchants">æ€»å•†å®¶</div><div class="vl" id="v_merchants">-</div></div>
        <div class="sc"><div class="ico">ğŸ“‹</div><div class="lb" data-i18n="s_orders">æ€»è®¢å•</div><div class="vl" id="v_orders">-</div></div>
        <div class="sc"><div class="ico">ğŸ’°</div><div class="lb" data-i18n="s_revenue">æ€»æ”¶å…¥</div><div class="vl" id="v_revenue">-</div></div>
        <div class="sc"><div class="ico">ğŸ“…</div><div class="lb" data-i18n="s_todayOrders">ä»Šæ—¥è®¢å•</div><div class="vl" id="v_todayO">-</div></div>
        <div class="sc"><div class="ico">ğŸ’µ</div><div class="lb" data-i18n="s_todayRevenue">ä»Šæ—¥æ”¶å…¥</div><div class="vl" id="v_todayR">-</div></div>
        <div class="sc"><div class="ico">âœ…</div><div class="lb" data-i18n="s_active">åœ¨çº¿å•†å®¶</div><div class="vl" id="v_active">-</div></div>
      </div>
    </div>

    <div id="pg_users" class="pg">
      <div class="ph"><h1 data-i18n="nav_users">ç”¨æˆ·</h1></div>
      <div class="tc">
        <div class="th"><div class="sb"><input type="text" id="uSearch" data-i18n-ph="ph_searchUser" placeholder="æœç´¢ç”¨æˆ·..."><button class="btn btn-p btn-sm" onclick="U.search()" data-i18n="search">æœç´¢</button></div></div>
        <div class="overflow-x"><table><thead><tr><th data-i18n="phone">æ‰‹æœºå·</th><th data-i18n="role">è§’è‰²</th><th data-i18n="registered">æ³¨å†Œæ—¶é—´</th><th data-i18n="status">çŠ¶æ€</th><th data-i18n="actions">æ“ä½œ</th></tr></thead><tbody id="uBody"></tbody></table></div>
        <div class="pg-bar"><div class="pg-info" id="uInfo"></div><div class="pg-btns"><button id="uPrev" onclick="U.prev()" data-i18n="prev">ä¸Šä¸€é¡µ</button><button id="uNext" onclick="U.next()" data-i18n="next">ä¸‹ä¸€é¡µ</button></div></div>
      </div>
    </div>

    <div id="pg_merchants" class="pg">
      <div class="ph"><h1 data-i18n="nav_merchants">å•†å®¶</h1></div>
      <div class="tc">
        <div class="th"><div class="sb"><input type="text" id="mSearch" data-i18n-ph="ph_searchMerchant" placeholder="æœç´¢å•†å®¶..."><button class="btn btn-p btn-sm" onclick="M.search()" data-i18n="search">æœç´¢</button></div></div>
        <div class="overflow-x"><table><thead><tr><th data-i18n="name">åç§°</th><th data-i18n="type">ç±»å‹</th><th data-i18n="phone">æ‰‹æœºå·</th><th data-i18n="status">çŠ¶æ€</th><th data-i18n="plan">å¥—é¤</th><th data-i18n="commission">ææˆ</th><th data-i18n="rating">è¯„åˆ†</th><th data-i18n="actions">æ“ä½œ</th></tr></thead><tbody id="mBody"></tbody></table></div>
        <div class="pg-bar"><div class="pg-info" id="mInfo"></div><div class="pg-btns"><button id="mPrev" onclick="M.prev()" data-i18n="prev">ä¸Šä¸€é¡µ</button><button id="mNext" onclick="M.next()" data-i18n="next">ä¸‹ä¸€é¡µ</button></div></div>
      </div>
    </div>

    <div id="pg_orders" class="pg">
      <div class="ph"><h1 data-i18n="nav_orders">è®¢å•</h1><button class="btn btn-p btn-sm" onclick="exportCSV('orders')" data-i18n="exportOrders">å¯¼å‡ºè®¢å•CSV</button></div>
      <div class="tc">
        <div class="th"><div class="sb"><select id="oFilter" class="fs" onchange="O.filter()"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="pending">å¾…å¤„ç†</option><option value="preparing">å‡†å¤‡ä¸­</option><option value="ready">å¾…å–é¤</option><option value="completed">å·²å®Œæˆ</option><option value="cancelled">å·²å–æ¶ˆ</option></select></div></div>
        <div class="overflow-x"><table><thead><tr><th data-i18n="orderId">è®¢å•å·</th><th data-i18n="merchant">å•†å®¶</th><th data-i18n="amount">é‡‘é¢</th><th data-i18n="status">çŠ¶æ€</th><th data-i18n="time">æ—¶é—´</th></tr></thead><tbody id="oBody"></tbody></table></div>
        <div class="pg-bar"><div class="pg-info" id="oInfo"></div><div class="pg-btns"><button id="oPrev" onclick="O.prev()" data-i18n="prev">ä¸Šä¸€é¡µ</button><button id="oNext" onclick="O.next()" data-i18n="next">ä¸‹ä¸€é¡µ</button></div></div>
      </div>
    </div>

    <div id="pg_logs" class="pg">
      <div class="ph"><h1 data-i18n="nav_logs">æ“ä½œæ—¥å¿—</h1></div>
      <div class="tc">
        <div class="overflow-x"><table><thead><tr><th data-i18n="time">æ—¶é—´</th><th data-i18n="operator">æ“ä½œäºº</th><th data-i18n="type">ç±»å‹</th><th data-i18n="detail">è¯¦æƒ…</th></tr></thead><tbody id="lBody"></tbody></table></div>
        <div class="pg-bar"><div class="pg-info" id="lInfo"></div><div class="pg-btns"><button id="lPrev" onclick="L.prev()" data-i18n="prev">ä¸Šä¸€é¡µ</button><button id="lNext" onclick="L.next()" data-i18n="next">ä¸‹ä¸€é¡µ</button></div></div>
      </div>
    </div>

    <div id="pg_settings" class="pg">
      <div class="ph"><h1 data-i18n="nav_settings">è®¾ç½®</h1></div>
      <div class="ss"><h3 data-i18n="adminInfo">ç®¡ç†å‘˜ä¿¡æ¯</h3>
        <div class="sr"><span class="lb" data-i18n="phone">æ‰‹æœºå·</span><span class="vl" id="setPhone">-</span></div>
        <div class="sr"><span class="lb" data-i18n="role">è§’è‰²</span><span class="vl" data-i18n="admin">ç®¡ç†å‘˜</span></div>
      </div>
      <div class="ss"><h3 data-i18n="dataExport">æ•°æ®å¯¼å‡º</h3>
        <div class="sr"><span class="lb" data-i18n="nav_orders">è®¢å•</span><button class="btn btn-p btn-sm" onclick="exportCSV('orders')" data-i18n="export">å¯¼å‡º</button></div>
        <div class="sr"><span class="lb" data-i18n="nav_merchants">å•†å®¶</span><button class="btn btn-p btn-sm" onclick="exportCSV('merchants')" data-i18n="export">å¯¼å‡º</button></div>
      </div>
      <div class="ss"><h3 data-i18n="account">è´¦å·</h3><button class="btn btn-d" onclick="doLogout()" data-i18n="logout">é€€å‡ºç™»å½•</button></div>
    </div>

  </main>

  <nav class="mn"><div class="mn-items">
    <div class="mi on" data-pg="dashboard"><em>ğŸ“Š</em><span data-i18n="nav_dashboard">æ¦‚è§ˆ</span></div>
    <div class="mi" data-pg="users"><em>ğŸ‘¥</em><span data-i18n="nav_users">ç”¨æˆ·</span></div>
    <div class="mi" data-pg="merchants"><em>ğŸª</em><span data-i18n="nav_merchants">å•†å®¶</span></div>
    <div class="mi" data-pg="orders"><em>ğŸ“‹</em><span data-i18n="nav_orders">è®¢å•</span></div>
    <div class="mi" data-pg="logs"><em>ğŸ“</em><span data-i18n="nav_logs">æ—¥å¿—</span></div>
    <div class="mi" data-pg="settings"><em>âš™ï¸</em><span data-i18n="nav_settings">è®¾ç½®</span></div>
  </div></nav>
</div>

<!-- Ban Modal -->
<div id="banModal" class="mo">
  <div class="modal">
    <h3 id="banTitle">å°ç¦</h3>
    <div class="fg"><label data-i18n="banReason">å°ç¦åŸå› </label><textarea id="banReason" rows="3" placeholder="è¾“å…¥åŸå› ..."></textarea></div>
    <div class="modal-acts"><button class="btn btn-o btn-sm" onclick="closeBan()" data-i18n="cancel">å–æ¶ˆ</button><button class="btn btn-d btn-sm" id="banConfirm" data-i18n="confirm">ç¡®è®¤</button></div>
  </div>
</div>

<!-- Suspend Modal -->
<div id="suspendModal" class="mo">
  <div class="modal">
    <h3 id="suspendTitle">åœæƒ</h3>
    <div class="fg"><label data-i18n="suspendReason">åœæƒåŸå› </label><textarea id="suspendReason" rows="3" placeholder="è¾“å…¥åŸå› ..."></textarea></div>
    <div class="modal-acts"><button class="btn btn-o btn-sm" onclick="closeSuspend()" data-i18n="cancel">å–æ¶ˆ</button><button class="btn btn-d btn-sm" id="suspendConfirm" data-i18n="confirm">ç¡®è®¤</button></div>
  </div>
</div>

<!-- Plan Modal -->
<div id="planModal" class="mo">
  <div class="modal">
    <h3 data-i18n="changePlan">è°ƒæ•´å¥—é¤</h3>
    <div class="radio-group" id="planOptions">
      <label class="radio-item">
        <input type="radio" name="plan" value="free" checked>
        <span class="check"></span>
        <span class="txt">
          <div class="n" data-i18n="planFree">å…è´¹ç‰ˆ</div>
          <div class="d" data-i18n="planFreeDesc">åŸºç¡€åŠŸèƒ½</div>
        </span>
      </label>
      <label class="radio-item">
        <input type="radio" name="plan" value="pro">
        <span class="check"></span>
        <span class="txt">
          <div class="n">Proç‰ˆ</div>
          <div class="d" data-i18n="planProDesc">é«˜çº§åŠŸèƒ½</div>
        </span>
      </label>
    </div>
    <div class="modal-acts"><button class="btn btn-o btn-sm" onclick="closePlan()" data-i18n="cancel">å–æ¶ˆ</button><button class="btn btn-p btn-sm" id="planConfirm" data-i18n="confirm">ç¡®è®¤</button></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(function(){
"use strict";

var LANG={
zh:{
adminPanel:'ç®¡ç†åå°',login:'ç™»å½•',phone:'æ‰‹æœºå·',password:'å¯†ç ',
nav_dashboard:'æ¦‚è§ˆ',nav_users:'ç”¨æˆ·',nav_merchants:'å•†å®¶',nav_orders:'è®¢å•',nav_logs:'æ“ä½œæ—¥å¿—',nav_settings:'è®¾ç½®',
admin:'ç®¡ç†å‘˜',search:'æœç´¢',
s_users:'æ€»ç”¨æˆ·',s_merchants:'æ€»å•†å®¶',s_orders:'æ€»è®¢å•',s_revenue:'æ€»æ”¶å…¥',s_todayOrders:'ä»Šæ—¥è®¢å•',s_todayRevenue:'ä»Šæ—¥æ”¶å…¥',s_active:'åœ¨çº¿å•†å®¶',
role:'è§’è‰²',registered:'æ³¨å†Œæ—¶é—´',status:'çŠ¶æ€',actions:'æ“ä½œ',name:'åç§°',type:'ç±»å‹',rating:'è¯„åˆ†',plan:'å¥—é¤',commission:'ææˆ',
orderId:'è®¢å•å·',merchant:'å•†å®¶',amount:'é‡‘é¢',time:'æ—¶é—´',operator:'æ“ä½œäºº',detail:'è¯¦æƒ…',
adminInfo:'ç®¡ç†å‘˜ä¿¡æ¯',dataExport:'æ•°æ®å¯¼å‡º',export:'å¯¼å‡º',exportOrders:'å¯¼å‡ºè®¢å•CSV',account:'è´¦å·',logout:'é€€å‡ºç™»å½•',
banUser:'å°ç¦ç”¨æˆ·',banMerchant:'å°ç¦å•†å®¶',unban:'è§£å°',banReason:'å°ç¦åŸå› ',cancel:'å–æ¶ˆ',confirm:'ç¡®è®¤',
suspendUser:'åœæƒç”¨æˆ·',suspendMerchant:'åœæƒå•†å®¶',unsuspend:'è§£åœ',suspendReason:'åœæƒåŸå› ',
changePlan:'è°ƒæ•´å¥—é¤',planFree:'å…è´¹ç‰ˆ',planFreeDesc:'åŸºç¡€åŠŸèƒ½',planProDesc:'é«˜çº§åŠŸèƒ½',
prev:'ä¸Šä¸€é¡µ',next:'ä¸‹ä¸€é¡µ',
st_active:'æ­£å¸¸',st_banned:'å·²å°ç¦',st_suspended:'å·²åœæƒ',st_online:'åœ¨çº¿',st_offline:'ç¦»çº¿',
st_free_trial:'å…è´¹è¯•ç”¨',st_expired:'å·²åˆ°æœŸ',
plan_free:'å…è´¹ç‰ˆ',plan_pro:'Proç‰ˆ',
st_pending:'å¾…å¤„ç†',st_preparing:'å‡†å¤‡ä¸­',st_ready:'å¾…å–é¤',st_completed:'å·²å®Œæˆ',st_cancelled:'å·²å–æ¶ˆ',
justNow:'åˆšåˆš',mAgo:'{n}åˆ†é’Ÿå‰',hAgo:'{n}å°æ—¶å‰',dAgo:'{n}å¤©å‰',
noData:'æš‚æ— æ•°æ®',loading:'åŠ è½½ä¸­...',
pageOf:'ç¬¬ {p} é¡µ / å…± {t} é¡µ',
confirmBan:'ç¡®è®¤å°ç¦ï¼Ÿ',confirmUnban:'ç¡®è®¤è§£å°ï¼Ÿ',
confirmSuspend:'ç¡®è®¤åœæƒï¼Ÿ',confirmUnsuspend:'ç¡®è®¤è§£åœï¼Ÿ',
confirmPlan:'ç¡®è®¤æ›´æ¢å¥—é¤ï¼Ÿ',
opSuccess:'æ“ä½œæˆåŠŸ',opFail:'æ“ä½œå¤±è´¥',loginFail:'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ',
ph_searchUser:'æœç´¢æ‰‹æœºå·...',ph_searchMerchant:'æœç´¢å•†å®¶åç§°...'
},
en:{
adminPanel:'Admin Panel',login:'Login',phone:'Phone',password:'Password',
nav_dashboard:'Dashboard',nav_users:'Users',nav_merchants:'Merchants',nav_orders:'Orders',nav_logs:'Logs',nav_settings:'Settings',
admin:'Admin',search:'Search',
s_users:'Total Users',s_merchants:'Total Merchants',s_orders:'Total Orders',s_revenue:'Total Revenue',s_todayOrders:"Today's Orders",s_todayRevenue:"Today's Revenue",s_active:'Active Merchants',
role:'Role',registered:'Registered',status:'Status',actions:'Actions',name:'Name',type:'Type',rating:'Rating',plan:'Plan',commission:'Commission',
orderId:'Order ID',merchant:'Merchant',amount:'Amount',time:'Time',operator:'Operator',detail:'Detail',
adminInfo:'Admin Info',dataExport:'Data Export',export:'Export',exportOrders:'Export Orders CSV',account:'Account',logout:'Logout',
banUser:'Ban User',banMerchant:'Ban Merchant',unban:'Unban',banReason:'Ban Reason',cancel:'Cancel',confirm:'Confirm',
suspendUser:'Suspend User',suspendMerchant:'Suspend Merchant',unsuspend:'Unsuspend',suspendReason:'Suspend Reason',
changePlan:'Change Plan',planFree:'Free',planFreeDesc:'Basic features',planProDesc:'Advanced features',
prev:'Prev',next:'Next',
st_active:'Active',st_banned:'Banned',st_suspended:'Suspended',st_online:'Online',st_offline:'Offline',
st_free_trial:'Free Trial',st_expired:'Expired',
plan_free:'Free',plan_pro:'Pro',
st_pending:'Pending',st_preparing:'Preparing',st_ready:'Ready',st_completed:'Completed',st_cancelled:'Cancelled',
justNow:'Just now',mAgo:'{n}m ago',hAgo:'{n}h ago',dAgo:'{n}d ago',
noData:'No data',loading:'Loading...',
pageOf:'Page {p} of {t}',
confirmBan:'Confirm ban?',confirmUnban:'Confirm unban?',
confirmSuspend:'Confirm suspend?',confirmUnsuspend:'Confirm unsuspend?',
confirmPlan:'Confirm plan change?',
opSuccess:'Success',opFail:'Failed',loginFail:'Login failed. Check credentials.',
ph_searchUser:'Search phone...',ph_searchMerchant:'Search merchant name...'
}
};

var lang=localStorage.getItem('nb_lang')||'zh';
var token=localStorage.getItem('token');
var user=JSON.parse(localStorage.getItem('user')||'null');
var banCtx=null;
var suspendCtx=null;
var planCtx=null;

function t(k){
  var val=LANG[lang]&&LANG[lang][k];
  return val!==undefined?val:k;
}

function fmtNum(n){if(n==null)return'0';return Number(n).toLocaleString()}
function fmtMoney(n){return'$'+fmtNum(n!=null?Math.round(n):0)}

function relTime(d){
  if(!d)return'-';
  var ms=Date.now()-new Date(d).getTime();
  if(ms<0)ms=0;
  var m=Math.floor(ms/60000),h=Math.floor(ms/3600000),dy=Math.floor(ms/86400000);
  if(m<1)return t('justNow');
  if(m<60)return t('mAgo').replace('{n}',m);
  if(h<24)return t('hAgo').replace('{n}',h);
  return t('dAgo').replace('{n}',dy);
}

function getStatusBadge(status){
  var map={
    'active':{cls:'b-bl',txt:t('st_active')},
    'banned':{cls:'b-no',txt:t('st_banned')},
    'suspended':{cls:'b-or',txt:t('st_suspended')},
    'free_trial':{cls:'b-ok',txt:t('st_free_trial')},
    'expired':{cls:'b-wn',txt:t('st_expired')},
    'online':{cls:'b-ok',txt:t('st_online')},
    'offline':{cls:'b-no',txt:t('st_offline')}
  };
  var m=map[status]||{cls:'b-ok',txt:status||'active'};
  return'<span class="badge '+m.cls+'">'+m.txt+'</span>';
}

function getMerchantStatusBadge(m){
  if(m.banned)return getStatusBadge('banned');
  if(m.suspended)return getStatusBadge('suspended');
  var online=m.isOnline||m.is_online;
  return online?getStatusBadge('online'):getStatusBadge('offline');
}

function getUserStatusBadge(u){
  if(u.banned)return getStatusBadge('banned');
  if(u.suspended)return getStatusBadge('suspended');
  return getStatusBadge('active');
}

function getUserStatus(u){
  if(u.banned)return'banned';
  if(u.suspended)return'suspended';
  return'active';
}

function getMerchantStatus(m){
  if(m.banned)return'banned';
  if(m.suspended)return'suspended';
  var online=m.isOnline||m.is_online;
  return online?'online':'offline';
}

function getPlanBadge(plan){
  var txt=plan==='pro'?t('plan_pro'):t('plan_free');
  var cls=plan==='pro'?'b-bl':'b-ok';
  return'<span class="badge '+cls+'">'+txt+'</span>';
}

function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(function(el){el.textContent=t(el.getAttribute('data-i18n'))});
  document.querySelectorAll('[data-i18n-ph]').forEach(function(el){el.placeholder=t(el.getAttribute('data-i18n-ph'))});
  var sel=document.getElementById('oFilter');
  if(sel){
    sel.options[0].text=lang==='zh'?'å…¨éƒ¨çŠ¶æ€':'All Status';
    if(sel.options[1])sel.options[1].text=t('st_pending');
    if(sel.options[2])sel.options[2].text=t('st_preparing');
    if(sel.options[3])sel.options[3].text=t('st_ready');
    if(sel.options[4])sel.options[4].text=t('st_completed');
    if(sel.options[5])sel.options[5].text=t('st_cancelled');
  }
}

function showToast(msg,ok){
  var el=document.getElementById('toast');
  el.textContent=msg;
  el.className='toast '+(ok!==false?'toast-ok':'toast-no')+' show';
  setTimeout(function(){el.classList.remove('show')},3000);
}

function api(path,opts){
  opts=opts||{};
  var headers=Object.assign({'Content-Type':'application/json'},opts.headers||{});
  if(token)headers['Authorization']='Bearer '+token;
  return fetch(path,Object.assign({},opts,{headers:headers}))
    .then(function(r){
      if(r.status===401){doLogout();return Promise.reject('401');}
      if(!r.ok)return r.json().catch(function(){return{}}).then(function(e){return Promise.reject(e.message||'Error')});
      return r.json();
    });
}

document.getElementById('loginForm').addEventListener('submit',function(e){
  e.preventDefault();
  var ph=document.getElementById('lPhone').value.trim();
  var pw=document.getElementById('lPass').value;
  api('/api/auth/login',{method:'POST',body:JSON.stringify({phone:ph,password:pw})})
    .then(function(d){
      token=d.token;user=d.user;
      localStorage.setItem('token',token);
      localStorage.setItem('user',JSON.stringify(user));
      enterApp();
    })
    .catch(function(){showToast(t('loginFail'),false)});
});

window.doLogout=function(){
  token=null;user=null;
  localStorage.removeItem('token');localStorage.removeItem('user');
  // æ¸…ç©ºç™»å½•è¡¨å•ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
  document.getElementById('lPhone').value = '';
  document.getElementById('lPass').value = '';
  window.location.href = '/';
};

function enterApp(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('app').classList.add('on');
  if(user){
    var nm=user.name||user.phone||'Admin';
    document.getElementById('sName').textContent=nm;
    document.getElementById('sAvatar').textContent=nm[0].toUpperCase();
    document.getElementById('setPhone').textContent=user.phone||'-';
  }
  goTo('dashboard');
}

function goTo(pg){
  document.querySelectorAll('.pg').forEach(function(el){el.classList.remove('on')});
  var target=document.getElementById('pg_'+pg);
  if(target)target.classList.add('on');
  document.querySelectorAll('.ni,.mi').forEach(function(el){el.classList.toggle('on',el.getAttribute('data-pg')===pg)});
  if(pg==='dashboard')loadStats();
  else if(pg==='users')U.load();
  else if(pg==='merchants')M.load();
  else if(pg==='orders')O.load();
  else if(pg==='logs')L.load();
}
document.querySelectorAll('.ni,.mi').forEach(function(el){
  el.addEventListener('click',function(){goTo(el.getAttribute('data-pg'))});
});

document.getElementById('langToggle').addEventListener('click',function(e){
  var l=e.target.getAttribute('data-l');
  if(!l)return;
  lang=l;localStorage.setItem('nb_lang',lang);
  this.querySelectorAll('span').forEach(function(s){s.classList.toggle('on',s.getAttribute('data-l')===lang)});
  applyI18n();
});

function loadStats(){
  api('/api/admin/stats').then(function(d){
    document.getElementById('v_users').textContent=fmtNum(d.totalUsers);
    document.getElementById('v_merchants').textContent=fmtNum(d.totalMerchants);
    document.getElementById('v_orders').textContent=fmtNum(d.totalOrders);
    document.getElementById('v_revenue').textContent=fmtMoney(d.totalRevenue);
    document.getElementById('v_todayO').textContent=fmtNum(d.todayOrders);
    document.getElementById('v_todayR').textContent=fmtMoney(d.todayRevenue);
    document.getElementById('v_active').textContent=fmtNum(d.activeMerchants);
  }).catch(function(){});
}

function makePager(cfg){
  var pg=1,total=0,totalPages=1;
  function updateBar(){
    document.getElementById(cfg.info).textContent=t('pageOf').replace('{p}',pg).replace('{t}',totalPages);
    document.getElementById(cfg.prev).disabled=(pg<=1);
    document.getElementById(cfg.next).disabled=(pg>=totalPages);
  }
  function load(){
    var url=cfg.url(pg);
    api(url).then(function(d){
      total=d.total||0;
      totalPages=d.totalPages||Math.ceil(total/(cfg.limit||20))||1;
      cfg.render(d[cfg.key]||[]);
      updateBar();
    }).catch(function(){
      cfg.render([]);updateBar();
    });
  }
  return{load:load,search:function(){pg=1;load()},filter:function(){pg=1;load()},prev:function(){if(pg>1){pg--;load()}},next:function(){if(pg<totalPages){pg++;load()}}};
}

var U=makePager({
  key:'users',info:'uInfo',prev:'uPrev',next:'uNext',limit:20,
  url:function(p){return'/api/admin/users?page='+p+'&limit=20&search='+encodeURIComponent(document.getElementById('uSearch').value)},
  render:function(rows){
    var tb=document.getElementById('uBody');
    if(!rows.length){tb.innerHTML='<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--t2)">'+t('noData')+'</td></tr>';return}
    tb.innerHTML=rows.map(function(u){
      var st=getUserStatus(u);
      var badge=getUserStatusBadge(u);
      var btns='<div class="btn-group">';
      if(u.suspended){
        btns+='<button class="btn btn-s btn-xs" onclick="unsuspendUser(\''+u._id+'\')">'+t('unsuspend')+'</button>';
      }else{
        btns+='<button class="btn btn-o btn-xs" onclick="openSuspend(\'user\',\''+u._id+'\')">'+t('suspendUser')+'</button>';
      }
      if(u.banned){
        btns+='<button class="btn btn-s btn-xs" onclick="unbanUser(\''+u._id+'\')">'+t('unban')+'</button>';
      }else{
        btns+='<button class="btn btn-d btn-xs" onclick="openBan(\'user\',\''+u._id+'\')">'+t('banUser')+'</button>';
      }
      btns+='</div>';
      return'<tr><td>'+(u.phone||'-')+'</td><td>'+(u.role||'user')+'</td><td>'+relTime(u.createdAt||u.created_at)+'</td><td>'+badge+'</td><td>'+btns+'</td></tr>';
    }).join('');
  }
});
document.getElementById('uSearch').addEventListener('keydown',function(e){if(e.key==='Enter')U.search()});

window.unbanUser=function(id){
  if(!confirm(t('confirmUnban')))return;
  api('/api/admin/users/'+id+'/unban',{method:'PATCH'}).then(function(){showToast(t('opSuccess'));U.load()}).catch(function(){showToast(t('opFail'),false)});
};

window.unsuspendUser=function(id){
  if(!confirm(t('confirmUnsuspend')))return;
  api('/api/admin/users/'+id+'/unsuspend',{method:'PATCH'}).then(function(){showToast(t('opSuccess'));U.load()}).catch(function(){showToast(t('opFail'),false)});
};

var M=makePager({
  key:'merchants',info:'mInfo',prev:'mPrev',next:'mNext',limit:20,
  url:function(p){return'/api/admin/merchants?page='+p+'&limit=20&search='+encodeURIComponent(document.getElementById('mSearch').value)},
  render:function(rows){
    var tb=document.getElementById('mBody');
    if(!rows.length){tb.innerHTML='<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--t2)">'+t('noData')+'</td></tr>';return}
    tb.innerHTML=rows.map(function(m){
      var badge=getMerchantStatusBadge(m);
      var plan=m.plan||m.subscription||'free';
      var planBadge=getPlanBadge(plan);
      var comm=m.commission||m.commissionRate||8;
      var commTxt=comm+'%';
      var rating=m.rating!=null?Number(m.rating).toFixed(1):'-';
      var btns='<div class="btn-group">';
      if(m.suspended){
        btns+='<button class="btn btn-s btn-xs" onclick="unsuspendMerchant(\''+m._id+'\')">'+t('unsuspend')+'</button>';
      }else{
        btns+='<button class="btn btn-o btn-xs" onclick="openSuspend(\'merchant\',\''+m._id+'\')">'+t('suspendMerchant')+'</button>';
      }
      if(m.banned){
        btns+='<button class="btn btn-s btn-xs" onclick="unbanMerchant(\''+m._id+'\')">'+t('unban')+'</button>';
      }else{
        btns+='<button class="btn btn-d btn-xs" onclick="openBan(\'merchant\',\''+m._id+'\')">'+t('banMerchant')+'</button>';
      }
      btns+='<button class="btn btn-p btn-xs" onclick="openPlan(\''+m._id+'\',\''+plan+'\')">'+t('changePlan')+'</button>';
      btns+='</div>';
      return'<tr><td>'+(m.name||m.businessName||'-')+'</td><td>'+(m.type||m.cuisine||'-')+'</td><td>'+(m.phone||'-')+'</td><td>'+badge+'</td><td>'+planBadge+'</td><td>'+commTxt+'</td><td>'+rating+'</td><td>'+btns+'</td></tr>';
    }).join('');
  }
});
document.getElementById('mSearch').addEventListener('keydown',function(e){if(e.key==='Enter')M.search()});

window.unbanMerchant=function(id){
  if(!confirm(t('confirmUnban')))return;
  api('/api/admin/merchants/'+id+'/unban',{method:'PATCH'}).then(function(){showToast(t('opSuccess'));M.load()}).catch(function(){showToast(t('opFail'),false)});
};

window.unsuspendMerchant=function(id){
  if(!confirm(t('confirmUnsuspend')))return;
  api('/api/admin/merchants/'+id+'/unsuspend',{method:'PATCH'}).then(function(){showToast(t('opSuccess'));M.load()}).catch(function(){showToast(t('opFail'),false)});
};

var O=makePager({
  key:'orders',info:'oInfo',prev:'oPrev',next:'oNext',limit:20,
  url:function(p){var s=document.getElementById('oFilter').value;return'/api/admin/orders?page='+p+'&limit=20'+(s?'&status='+s:'')},
  render:function(rows){
    var tb=document.getElementById('oBody');
    if(!rows.length){tb.innerHTML='<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--t2)">'+t('noData')+'</td></tr>';return}
    tb.innerHTML=rows.map(function(o){
      var oid=(o.orderId||o.orderNumber||o._id||'').slice(-6);
      var st=o.status||'pending';
      var cls=st==='completed'?'b-ok':st==='cancelled'?'b-no':'b-wn';
      return'<tr><td>'+oid+'</td><td>'+(o.merchantName||o.merchant||'-')+'</td><td>'+fmtMoney(o.amount||o.total)+'</td><td><span class="badge '+cls+'">'+t('st_'+st)+'</span></td><td>'+relTime(o.createdAt||o.created_at)+'</td></tr>';
    }).join('');
  }
});

var L=makePager({
  key:'logs',info:'lInfo',prev:'lPrev',next:'lNext',limit:50,
  url:function(p){return'/api/admin/logs?page='+p+'&limit=50'},
  render:function(rows){
    var tb=document.getElementById('lBody');
    if(!rows.length){tb.innerHTML='<tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--t2)">'+t('noData')+'</td></tr>';return}
    tb.innerHTML=rows.map(function(l){
      return'<tr><td>'+relTime(l.createdAt||l.created_at||l.timestamp)+'</td><td>'+(l.operator||l.admin||l.userName||'-')+'</td><td>'+(l.type||l.action||'-')+'</td><td>'+(l.detail||l.description||l.message||'-')+'</td></tr>';
    }).join('');
  }
});

window.openBan=function(type,id){
  banCtx={type:type,id:id};
  document.getElementById('banTitle').textContent=type==='user'?t('banUser'):t('banMerchant');
  document.getElementById('banReason').value='';
  document.getElementById('banModal').classList.add('on');
};
window.closeBan=function(){
  document.getElementById('banModal').classList.remove('on');
  banCtx=null;
};
document.getElementById('banConfirm').addEventListener('click',function(){
  if(!banCtx)return;
  var reason=document.getElementById('banReason').value.trim();
  var url=banCtx.type==='user'?'/api/admin/users/'+banCtx.id+'/ban':'/api/admin/merchants/'+banCtx.id+'/ban';
  api(url,{method:'PATCH',body:JSON.stringify({reason:reason})})
    .then(function(){showToast(t('opSuccess'));closeBan();if(banCtx.type==='user')U.load();else M.load()})
    .catch(function(){showToast(t('opFail'),false)});
});
document.getElementById('banModal').addEventListener('click',function(e){if(e.target===this)closeBan()});

window.openSuspend=function(type,id){
  suspendCtx={type:type,id:id};
  document.getElementById('suspendTitle').textContent=type==='user'?t('suspendUser'):t('suspendMerchant');
  document.getElementById('suspendReason').value='';
  document.getElementById('suspendModal').classList.add('on');
};
window.closeSuspend=function(){
  document.getElementById('suspendModal').classList.remove('on');
  suspendCtx=null;
};
document.getElementById('suspendConfirm').addEventListener('click',function(){
  if(!suspendCtx)return;
  var reason=document.getElementById('suspendReason').value.trim();
  var url=suspendCtx.type==='user'?'/api/admin/users/'+suspendCtx.id+'/suspend':'/api/admin/merchants/'+suspendCtx.id+'/suspend';
  api(url,{method:'PATCH',body:JSON.stringify({reason:reason})})
    .then(function(){showToast(t('opSuccess'));closeSuspend();if(suspendCtx.type==='user')U.load();else M.load()})
    .catch(function(){showToast(t('opFail'),false)});
});
document.getElementById('suspendModal').addEventListener('click',function(e){if(e.target===this)closeSuspend()});

window.openPlan=function(id,current){
  planCtx={id:id};
  var radios=document.getElementsByName('plan');
  for(var i=0;i<radios.length;i++){radios[i].checked=(radios[i].value===current);}
  document.getElementById('planModal').classList.add('on');
};
window.closePlan=function(){
  document.getElementById('planModal').classList.remove('on');
  planCtx=null;
};
document.getElementById('planConfirm').addEventListener('click',function(){
  if(!planCtx)return;
  var radios=document.getElementsByName('plan');
  var plan='free';
  for(var i=0;i<radios.length;i++){if(radios[i].checked){plan=radios[i].value;break;}}
  api('/api/admin/merchants/'+planCtx.id+'/plan',{method:'PATCH',body:JSON.stringify({plan:plan})})
    .then(function(){showToast(t('opSuccess'));closePlan();M.load()})
    .catch(function(){showToast(t('opFail'),false)});
});
document.getElementById('planModal').addEventListener('click',function(e){if(e.target===this)closePlan()});

window.exportCSV=function(type){
  var url='/api/admin/export/'+type;
  var a=document.createElement('a');
  a.href=url;
  a.download=type+'.csv';
  fetch(url,{headers:{'Authorization':'Bearer '+token}})
    .then(function(r){if(r.status===401){doLogout();return}return r.blob()})
    .then(function(blob){if(!blob)return;var u=URL.createObjectURL(blob);a.href=u;a.click();URL.revokeObjectURL(u);showToast(t('opSuccess'))})
    .catch(function(){showToast(t('opFail'),false)});
};

applyI18n();
document.querySelectorAll('#langToggle span').forEach(function(s){s.classList.toggle('on',s.getAttribute('data-l')===lang)});

if(token&&user){enterApp();}

})();
</script>
</body>
</html>