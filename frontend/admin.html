<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NearBite Admin</title>
<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css"/>
<script src="https://fastly.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
<style>
:root{--p:#ff6b35;--pl:#ff8a5c;--pd:#e55a2b;--bg:#f7f8fa;--c:#fff;--h:#f0f0f0;--t1:#333;--t2:#666;--t3:#999;--bd:#eee;--ok:#52c41a;--no:#ff4d4f;--wn:#faad14}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--t1);min-height:100vh}
#app{min-height:100vh}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--pd),var(--p))}
.login-box{background:var(--c);padding:2.5rem;border-radius:16px;width:100%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.login-logo{text-align:center;margin-bottom:2rem}
.login-logo h1{font-size:2rem;color:var(--p)}
.login-logo p{color:var(--t2);margin-top:.5rem}
.admin-layout{display:flex;min-height:100vh}
.admin-sidebar{width:220px;background:var(--c);border-right:1px solid var(--bd);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;overflow-y:auto}
.sidebar-header{padding:1.25rem;border-bottom:1px solid var(--bd)}
.sidebar-header h2{color:var(--p);font-size:1.25rem}
.sidebar-nav{flex:1;padding:.5rem 0}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.875rem 1.25rem;color:var(--t2);cursor:pointer;transition:all .2s;font-size:.9rem;border-left:3px solid transparent}
.nav-item:hover{background:var(--h);color:var(--t1)}
.nav-item.active{background:rgba(255,107,53,.1);color:var(--p);border-left-color:var(--p)}
.nav-item .nav-icon{font-size:1.2rem;width:1.5rem;text-align:center}
.sidebar-footer{padding:1rem 1.25rem;border-top:1px solid var(--bd)}
.user-info{display:flex;align-items:center;gap:.75rem;padding:.75rem;background:var(--bg);border-radius:8px;margin-bottom:.75rem}
.user-avatar{width:36px;height:36px;border-radius:50%;background:var(--p);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.875rem}
.user-name{font-weight:500;font-size:.875rem}
.user-role{font-size:.75rem;color:var(--t3)}
.lang-toggle{display:flex;background:var(--bg);border-radius:6px;overflow:hidden;cursor:pointer}
.lang-toggle span{flex:1;text-align:center;padding:.4rem;font-size:.75rem;transition:all .2s}
.lang-toggle span.active{background:var(--p);color:#fff}
.admin-main{flex:1;margin-left:220px;padding:1.5rem;min-height:100vh}
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:.75rem}
.page-title{font-size:1.5rem;font-weight:600}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--c);padding:1.25rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.stat-icon{font-size:1.5rem;margin-bottom:.5rem}
.stat-label{color:var(--t2);font-size:.75rem;text-transform:uppercase;letter-spacing:.05em}
.stat-value{font-size:1.75rem;font-weight:700;color:var(--p);margin-top:.25rem}
.content-card{background:var(--c);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden}
.card-header{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--bd);flex-wrap:wrap;gap:.75rem}
.search-box{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
.search-input{padding:.5rem 1rem;border:1px solid var(--bd);border-radius:6px;font-size:.875rem;width:200px}
.search-input:focus{outline:none;border-color:var(--p)}
.filter-select{padding:.5rem 1rem;border:1px solid var(--bd);border-radius:6px;font-size:.875rem;background:#fff}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:.75rem 1rem;text-align:left;border-bottom:1px solid var(--bd)}
th{background:var(--bg);color:var(--t2);font-weight:500;font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;white-space:nowrap}
td{font-size:.875rem}
tbody tr:hover{background:var(--h)}
.pagination{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-top:1px solid var(--bd)}
.pagination-info{color:var(--t2);font-size:.875rem}
.pagination-btns{display:flex;gap:.5rem}
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--c);border-top:1px solid var(--bd);z-index:100}
.mobile-nav-items{display:flex;justify-content:space-around;padding:.4rem 0}
.mobile-nav-item{display:flex;flex-direction:column;align-items:center;padding:.4rem;color:var(--t2);cursor:pointer;font-size:.6rem;gap:.15rem}
.mobile-nav-item.active{color:var(--p)}
.mobile-nav-item .nav-icon{font-size:1.2rem}
.badge{display:inline-block;padding:.2rem .6rem;border-radius:4px;font-size:.75rem;font-weight:500}
.badge-ok{background:rgba(82,196,26,.1);color:var(--ok)}
.badge-no{background:rgba(255,77,79,.1);color:var(--no)}
.badge-wn{background:rgba(250,173,20,.1);color:var(--wn)}
.badge-bl{background:rgba(255,107,53,.1);color:var(--p)}
.btn-group{display:flex;gap:.25rem;flex-wrap:wrap}
.empty-row{text-align:center;padding:2rem;color:var(--t2)}
@media(max-width:768px){
.admin-sidebar{display:none}
.admin-main{margin-left:0;padding:1rem;padding-bottom:5rem}
.mobile-nav{display:block}
.stats-grid{grid-template-columns:repeat(2,1fr)}
.card-header{flex-direction:column;align-items:stretch}
.search-box{width:100%}
.search-input{flex:1}
table{font-size:.75rem}th,td{padding:.5rem}
.page-header{flex-direction:column;align-items:flex-start}
.btn-group{flex-direction:column}
.btn-group .van-button{width:100%}
}
@media(max-width:480px){.stats-grid{grid-template-columns:1fr}}
.setting-section{background:var(--c);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:1.5rem;margin-bottom:1rem}
.setting-section h3{margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--bd)}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0}
.setting-row .label{color:var(--t2)}.setting-row .value{font-weight:500}
</style>
</head>
<body>

<div id="app">
  <!-- Login Page -->
  <div v-if="!isLoggedIn" class="login-wrap">
    <div class="login-box">
      <div class="login-logo"><h1>ğŸ” NearBite</h1><p>{{ t('adminPanel') }}</p></div>
      <van-form @submit="handleLogin">
        <van-cell-group inset>
          <van-field v-model="loginForm.phone" name="phone" :label="t('phone')" :placeholder="t('phone')" :rules="[{ required: true, message: t('phone') }]" />
          <van-field v-model="loginForm.password" type="password" name="password" :label="t('password')" :placeholder="t('password')" :rules="[{ required: true, message: t('password') }]" />
        </van-cell-group>
        <div style="margin: 16px;">
          <van-button round block type="primary" native-type="submit" color="#ff6b35" :loading="loggingIn">{{ t('login') }}</van-button>
        </div>
      </van-form>
    </div>
  </div>

  <!-- Admin Layout -->
  <div v-else class="admin-layout">
    <aside class="admin-sidebar">
      <div class="sidebar-header"><h2>ğŸ” NearBite</h2></div>
      <nav class="sidebar-nav">
        <div class="nav-item" :class="{active:currentPage==='dashboard'}" @click="goTo('dashboard')"><span class="nav-icon">ğŸ“Š</span><span>{{ t('nav_dashboard') }}</span></div>
        <div class="nav-item" :class="{active:currentPage==='users'}" @click="goTo('users')"><span class="nav-icon">ğŸ‘¥</span><span>{{ t('nav_users') }}</span></div>
        <div class="nav-item" :class="{active:currentPage==='merchants'}" @click="goTo('merchants')"><span class="nav-icon">ğŸª</span><span>{{ t('nav_merchants') }}</span></div>
        <div class="nav-item" :class="{active:currentPage==='orders'}" @click="goTo('orders')"><span class="nav-icon">ğŸ“‹</span><span>{{ t('nav_orders') }}</span></div>
        <div class="nav-item" :class="{active:currentPage==='logs'}" @click="goTo('logs')"><span class="nav-icon">ğŸ“</span><span>{{ t('nav_logs') }}</span></div>
        <div class="nav-item" :class="{active:currentPage==='settings'}" @click="goTo('settings')"><span class="nav-icon">âš™ï¸</span><span>{{ t('nav_settings') }}</span></div>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar">{{ userName[0] }}</div>
          <div><div class="user-name">{{ userName }}</div><div class="user-role">{{ t('admin') }}</div></div>
        </div>
        <div class="lang-toggle" @click="toggleLang">
          <span :class="{active:lang==='zh'}">ä¸­æ–‡</span>
          <span :class="{active:lang==='en'}">EN</span>
        </div>
      </div>
    </aside>

    <main class="admin-main">
      <!-- Dashboard -->
      <div v-show="currentPage==='dashboard'">
        <div class="page-header"><h1 class="page-title">{{ t('nav_dashboard') }}</h1></div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-label">{{ t('s_users') }}</div><div class="stat-value">{{ stats.totalUsers }}</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸª</div><div class="stat-label">{{ t('s_merchants') }}</div><div class="stat-value">{{ stats.totalMerchants }}</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ“‹</div><div class="stat-label">{{ t('s_orders') }}</div><div class="stat-value">{{ stats.totalOrders }}</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ’°</div><div class="stat-label">{{ t('s_revenue') }}</div><div class="stat-value">${{ fmtNum(stats.totalRevenue) }}</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ“…</div><div class="stat-label">{{ t('s_todayOrders') }}</div><div class="stat-value">{{ stats.todayOrders }}</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ’µ</div><div class="stat-label">{{ t('s_todayRevenue') }}</div><div class="stat-value">${{ fmtNum(stats.todayRevenue) }}</div></div>
          <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-label">{{ t('s_active') }}</div><div class="stat-value">{{ stats.activeMerchants }}</div></div>
        </div>
      </div>

      <!-- Users -->
      <div v-show="currentPage==='users'">
        <div class="page-header"><h1 class="page-title">{{ t('nav_users') }}</h1></div>
        <div class="content-card">
          <div class="card-header">
            <div class="search-box">
              <input class="search-input" v-model="userSearch" :placeholder="t('ph_searchUser')" @keyup.enter="searchUsers" />
              <van-button type="primary" size="small" color="#ff6b35" @click="searchUsers">{{ t('search') }}</van-button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>{{ t('phone') }}</th><th>{{ t('role') }}</th><th>{{ t('registered') }}</th><th>{{ t('status') }}</th><th>{{ t('actions') }}</th></tr></thead>
              <tbody>
                <tr v-if="!users.length"><td colspan="5" class="empty-row">{{ t('noData') }}</td></tr>
                <tr v-for="u in users" :key="u._id">
                  <td>{{ u.phone || '-' }}</td>
                  <td>{{ u.role || 'user' }}</td>
                  <td>{{ relTime(u.createdAt) }}</td>
                  <td><span class="badge" :class="getUserBadgeClass(u)">{{ getUserStatusText(u) }}</span></td>
                  <td>
                    <div class="btn-group">
                      <van-button v-if="u.suspended" size="small" type="success" @click="unsuspendUser(u._id)">{{ t('unsuspend') }}</van-button>
                      <van-button v-else size="small" @click="openSuspend('user',u._id)">{{ t('suspendUser') }}</van-button>
                      <van-button v-if="u.banned" size="small" type="success" @click="unbanUser(u._id)">{{ t('unban') }}</van-button>
                      <van-button v-else size="small" type="danger" @click="openBan('user',u._id)">{{ t('banUser') }}</van-button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination">
            <div class="pagination-info">{{ pageInfo(userPage,userTotalPages) }}</div>
            <div class="pagination-btns">
              <van-button size="small" :disabled="userPage<=1" @click="userPrev">{{ t('prev') }}</van-button>
              <van-button size="small" :disabled="userPage>=userTotalPages" @click="userNext">{{ t('next') }}</van-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Merchants -->
      <div v-show="currentPage==='merchants'">
        <div class="page-header"><h1 class="page-title">{{ t('nav_merchants') }}</h1></div>
        <div class="content-card">
          <div class="card-header">
            <div class="search-box">
              <input class="search-input" v-model="merchantSearch" :placeholder="t('ph_searchMerchant')" @keyup.enter="searchMerchants" />
              <van-button type="primary" size="small" color="#ff6b35" @click="searchMerchants">{{ t('search') }}</van-button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>{{ t('name') }}</th><th>{{ t('type') }}</th><th>{{ t('phone') }}</th><th>{{ t('status') }}</th><th>{{ t('plan') }}</th><th>{{ t('commission') }}</th><th>{{ t('rating') }}</th><th>{{ t('actions') }}</th></tr></thead>
              <tbody>
                <tr v-if="!merchants.length"><td colspan="8" class="empty-row">{{ t('noData') }}</td></tr>
                <tr v-for="m in merchants" :key="m._id">
                  <td>{{ m.name || m.businessName || '-' }}</td>
                  <td>{{ m.type || m.cuisine || '-' }}</td>
                  <td>{{ m.phone || '-' }}</td>
                  <td><span class="badge" :class="getMerchantBadgeClass(m)">{{ getMerchantStatusText(m) }}</span></td>
                  <td><span class="badge" :class="m.plan==='pro'?'badge-bl':'badge-ok'">{{ m.plan==='pro'?t('plan_pro'):t('plan_free') }}</span></td>
                  <td>{{ m.commission || m.commissionRate || 8 }}%</td>
                  <td>{{ m.rating ? Number(m.rating).toFixed(1) : '-' }}</td>
                  <td>
                    <div class="btn-group">
                      <van-button v-if="m.suspended" size="small" type="success" @click="unsuspendMerchant(m._id)">{{ t('unsuspend') }}</van-button>
                      <van-button v-else size="small" @click="openSuspend('merchant',m._id)">{{ t('suspendMerchant') }}</van-button>
                      <van-button v-if="m.banned" size="small" type="success" @click="unbanMerchant(m._id)">{{ t('unban') }}</van-button>
                      <van-button v-else size="small" type="danger" @click="openBan('merchant',m._id)">{{ t('banMerchant') }}</van-button>
                      <van-button size="small" type="primary" color="#ff6b35" @click="openPlan(m._id,m.plan)">{{ t('changePlan') }}</van-button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination">
            <div class="pagination-info">{{ pageInfo(merchantPage,merchantTotalPages) }}</div>
            <div class="pagination-btns">
              <van-button size="small" :disabled="merchantPage<=1" @click="merchantPrev">{{ t('prev') }}</van-button>
              <van-button size="small" :disabled="merchantPage>=merchantTotalPages" @click="merchantNext">{{ t('next') }}</van-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Orders -->
      <div v-show="currentPage==='orders'">
        <div class="page-header">
          <h1 class="page-title">{{ t('nav_orders') }}</h1>
          <van-button type="primary" size="small" color="#ff6b35" @click="exportCSV('orders')">{{ t('exportOrders') }}</van-button>
        </div>
        <div class="content-card">
          <div class="card-header">
            <div class="search-box">
              <select class="filter-select" v-model="orderFilter" @change="loadOrders">
                <option value="">{{ lang==='zh'?'å…¨éƒ¨çŠ¶æ€':'All Status' }}</option>
                <option value="pending">{{ t('st_pending') }}</option>
                <option value="preparing">{{ t('st_preparing') }}</option>
                <option value="ready">{{ t('st_ready') }}</option>
                <option value="completed">{{ t('st_completed') }}</option>
                <option value="cancelled">{{ t('st_cancelled') }}</option>
              </select>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>{{ t('orderId') }}</th><th>{{ t('merchant') }}</th><th>{{ t('amount') }}</th><th>{{ t('status') }}</th><th>{{ t('time') }}</th></tr></thead>
              <tbody>
                <tr v-if="!orders.length"><td colspan="5" class="empty-row">{{ t('noData') }}</td></tr>
                <tr v-for="o in orders" :key="o._id">
                  <td>{{ (o.orderId || o.orderNumber || o._id || '').slice(-6) }}</td>
                  <td>{{ o.merchantName || o.merchant || '-' }}</td>
                  <td>${{ fmtNum(o.amount || o.total) }}</td>
                  <td><span class="badge" :class="getOrderBadgeClass(o.status)">{{ t('st_'+(o.status||'pending')) }}</span></td>
                  <td>{{ relTime(o.createdAt) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination">
            <div class="pagination-info">{{ pageInfo(orderPage,orderTotalPages) }}</div>
            <div class="pagination-btns">
              <van-button size="small" :disabled="orderPage<=1" @click="orderPrev">{{ t('prev') }}</van-button>
              <van-button size="small" :disabled="orderPage>=orderTotalPages" @click="orderNext">{{ t('next') }}</van-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs -->
      <div v-show="currentPage==='logs'">
        <div class="page-header"><h1 class="page-title">{{ t('nav_logs') }}</h1></div>
        <div class="content-card">
          <div class="table-wrap">
            <table>
              <thead><tr><th>{{ t('time') }}</th><th>{{ t('operator') }}</th><th>{{ t('type') }}</th><th>{{ t('detail') }}</th></tr></thead>
              <tbody>
                <tr v-if="!logs.length"><td colspan="4" class="empty-row">{{ t('noData') }}</td></tr>
                <tr v-for="l in logs" :key="l._id||l.timestamp">
                  <td>{{ relTime(l.createdAt||l.created_at||l.timestamp) }}</td>
                  <td>{{ l.operator || l.admin || l.userName || '-' }}</td>
                  <td>{{ l.type || l.action || '-' }}</td>
                  <td>{{ l.detail || l.description || l.message || '-' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination">
            <div class="pagination-info">{{ pageInfo(logPage,logTotalPages) }}</div>
            <div class="pagination-btns">
              <van-button size="small" :disabled="logPage<=1" @click="logPrev">{{ t('prev') }}</van-button>
              <van-button size="small" :disabled="logPage>=logTotalPages" @click="logNext">{{ t('next') }}</van-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div v-show="currentPage==='settings'">
        <div class="page-header"><h1 class="page-title">{{ t('nav_settings') }}</h1></div>
        <div class="setting-section">
          <h3>{{ t('adminInfo') }}</h3>
          <div class="setting-row"><span class="label">{{ t('phone') }}</span><span class="value">{{ userPhone }}</span></div>
          <div class="setting-row"><span class="label">{{ t('role') }}</span><span class="value">{{ t('admin') }}</span></div>
        </div>
        <div class="setting-section">
          <h3>{{ t('dataExport') }}</h3>
          <div class="setting-row"><span class="label">{{ t('nav_orders') }}</span><van-button size="small" type="primary" color="#ff6b35" @click="exportCSV('orders')">{{ t('export') }}</van-button></div>
          <div class="setting-row"><span class="label">{{ t('nav_merchants') }}</span><van-button size="small" type="primary" color="#ff6b35" @click="exportCSV('merchants')">{{ t('export') }}</van-button></div>
        </div>
        <div class="setting-section">
          <h3>{{ t('account') }}</h3>
          <van-button type="danger" block @click="doLogout">{{ t('logout') }}</van-button>
        </div>
      </div>
    </main>

    <!-- Mobile Bottom Nav -->
    <nav class="mobile-nav">
      <div class="mobile-nav-items">
        <div class="mobile-nav-item" :class="{active:currentPage==='dashboard'}" @click="goTo('dashboard')"><span class="nav-icon">ğŸ“Š</span><span>{{ t('nav_dashboard') }}</span></div>
        <div class="mobile-nav-item" :class="{active:currentPage==='users'}" @click="goTo('users')"><span class="nav-icon">ğŸ‘¥</span><span>{{ t('nav_users') }}</span></div>
        <div class="mobile-nav-item" :class="{active:currentPage==='merchants'}" @click="goTo('merchants')"><span class="nav-icon">ğŸª</span><span>{{ t('nav_merchants') }}</span></div>
        <div class="mobile-nav-item" :class="{active:currentPage==='orders'}" @click="goTo('orders')"><span class="nav-icon">ğŸ“‹</span><span>{{ t('nav_orders') }}</span></div>
        <div class="mobile-nav-item" :class="{active:currentPage==='logs'}" @click="goTo('logs')"><span class="nav-icon">ğŸ“</span><span>{{ t('nav_logs') }}</span></div>
      </div>
    </nav>
  </div>

  <!-- Ban Dialog -->
  <van-dialog v-model:show="showBanModal" :title="banTitle" show-cancel-button @confirm="confirmBan">
    <van-field v-model="banReason" type="textarea" :placeholder="t('banReason')" rows="3" style="margin:16px 0;" />
  </van-dialog>

  <!-- Suspend Dialog -->
  <van-dialog v-model:show="showSuspendModal" :title="suspendTitle" show-cancel-button @confirm="confirmSuspend">
    <van-field v-model="suspendReason" type="textarea" :placeholder="t('suspendReason')" rows="3" style="margin:16px 0;" />
  </van-dialog>

  <!-- Plan Dialog -->
  <van-dialog v-model:show="showPlanModal" :title="t('changePlan')" show-cancel-button @confirm="confirmPlan">
    <van-radio-group v-model="selectedPlan" style="padding:16px;">
      <van-radio name="free" shape="square" style="margin-bottom:12px;">{{ t('planFree') }} - {{ t('planFreeDesc') }}</van-radio>
      <van-radio name="pro" shape="square">Pro - {{ t('planProDesc') }}</van-radio>
    </van-radio-group>
  </van-dialog>
</div>

<script>
(function(){
"use strict";
var createApp=Vue.createApp,ref=Vue.ref,computed=Vue.computed,onMounted=Vue.onMounted;

var LANG={
zh:{
adminPanel:'ç®¡ç†åå°',login:'ç™»å½•',phone:'æ‰‹æœºå·',password:'å¯†ç ',
nav_dashboard:'æ¦‚è§ˆ',nav_users:'ç”¨æˆ·',nav_merchants:'å•†å®¶',nav_orders:'è®¢å•',nav_logs:'æ“ä½œæ—¥å¿—',nav_settings:'è®¾ç½®',
admin:'ç®¡ç†å‘˜',search:'æœç´¢',
s_users:'æ€»ç”¨æˆ·',s_merchants:'æ€»å•†å®¶',s_orders:'æ€»è®¢å•',s_revenue:'æ€»æ”¶å…¥',s_todayOrders:'ä»Šæ—¥è®¢å•',s_todayRevenue:'ä»Šæ—¥æ”¶å…¥',s_active:'åœ¨çº¿å•†å®¶',
role:'è§’è‰²',registered:'æ³¨å†Œæ—¶é—´',status:'çŠ¶æ€',actions:'æ“ä½œ',name:'åç§°',type:'ç±»å‹',rating:'è¯„åˆ†',plan:'å¥—é¤',commission:'ææˆ',
orderId:'è®¢å•å·',merchant:'å•†å®¶',amount:'é‡‘é¢',time:'æ—¶é—´',operator:'æ“ä½œäºº',detail:'è¯¦æƒ…',
adminInfo:'ç®¡ç†å‘˜ä¿¡æ¯',dataExport:'æ•°æ®å¯¼å‡º',export:'å¯¼å‡º',exportOrders:'å¯¼å‡ºè®¢å•CSV',account:'è´¦å·',logout:'é€€å‡ºç™»å½•',
banUser:'å°ç¦ç”¨æˆ·',banMerchant:'å°ç¦å•†å®¶',unban:'è§£å°',banReason:'å°ç¦åŸå› ',cancel:'å–æ¶ˆ',confirm:'ç¡®è®¤',
suspendUser:'åœæƒç”¨æˆ·',suspendMerchant:'åœæƒå•†å®¶',unsuspend:'è§£åœ',suspendReason:'åœæƒåŸå› ',
changePlan:'è°ƒæ•´å¥—é¤',planFree:'å…è´¹ç‰ˆ',planFreeDesc:'åŸºç¡€åŠŸèƒ½',planProDesc:'é«˜çº§åŠŸèƒ½',
prev:'ä¸Šä¸€é¡µ',next:'ä¸‹ä¸€é¡µ',
st_active:'æ­£å¸¸',st_banned:'å·²å°ç¦',st_suspended:'å·²åœæƒ',st_online:'åœ¨çº¿',st_offline:'ç¦»çº¿',
st_free_trial:'å…è´¹è¯•ç”¨',st_expired:'å·²åˆ°æœŸ',
plan_free:'å…è´¹ç‰ˆ',plan_pro:'Proç‰ˆ',
st_pending:'å¾…å¤„ç†',st_preparing:'å‡†å¤‡ä¸­',st_ready:'å¾…å–é¤',st_completed:'å·²å®Œæˆ',st_cancelled:'å·²å–æ¶ˆ',
justNow:'åˆšåˆš',mAgo:'{n}åˆ†é’Ÿå‰',hAgo:'{n}å°æ—¶å‰',dAgo:'{n}å¤©å‰',
noData:'æš‚æ— æ•°æ®',loading:'åŠ è½½ä¸­...',
pageOf:'ç¬¬ {p} é¡µ / å…± {t} é¡µ',
opSuccess:'æ“ä½œæˆåŠŸ',opFail:'æ“ä½œå¤±è´¥',loginFail:'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ',
ph_searchUser:'æœç´¢æ‰‹æœºå·...',ph_searchMerchant:'æœç´¢å•†å®¶åç§°...'
},
en:{
adminPanel:'Admin Panel',login:'Login',phone:'Phone',password:'Password',
nav_dashboard:'Dashboard',nav_users:'Users',nav_merchants:'Merchants',nav_orders:'Orders',nav_logs:'Logs',nav_settings:'Settings',
admin:'Admin',search:'Search',
s_users:'Total Users',s_merchants:'Total Merchants',s_orders:'Total Orders',s_revenue:'Total Revenue',s_todayOrders:"Today's Orders",s_todayRevenue:"Today's Revenue",s_active:'Active Merchants',
role:'Role',registered:'Registered',status:'Status',actions:'Actions',name:'Name',type:'Type',rating:'Rating',plan:'Plan',commission:'Commission',
orderId:'Order ID',merchant:'Merchant',amount:'Amount',time:'Time',operator:'Operator',detail:'Detail',
adminInfo:'Admin Info',dataExport:'Data Export',export:'Export',exportOrders:'Export Orders CSV',account:'Account',logout:'Logout',
banUser:'Ban User',banMerchant:'Ban Merchant',unban:'Unban',banReason:'Ban Reason',cancel:'Cancel',confirm:'Confirm',
suspendUser:'Suspend User',suspendMerchant:'Suspend Merchant',unsuspend:'Unsuspend',suspendReason:'Suspend Reason',
changePlan:'Change Plan',planFree:'Free',planFreeDesc:'Basic features',planProDesc:'Advanced features',
prev:'Prev',next:'Next',
st_active:'Active',st_banned:'Banned',st_suspended:'Suspended',st_online:'Online',st_offline:'Offline',
st_free_trial:'Free Trial',st_expired:'Expired',
plan_free:'Free',plan_pro:'Pro',
st_pending:'Pending',st_preparing:'Preparing',st_ready:'Ready',st_completed:'Completed',st_cancelled:'Cancelled',
justNow:'Just now',mAgo:'{n}m ago',hAgo:'{n}h ago',dAgo:'{n}d ago',
noData:'No data',loading:'Loading...',
pageOf:'Page {p} of {t}',
opSuccess:'Success',opFail:'Failed',loginFail:'Login failed. Check credentials.',
ph_searchUser:'Search phone...',ph_searchMerchant:'Search merchant name...'
}
};

createApp({
  setup:function(){
    var lang=ref(localStorage.getItem('nb_lang')||'zh');
    var token=ref(localStorage.getItem('nb_token'));
    var user=ref(JSON.parse(localStorage.getItem('nb_user')||'null'));
    var currentPage=ref('dashboard');
    var loggingIn=ref(false);
    var loginForm=ref({phone:'',password:''});
    var isLoggedIn=computed(function(){return!!token.value});
    var userName=computed(function(){return(user.value&&(user.value.name||user.value.phone))||'Admin'});
    var userPhone=computed(function(){return(user.value&&user.value.phone)||'-'});

    var stats=ref({totalUsers:0,totalMerchants:0,totalOrders:0,totalRevenue:0,todayOrders:0,todayRevenue:0,activeMerchants:0});
    var users=ref([]),merchants=ref([]),orders=ref([]),logs=ref([]);
    var userPage=ref(1),userTotalPages=ref(1);
    var merchantPage=ref(1),merchantTotalPages=ref(1);
    var orderPage=ref(1),orderTotalPages=ref(1);
    var logPage=ref(1),logTotalPages=ref(1);
    var userSearch=ref(''),merchantSearch=ref(''),orderFilter=ref('');

    var showBanModal=ref(false),showSuspendModal=ref(false),showPlanModal=ref(false);
    var banTitle=ref(''),banReason=ref(''),banCtx=ref(null);
    var suspendTitle=ref(''),suspendReason=ref(''),suspendCtx=ref(null);
    var selectedPlan=ref('free'),planCtx=ref(null);

    function t(k){var v=LANG[lang.value]&&LANG[lang.value][k];return v!==undefined?v:k;}
    function fmtNum(n){if(n==null)return'0';return Number(n).toLocaleString();}
    function pageInfo(p,tp){return t('pageOf').replace('{p}',p).replace('{t}',tp);}

    function relTime(d){
      if(!d)return'-';
      var ms=Date.now()-new Date(d).getTime();
      if(ms<0)ms=0;
      var m=Math.floor(ms/60000),h=Math.floor(ms/3600000),dy=Math.floor(ms/86400000);
      if(m<1)return t('justNow');
      if(m<60)return t('mAgo').replace('{n}',m);
      if(h<24)return t('hAgo').replace('{n}',h);
      return t('dAgo').replace('{n}',dy);
    }

    function getUserBadgeClass(u){if(u.banned)return'badge-no';if(u.suspended)return'badge-wn';return'badge-bl';}
    function getUserStatusText(u){if(u.banned)return t('st_banned');if(u.suspended)return t('st_suspended');return t('st_active');}
    function getMerchantBadgeClass(m){if(m.banned)return'badge-no';if(m.suspended)return'badge-wn';return(m.isOnline||m.is_online)?'badge-ok':'badge-no';}
    function getMerchantStatusText(m){if(m.banned)return t('st_banned');if(m.suspended)return t('st_suspended');return(m.isOnline||m.is_online)?t('st_online'):t('st_offline');}
    function getOrderBadgeClass(s){if(s==='completed')return'badge-ok';if(s==='cancelled')return'badge-no';return'badge-wn';}

    function api(path,opts){
      opts=opts||{};
      var headers=Object.assign({'Content-Type':'application/json'},opts.headers||{});
      if(token.value)headers['Authorization']='Bearer '+token.value;
      return fetch(path,Object.assign({},opts,{headers:headers}))
        .then(function(r){
          if(r.status===401){doLogout();return Promise.reject('401');}
          if(!r.ok)return r.json().catch(function(){return{}}).then(function(e){return Promise.reject(e.message||'Error')});
          return r.json();
        });
    }

    function handleLogin(){
      loggingIn.value=true;
      api('/api/auth/login',{method:'POST',body:JSON.stringify({phone:loginForm.value.phone,password:loginForm.value.password})})
        .then(function(d){
          token.value=d.token;user.value=d.user;
          localStorage.setItem('nb_token',d.token);
          localStorage.setItem('nb_user',JSON.stringify(d.user));
          goTo('dashboard');
        })
        .catch(function(){vant.showToast({message:t('loginFail'),type:'fail'})})
        .finally(function(){loggingIn.value=false});
    }

    function doLogout(){
      token.value=null;user.value=null;
      localStorage.removeItem('nb_token');localStorage.removeItem('nb_user');
    }

    function goTo(pg){
      currentPage.value=pg;
      if(pg==='dashboard')loadStats();
      else if(pg==='users')loadUsers();
      else if(pg==='merchants')loadMerchants();
      else if(pg==='orders')loadOrders();
      else if(pg==='logs')loadLogs();
    }

    function toggleLang(){
      lang.value=lang.value==='zh'?'en':'zh';
      localStorage.setItem('nb_lang',lang.value);
    }

    function loadStats(){
      api('/api/admin/stats').then(function(d){
        stats.value={
          totalUsers:fmtNum(d.totalUsers),totalMerchants:fmtNum(d.totalMerchants),
          totalOrders:fmtNum(d.totalOrders),totalRevenue:Math.round(d.totalRevenue||0),
          todayOrders:fmtNum(d.todayOrders),todayRevenue:Math.round(d.todayRevenue||0),
          activeMerchants:fmtNum(d.activeMerchants)
        };
      }).catch(function(){});
    }

    function loadUsers(){
      api('/api/admin/users?page='+userPage.value+'&limit=20&search='+encodeURIComponent(userSearch.value))
        .then(function(d){users.value=d.users||[];userTotalPages.value=d.totalPages||1;})
        .catch(function(){users.value=[];});
    }
    function searchUsers(){userPage.value=1;loadUsers();}
    function userPrev(){if(userPage.value>1){userPage.value--;loadUsers();}}
    function userNext(){if(userPage.value<userTotalPages.value){userPage.value++;loadUsers();}}

    function loadMerchants(){
      api('/api/admin/merchants?page='+merchantPage.value+'&limit=20&search='+encodeURIComponent(merchantSearch.value))
        .then(function(d){merchants.value=d.merchants||[];merchantTotalPages.value=d.totalPages||1;})
        .catch(function(){merchants.value=[];});
    }
    function searchMerchants(){merchantPage.value=1;loadMerchants();}
    function merchantPrev(){if(merchantPage.value>1){merchantPage.value--;loadMerchants();}}
    function merchantNext(){if(merchantPage.value<merchantTotalPages.value){merchantPage.value++;loadMerchants();}}

    function loadOrders(){
      var s=orderFilter.value;
      api('/api/admin/orders?page='+orderPage.value+'&limit=20'+(s?'&status='+s:''))
        .then(function(d){orders.value=d.orders||[];orderTotalPages.value=d.totalPages||1;})
        .catch(function(){orders.value=[];});
    }
    function orderPrev(){if(orderPage.value>1){orderPage.value--;loadOrders();}}
    function orderNext(){if(orderPage.value<orderTotalPages.value){orderPage.value++;loadOrders();}}

    function loadLogs(){
      api('/api/admin/logs?page='+logPage.value+'&limit=50')
        .then(function(d){logs.value=d.logs||[];logTotalPages.value=d.totalPages||1;})
        .catch(function(){logs.value=[];});
    }
    function logPrev(){if(logPage.value>1){logPage.value--;loadLogs();}}
    function logNext(){if(logPage.value<logTotalPages.value){logPage.value++;loadLogs();}}

    function openBan(type,id){banCtx.value={type:type,id:id};banTitle.value=type==='user'?t('banUser'):t('banMerchant');banReason.value='';showBanModal.value=true;}
    function confirmBan(){
      if(!banCtx.value)return;
      var url=banCtx.value.type==='user'?'/api/admin/users/'+banCtx.value.id+'/ban':'/api/admin/merchants/'+banCtx.value.id+'/ban';
      api(url,{method:'PATCH',body:JSON.stringify({reason:banReason.value})})
        .then(function(){vant.showToast(t('opSuccess'));if(banCtx.value.type==='user')loadUsers();else loadMerchants();})
        .catch(function(){vant.showToast({message:t('opFail'),type:'fail'})});
      showBanModal.value=false;
    }
    function unbanUser(id){api('/api/admin/users/'+id+'/unban',{method:'PATCH'}).then(function(){vant.showToast(t('opSuccess'));loadUsers();}).catch(function(){vant.showToast({message:t('opFail'),type:'fail'})});}
    function unbanMerchant(id){api('/api/admin/merchants/'+id+'/unban',{method:'PATCH'}).then(function(){vant.showToast(t('opSuccess'));loadMerchants();}).catch(function(){vant.showToast({message:t('opFail'),type:'fail'})});}

    function openSuspend(type,id){suspendCtx.value={type:type,id:id};suspendTitle.value=type==='user'?t('suspendUser'):t('suspendMerchant');suspendReason.value='';showSuspendModal.value=true;}
    function confirmSuspend(){
      if(!suspendCtx.value)return;
      var url=suspendCtx.value.type==='user'?'/api/admin/users/'+suspendCtx.value.id+'/suspend':'/api/admin/merchants/'+suspendCtx.value.id+'/suspend';
      api(url,{method:'PATCH',body:JSON.stringify({reason:suspendReason.value})})
        .then(function(){vant.showToast(t('opSuccess'));if(suspendCtx.value.type==='user')loadUsers();else loadMerchants();})
        .catch(function(){vant.showToast({message:t('opFail'),type:'fail'})});
      showSuspendModal.value=false;
    }
    function unsuspendUser(id){api('/api/admin/users/'+id+'/unsuspend',{method:'PATCH'}).then(function(){vant.showToast(t('opSuccess'));loadUsers();}).catch(function(){vant.showToast({message:t('opFail'),type:'fail'})});}
    function unsuspendMerchant(id){api('/api/admin/merchants/'+id+'/unsuspend',{method:'PATCH'}).then(function(){vant.showToast(t('opSuccess'));loadMerchants();}).catch(function(){vant.showToast({message:t('opFail'),type:'fail'})});}

    function openPlan(id,current){planCtx.value={id:id};selectedPlan.value=current||'free';showPlanModal.value=true;}
    function confirmPlan(){
      if(!planCtx.value)return;
      api('/api/admin/merchants/'+planCtx.value.id+'/plan',{method:'PATCH',body:JSON.stringify({plan:selectedPlan.value})})
        .then(function(){vant.showToast(t('opSuccess'));loadMerchants();})
        .catch(function(){vant.showToast({message:t('opFail'),type:'fail'})});
      showPlanModal.value=false;
    }

    function exportCSV(type){
      fetch('/api/admin/export/'+type,{headers:{'Authorization':'Bearer '+token.value}})
        .then(function(r){if(r.status===401){doLogout();return;}return r.blob();})
        .then(function(blob){
          if(!blob)return;
          var u=URL.createObjectURL(blob);
          var a=document.createElement('a');a.href=u;a.download=type+'.csv';a.click();
          URL.revokeObjectURL(u);
          vant.showToast(t('opSuccess'));
        })
        .catch(function(){vant.showToast({message:t('opFail'),type:'fail'})});
    }

    onMounted(function(){if(token.value&&user.value)goTo('dashboard');});

    return{
      lang:lang,currentPage:currentPage,loggingIn:loggingIn,loginForm:loginForm,isLoggedIn:isLoggedIn,userName:userName,userPhone:userPhone,
      stats:stats,users:users,merchants:merchants,orders:orders,logs:logs,
      userPage:userPage,userTotalPages:userTotalPages,merchantPage:merchantPage,merchantTotalPages:merchantTotalPages,
      orderPage:orderPage,orderTotalPages:orderTotalPages,logPage:logPage,logTotalPages:logTotalPages,
      userSearch:userSearch,merchantSearch:merchantSearch,orderFilter:orderFilter,
      showBanModal:showBanModal,showSuspendModal:showSuspendModal,showPlanModal:showPlanModal,
      banTitle:banTitle,banReason:banReason,suspendTitle:suspendTitle,suspendReason:suspendReason,selectedPlan:selectedPlan,
      t:t,fmtNum:fmtNum,relTime:relTime,pageInfo:pageInfo,
      getUserBadgeClass:getUserBadgeClass,getUserStatusText:getUserStatusText,
      getMerchantBadgeClass:getMerchantBadgeClass,getMerchantStatusText:getMerchantStatusText,
      getOrderBadgeClass:getOrderBadgeClass,
      handleLogin:handleLogin,doLogout:doLogout,goTo:goTo,toggleLang:toggleLang,
      loadStats:loadStats,loadUsers:loadUsers,searchUsers:searchUsers,userPrev:userPrev,userNext:userNext,
      loadMerchants:loadMerchants,searchMerchants:searchMerchants,merchantPrev:merchantPrev,merchantNext:merchantNext,
      loadOrders:loadOrders,orderPrev:orderPrev,orderNext:orderNext,
      loadLogs:loadLogs,logPrev:logPrev,logNext:logNext,
      openBan:openBan,confirmBan:confirmBan,unbanUser:unbanUser,unbanMerchant:unbanMerchant,
      openSuspend:openSuspend,confirmSuspend:confirmSuspend,unsuspendUser:unsuspendUser,unsuspendMerchant:unsuspendMerchant,
      openPlan:openPlan,confirmPlan:confirmPlan,exportCSV:exportCSV
    };
  }
}).use(vant).mount('#app');
})();
</script>
</body>
</html>