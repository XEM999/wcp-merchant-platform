<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NearBite ÂïÜÂÆ∂ÂêéÂè∞</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè™</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css"/>
    <style>
        :root { --van-primary-color: #ff6b35; --primary: #ff6b35; --primary-light: #fff7ed; --primary-dark: #ea580c; --bg: #f7f8fa; --bg-card: #ffffff; --bg-input: #f3f4f6; --text: #111827; --text-2: #6b7280; --text-3: #9ca3af; --green: #22c55e; --green-bg: #f0fdf4; --red: #ef4444; --red-bg: #fef2f2; --blue: #3b82f6; --yellow: #f59e0b; --yellow-bg: #fffbeb; --border: #e5e7eb; --radius: 16px; --radius-sm: 10px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
        #app { min-height: 100vh; background: var(--bg); }
        .login-page { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, var(--primary-light) 0%, white 100%); }
        .login-logo { font-size: 64px; margin-bottom: 16px; }
        .login-title { font-size: 28px; font-weight: 800; color: var(--primary-dark); margin-bottom: 8px; }
        .login-subtitle { font-size: 14px; color: var(--text-2); margin-bottom: 32px; }
        .login-card { width: 100%; max-width: 400px; background: white; border-radius: var(--radius); padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,.1); }
        .order-card-new { border: 2px solid var(--primary) !important; animation: pulseBorder 1s ease-in-out 3; }
        @keyframes pulseBorder { 0%, 100% { border-color: var(--border); } 50% { border-color: var(--primary); box-shadow: 0 0 20px rgba(255,107,53,.3); } }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .order-id { font-size: 18px; font-weight: 700; color: var(--primary-dark); }
        .order-time { font-size: 12px; color: var(--text-3); }
        .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .order-item:last-child { border-bottom: none; }
        .order-item-name { font-size: 14px; }
        .order-item-qty { font-weight: 600; color: var(--primary); }
        .order-total { font-size: 16px; font-weight: 700; }
        .order-meta { font-size: 13px; color: var(--text-2); }
        .order-note { padding: 10px; background: var(--yellow-bg); border-radius: 8px; font-size: 13px; color: var(--text-2); margin-bottom: 12px; }
        .order-note strong { color: var(--yellow); }
        .store-status-card { margin-top: 16px; padding: 20px; border-radius: var(--radius); text-align: center; }
        .store-status-card.online { background: var(--green-bg); }
        .store-status-card.offline { background: var(--red-bg); }
        .confirm-mode-options { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .confirm-mode-btn { flex: 1; min-width: 100px; padding: 12px; border: 2px solid var(--border); border-radius: 10px; background: white; cursor: pointer; text-align: center; transition: all .2s; }
        .confirm-mode-btn:hover { border-color: var(--primary); }
        .confirm-mode-btn.active { border-color: var(--primary); background: var(--primary-light); }
        .confirm-mode-btn .mode-icon { font-size: 20px; margin-bottom: 4px; }
        .confirm-mode-btn .mode-name { font-size: 13px; font-weight: 600; color: var(--text); }
        .confirm-mode-btn .mode-desc { font-size: 11px; color: var(--text-3); margin-top: 2px; }
        .duration-options { display: flex; gap: 8px; margin-top: 12px; }
        .duration-btn { flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: white; text-align: center; font-size: 14px; font-weight: 600; cursor: pointer; transition: all .2s; }
        .duration-btn:hover { border-color: var(--primary); }
        .duration-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary-dark); }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
        .recording-indicator { margin-top: 8px; color: var(--red); font-size: 13px; animation: blink 1s infinite; }
        @media (min-width: 768px) { .van-container { max-width: 600px; margin: 0 auto; } }
        @media (min-width: 1024px) and (orientation: landscape) { .van-container { max-width: 800px; } }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Page -->
        <div class="login-page" v-show="!isLoggedIn">
            <div class="login-logo">üè™</div>
            <h1 class="login-title">NearBite</h1>
            <p class="login-subtitle">{{ t('merchant_portal') }}</p>
            <div class="login-card">
                <van-cell-group inset>
                    <van-field v-model="loginForm.phone" :label="t('phone')" :placeholder="t('phone_placeholder')" type="tel" />
                    <van-field v-model="loginForm.password" :label="t('password')" :placeholder="t('password_placeholder')" type="password" />
                </van-cell-group>
                <div style="padding: 16px;">
                    <van-button type="primary" size="large" @click="doLogin" :loading="loading">{{ t('login_btn') }}</van-button>
                </div>
                <div v-if="showCreateStore" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; text-align: center;">{{ t('create_store') }}</h3>
                    <van-cell-group inset>
                        <van-field v-model="storeForm.name" :label="t('store_name')" :placeholder="t('store_name_placeholder')" />
                        <van-field v-model="storeForm.phone" :label="t('store_phone')" type="tel" :placeholder="t('phone_placeholder')" />
                        <van-field v-model="storeForm.address" :label="t('store_address')" :placeholder="t('store_address_placeholder')" />
                        <van-field v-model="storeForm.description" :label="t('store_desc')" type="textarea" rows="2" :placeholder="t('store_desc_placeholder')" />
                    </van-cell-group>
                    <div style="padding: 16px;">
                        <van-picker title="" :columns="storeTypeColumns" @change="onStoreTypeChange" />
                    </div>
                    <div style="padding: 16px;">
                        <van-button type="primary" size="large" @click="createStore" :loading="loading">{{ t('create_store_btn') }}</van-button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <van-config-provider v-show="isLoggedIn" :theme-vars="themeVars">
            <van-nav-bar :title="'NearBite'" fixed>
                <template #right>
                    <van-button size="small" round @click="toggleLang">{{ currentLang === 'zh' ? 'EN' : '‰∏≠Êñá' }}</van-button>
                </template>
            </van-nav-bar>

            <van-tabbar v-model="activeTab" fixed>
                <van-tabbar-item name="orders">
                    <span>{{ t('tab_orders') }}</span>
                    <template #icon><span>üìã</span></template>
                    <van-badge v-if="pendingOrdersCount > 0" :content="pendingOrdersCount" max="99" />
                </van-tabbar-item>
                <van-tabbar-item name="menu"><span>{{ t('tab_menu') }}</span><template #icon><span>üìù</span></template></van-tabbar-item>
                <van-tabbar-item name="store"><span>{{ t('tab_store') }}</span><template #icon><span>üè™</span></template></van-tabbar-item>
                <van-tabbar-item name="settings"><span>{{ t('tab_settings') }}</span><template #icon><span>‚öôÔ∏è</span></template></van-tabbar-item>
            </van-tabbar>

            <!-- Orders Page -->
            <div v-show="activeTab === 'orders'" style="padding-top: 46px; padding-bottom: 70px;">
                <van-tabs v-model:active="orderFilter" sticky offset-top="46">
                    <van-tab :title="t('status_pending') + ` (${pendingCount})`" name="pending">
                        <van-pull-refresh v-model="refreshing" @refresh="loadOrders">
                            <div style="padding: 12px;">
                                <template v-if="filteredOrders.length">
                                    <van-card v-for="order in filteredOrders" :key="order.id" :class="{ 'order-card-new': order.isNew }">
                                        <template #title>
                                            <div class="order-header">
                                                <span class="order-id">#{{ order.id.slice(-6).toUpperCase() }}</span>
                                                <van-tag type="warning">{{ t('status_' + order.status) }}</van-tag>
                                            </div>
                                        </template>
                                        <template #desc>
                                            <div style="font-size: 12px; color: var(--text-3); margin-bottom: 8px;">{{ formatTime(order.createdAt) }}</div>
                                            <div v-for="item in order.items" :key="item.id" class="order-item"><span class="order-item-name">{{ item.name }}</span><span class="order-item-qty">√ó{{ item.qty }}</span></div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                                                <span class="order-meta">{{ order.tableNumber ? t('order_table') + ': ' + order.tableNumber : t('order_pickup') }}</span>
                                                <span class="order-total">NZD ${{ (order.total || 0).toFixed(2) }}</span>
                                            </div>
                                            <div v-if="order.note" class="order-note"><strong>{{ t('order_note') }}:</strong> {{ order.note }}</div>
                                        </template>
                                        <template #footer>
                                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                                <van-button type="success" size="large" block @click="handleOrderAction(order.id, 'accepted')">{{ t('order_accept') }}</van-button>
                                                <van-button type="default" size="large" block @click="confirmReject(order)">{{ t('order_reject') }}</van-button>
                                            </div>
                                        </template>
                                    </van-card>
                                </template>
                                <van-empty v-else :description="t('no_orders')" />
                            </div>
                        </van-pull-refresh>
                    </van-tab>
                    <van-tab :title="t('status_preparing') + ` (${preparingCount})`" name="preparing">
                        <van-pull-refresh v-model="refreshing" @refresh="loadOrders">
                            <div style="padding: 12px;">
                                <template v-if="filteredOrders.length">
                                    <van-card v-for="order in filteredOrders" :key="order.id">
                                        <template #title><div class="order-header"><span class="order-id">#{{ order.id.slice(-6).toUpperCase() }}</span><van-tag type="primary">{{ t('status_' + order.status) }}</van-tag></div></template>
                                        <template #desc>
                                            <div style="font-size: 12px; color: var(--text-3); margin-bottom: 8px;">{{ formatTime(order.createdAt) }}</div>
                                            <div v-for="item in order.items" :key="item.id" class="order-item"><span class="order-item-name">{{ item.name }}</span><span class="order-item-qty">√ó{{ item.qty }}</span></div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                                                <span class="order-meta">{{ order.tableNumber ? t('order_table') + ': ' + order.tableNumber : t('order_pickup') }}</span>
                                                <span class="order-total">NZD ${{ (order.total || 0).toFixed(2) }}</span>
                                            </div>
                                        </template>
                                        <template #footer>
                                            <van-button v-if="order.status === 'accepted'" type="primary" size="large" block @click="handleOrderAction(order.id, 'preparing')">{{ t('order_prepare') }}</van-button>
                                            <van-button v-else type="warning" size="large" block @click="handleOrderAction(order.id, 'ready')">{{ t('order_complete') }}</van-button>
                                        </template>
                                    </van-card>
                                </template>
                                <van-empty v-else :description="t('no_orders')" />
                            </div>
                        </van-pull-refresh>
                    </van-tab>
                    <van-tab :title="t('status_ready') + ` (${readyCount})`" name="ready">
                        <van-pull-refresh v-model="refreshing" @refresh="loadOrders">
                            <div style="padding: 12px;">
                                <template v-if="filteredOrders.length">
                                    <van-card v-for="order in filteredOrders" :key="order.id">
                                        <template #title><div class="order-header"><span class="order-id">#{{ order.id.slice(-6).toUpperCase() }}</span><van-tag type="success">{{ t('status_' + order.status) }}</van-tag></div></template>
                                        <template #desc>
                                            <div style="font-size: 12px; color: var(--text-3); margin-bottom: 8px;">{{ formatTime(order.createdAt) }}</div>
                                            <div v-for="item in order.items" :key="item.id" class="order-item"><span class="order-item-name">{{ item.name }}</span><span class="order-item-qty">√ó{{ item.qty }}</span></div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                                                <span class="order-meta">{{ order.tableNumber ? t('order_table') + ': ' + order.tableNumber : t('order_pickup') }}</span>
                                                <span class="order-total">NZD ${{ (order.total || 0).toFixed(2) }}</span>
                                            </div>
                                        </template>
                                    </van-card>
                                </template>
                                <van-empty v-else :description="t('no_orders')" />
                            </div>
                        </van-pull-refresh>
                    </van-tab>
                </van-tabs>
            </div>

            <!-- Menu Page -->
            <div v-show="activeTab === 'menu'" style="padding-top: 46px; padding-bottom: 70px;">
                <div style="padding: 16px;">
                    <van-button type="primary" size="large" block @click="showAddMenuModal">{{ t('add_item') }} +</van-button>
                </div>
                <van-cell-group inset>
                    <template v-if="menuItems.length">
                        <van-collapse v-model="activeCategories">
                            <van-collapse-item v-for="(items, category) in groupedMenuItems" :key="category" :title="category">
                                <van-cell v-for="item in items" :key="item.id">
                                    <template #title>
                                        <div>
                                            <div style="font-weight: 600;">{{ item.name }}</div>
                                            <div style="font-size: 12px; color: var(--primary); font-weight: 700;">NZD ${{ item.price.toFixed(2) }}</div>
                                            <div v-if="item.description" style="font-size: 12px; color: var(--text-2); margin-top: 4px;">{{ item.description }}</div>
                                        </div>
                                    </template>
                                    <template #label>
                                        <van-switch v-model="item.available" size="20px" @change="toggleItemAvailability(item.id)" />
                                    </template>
                                </van-cell>
                            </van-collapse-item>
                        </van-collapse>
                    </template>
                    <van-empty v-else :description="t('no_menu')" />
                </van-cell-group>
            </div>

            <!-- Store Page -->
            <div v-show="activeTab === 'store'" style="padding-top: 46px; padding-bottom: 70px;">
                <div style="padding: 16px;" v-if="merchant">
                    <van-card>
                        <template #title>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 32px;">{{ merchant.online ? 'üü¢' : 'üî¥' }}</span>
                                <div>
                                    <div style="font-size: 18px; font-weight: 700;">{{ merchant.name }}</div>
                                    <div style="font-size: 14px; color: var(--text-2);">{{ t('type_' + merchant.type) }}</div>
                                </div>
                            </div>
                        </template>
                        <template #desc>
                            <van-cell-group inset>
                                <van-cell title="üìç" :value="merchant.address || '-'" />
                                <van-cell title="üìû" :value="merchant.phone || '-'" />
                                <van-cell title="üìù" :value="merchant.description || '-'" />
                            </van-cell-group>
                            <div class="store-status-card" :class="merchant.online ? 'online' : 'offline'">
                                <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;" :style="{ color: merchant.online ? 'var(--green)' : 'var(--red)' }">
                                    {{ merchant.online ? t('store_online') : t('store_offline') }}
                                </div>
                                <van-button :type="merchant.online ? 'default' : 'primary'" size="large" @click="toggleStoreStatus">
                                    {{ merchant.online ? t('store_status_online') : t('store_status_offline') }}
                                </van-button>
                            </div>
                        </template>
                    </van-card>
                </div>
            </div>

            <!-- Settings Page -->
            <div v-show="activeTab === 'settings'" style="padding-top: 46px; padding-bottom: 70px;">
                <div style="padding: 16px;">
                    <div style="background: white; border-radius: var(--radius); padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 20px;">üîî</span>
                            <div>
                                <div style="font-size: 15px; font-weight: 500;">{{ t('custom_sound') }}</div>
                                <div style="font-size: 12px; color: var(--text-3);">{{ customSoundStatus }}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <van-button size="small" type="primary" @click="previewSound">‚ñ∂ {{ t('sound_preview') }}</van-button>
                            <van-button size="small" @click="triggerSoundUpload">üìÅ {{ t('sound_upload') }}</van-button>
                            <van-button size="small" @click="toggleRecord" :type="isRecording ? 'danger' : 'default'">üéô {{ t('sound_record') }}</van-button>
                            <van-button v-if="customSoundData" size="small" type="warning" @click="resetSound">‚Ü© {{ t('sound_reset') }}</van-button>
                        </div>
                        <div v-if="isRecording" class="recording-indicator">‚óè {{ t('sound_recording') }}</div>
                        <input type="file" ref="soundFileInput" accept="audio/*" @change="uploadSound" style="display: none;">
                    </div>
                    <div style="background: white; border-radius: var(--radius); padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 20px;">üîí</span>
                            <div>
                                <div style="font-size: 15px; font-weight: 500;">{{ t('confirm_mode') }}</div>
                                <div style="font-size: 12px; color: var(--text-3);">{{ t('confirm_' + confirmMode + '_desc') }}</div>
                            </div>
                        </div>
                        <div class="confirm-mode-options">
                            <div class="confirm-mode-btn" :class="{ active: confirmMode === 'quicktap' }" @click="setConfirmMode('quicktap')"><div class="mode-icon">‚úÖ</div><div class="mode-name">{{ t('confirm_quicktap') }}</div><div class="mode-desc">{{ t('confirm_quicktap_desc') }}</div></div>
                            <div class="confirm-mode-btn" :class="{ active: confirmMode === 'longpress' }" @click="setConfirmMode('longpress')"><div class="mode-icon">üëÜ</div><div class="mode-name">{{ t('confirm_longpress') }}</div><div class="mode-desc">{{ t('confirm_longpress_desc') }}</div></div>
                            <div class="confirm-mode-btn" :class="{ active: confirmMode === 'swipe' }" @click="setConfirmMode('swipe')"><div class="mode-icon">üëâ</div><div class="mode-name">{{ t('confirm_swipe') }}</div><div class="mode-desc">{{ t('confirm_swipe_desc') }}</div></div>
                            <div class="confirm-mode-btn" :class="{ active: confirmMode === 'doubleclick' }" @click="setConfirmMode('doubleclick')"><div class="mode-icon">üëÜüëÜ</div><div class="mode-name">{{ t('confirm_doubleclick') }}</div><div class="mode-desc">{{ t('confirm_doubleclick_desc') }}</div></div>
                        </div>
                        <div v-if="confirmMode === 'longpress'" class="duration-options">
                            <div class="duration-btn" :class="{ active: longpressDuration === 500 }" @click="setLongpressDuration(500)">0.5s</div>
                            <div class="duration-btn" :class="{ active: longpressDuration === 1000 }" @click="setLongpressDuration(1000)">1s</div>
                            <div class="duration-btn" :class="{ active: longpressDuration === 1500 }" @click="setLongpressDuration(1500)">1.5s</div>
                            <div class="duration-btn" :class="{ active: longpressDuration === 2000 }" @click="setLongpressDuration(2000)">2s</div>
                        </div>
                    </div>
                    <van-cell-group inset>
                        <van-cell title="üì∫" :label="t('kitchen_mode_desc')" is-link @click="switchToKitchen"><template #title><span>{{ t('kitchen_mode') }}</span></template></van-cell>
                        <van-cell title="üö™" is-link @click="logout"><template #title><span style="color: var(--red);">{{ t('logout') }}</span></template></van-cell>
                    </van-cell-group>
                </div>
            </div>
        </van-config-provider>

        <!-- Menu Modal -->
        <van-popup v-model:show="showMenuModal" position="bottom" round>
            <van-cell-group inset>
                <van-field v-model="menuForm.name" :label="t('item_name')" :placeholder="t('item_name')" />
                <van-field v-model="menuForm.price" :label="t('item_price')" type="number" placeholder="0.00" />
                <van-field v-model="menuForm.category" :label="t('item_category')" :placeholder="t('item_category')" />
                <van-field v-model="menuForm.description" :label="t('item_desc')" type="textarea" rows="2" :placeholder="t('item_desc')" />
            </van-cell-group>
            <div style="padding: 16px; display: flex; gap: 12px;">
                <van-button size="large" @click="showMenuModal = false">{{ t('cancel') }}</van-button>
                <van-button size="large" type="primary" @click="saveMenuItem">{{ t('save') }}</van-button>
            </div>
        </van-popup>

        <van-overlay :show="loading">
            <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                <van-loading size="48px" vertical>{{ loadingText }}</van-loading>
            </div>
        </van-overlay>
    </div>

    <script src="https://fastly.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
    <script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    const app = createApp({
        setup() {
            const LANG = {
                zh: {
                    merchant_portal: 'ÂïÜÂÆ∂ÁÆ°ÁêÜÂêéÂè∞', phone: 'ÊâãÊú∫Âè∑', password: 'ÂØÜÁ†Å', phone_placeholder: '+64 ...', password_placeholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                    login_btn: 'ÁôªÂΩï', login_success: 'ÁôªÂΩïÊàêÂäü', login_failed: 'ÁôªÂΩïÂ§±Ë¥•', create_store: 'ÂàõÂª∫ÊÇ®ÁöÑÂ∫óÈì∫', store_name: 'Â∫óÈì∫ÂêçÁß∞',
                    store_name_placeholder: 'ÊàëÁöÑÁæéÈ£üÂ∫ó', store_type: 'Â∫óÈì∫Á±ªÂûã', store_phone: 'ËÅîÁ≥ªÁîµËØù', store_address: 'Â∫óÈì∫Âú∞ÂùÄ', store_address_placeholder: 'Ë°óÈÅìÂú∞ÂùÄ', store_desc: 'Â∫óÈì∫ÁÆÄ‰ªã', store_desc_placeholder: 'ÁÆÄÂçï‰ªãÁªç‰∏Ä‰∏ã...', create_store_btn: 'ÂàõÂª∫Â∫óÈì∫',
                    store_created: 'Â∫óÈì∫ÂàõÂª∫ÊàêÂäü', store_create_failed: 'ÂàõÂª∫Â∫óÈì∫Â§±Ë¥•', status_pending: 'ÂæÖÊé•Âçï', status_accepted: 'Â∑≤Êé•Âçï',
                    status_preparing: 'Âà∂‰Ωú‰∏≠', status_ready: 'Â∑≤ÂÆåÊàê', status_picked_up: 'Â∑≤ÂèñÈ§ê', status_rejected: 'Â∑≤ÊãíÁªù', tab_orders: 'ËÆ¢Âçï',
                    tab_menu: 'ËèúÂçï', tab_store: 'Â∫óÈì∫', tab_settings: 'ËÆæÁΩÆ', menu_management: 'ËèúÂçïÁÆ°ÁêÜ', add_item: 'Ê∑ªÂä†ËèúÂìÅ',
                    item_name: 'ËèúÂìÅÂêçÁß∞', item_price: '‰ª∑Ê†º (NZD)', item_category: 'ÂàÜÁ±ª', item_desc: 'ÊèèËø∞', cancel: 'ÂèñÊ∂à', save: '‰øùÂ≠ò',
                    item_saved: 'ËèúÂìÅÂ∑≤‰øùÂ≠ò', item_deleted: 'ËèúÂìÅÂ∑≤Âà†Èô§', order_accept: 'Êé•Âçï', order_prepare: 'ÂºÄÂßãÂà∂‰Ωú',
                    order_complete: 'ÂÆåÊàê', order_reject: 'ÊãíÁªù', order_total: 'ÂêàËÆ°', order_note: 'Â§áÊ≥®', order_table: 'Ê°åÂè∑', order_pickup: 'Ëá™Âèñ',
                    order_new: 'Êñ∞ËÆ¢ÂçïÔºÅ', store_online: 'Ëê•‰∏ö‰∏≠', store_offline: 'Â∑≤ÊâìÁÉä', store_status_online: 'ÁÇπÂáªÊâìÁÉä', store_status_offline: 'ÁÇπÂáªËê•‰∏ö',
                    kitchen_mode: 'Âé®ÊàøÊåÇÂ±èÊ®°Âºè', kitchen_mode_desc: 'ÈÄÇÂêàÂé®ÊàøÂ§ßÂ±èÊòæÁ§∫', logout: 'ÈÄÄÂá∫ÁôªÂΩï', logout_success: 'Â∑≤ÈÄÄÂá∫ÁôªÂΩï',
                    no_orders: 'ÊöÇÊó†ËÆ¢Âçï', no_menu: 'ÊöÇÊó†ËèúÂçïÔºåÁÇπÂáªÊ∑ªÂä†ËèúÂìÅ', type_food_truck: 'È§êËΩ¶', type_cafe: 'ÂíñÂï°Â∫ó', type_bakery: 'ÁÉòÁÑôÂ∫ó',
                    type_restaurant: 'È§êÂéÖ', network_error: 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï', session_expired: 'ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', sse_connected: 'ÂÆûÊó∂ËøûÊé•Â∑≤Âª∫Á´ã',
                    sse_disconnected: 'ËøûÊé•Êñ≠ÂºÄÔºåÊ≠£Âú®ÈáçËøû...', confirm_action: 'Á°ÆËÆ§Êìç‰Ωú', custom_sound: 'ËÆ¢ÂçïÊèêÁ§∫Èü≥', sound_default: '‰ΩøÁî®ÈªòËÆ§ÊèêÁ§∫Èü≥',
                    sound_custom: '‰ΩøÁî®Ëá™ÂÆö‰πâÊèêÁ§∫Èü≥', sound_preview: 'ËØïÂê¨', sound_upload: '‰∏ä‰º†Èü≥È¢ë', sound_record: 'ÂΩïÈü≥', sound_reset: 'ÊÅ¢Â§çÈªòËÆ§',
                    sound_recording: 'ÂΩïÈü≥‰∏≠...ÁÇπÂáªÂÅúÊ≠¢', sound_uploaded: 'ÊèêÁ§∫Èü≥Â∑≤Êõ¥Êñ∞ÔºÅ', sound_recorded: 'ÂΩïÈü≥Â∑≤‰øùÂ≠ò‰∏∫ÊèêÁ§∫Èü≥ÔºÅ',
                    sound_restored: 'Â∑≤ÊÅ¢Â§çÈªòËÆ§ÊèêÁ§∫Èü≥', sound_too_large: 'Êñá‰ª∂Â§™Â§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é1MBÁöÑÈü≥È¢ë', sound_mic_error: 'Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é',
                    confirm_mode: 'Êìç‰ΩúÁ°ÆËÆ§ÊñπÂºè', confirm_longpress: 'ÈïøÊåâÁ°ÆËÆ§', confirm_swipe: 'ÊªëÂä®Á°ÆËÆ§', confirm_doubleclick: '‰∫åÊ¨°ÁÇπÂáª',
                    confirm_longpress_desc: 'Êåâ‰Ωè1.5ÁßíÁ°ÆËÆ§', confirm_swipe_desc: 'ÊªëÂä®Âà∞Â∫ïÁ°ÆËÆ§', confirm_doubleclick_desc: 'ÁÇπ‰∏§Ê¨°Á°ÆËÆ§',
                    confirm_quicktap: '‰∏ÄÈîÆÈÄöËøá', confirm_quicktap_desc: 'ÁÇπÂáªÁ°ÆËÆ§ÔºåÈïøÊåâÂõûÈÄÄ', longpress_duration: 'ÈïøÊåâÊó∂Èïø', undo_action: 'ÂõûÈÄÄ', undoing: 'ÂõûÈÄÄ‰∏≠...'
                },
                en: {
                    merchant_portal: 'Merchant Portal', phone: 'Phone', password: 'Password', phone_placeholder: '+64 ...', password_placeholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                    login_btn: 'Login', login_success: 'Login successful', login_failed: 'Login failed', create_store: 'Create Your Store', store_name: 'Store Name',
                    store_name_placeholder: 'My Food Store', store_type: 'Store Type', store_phone: 'Contact Phone', store_address: 'Store Address', store_address_placeholder: 'Street address', store_desc: 'Store Description', store_desc_placeholder: 'Brief description...', create_store_btn: 'Create Store',
                    store_created: 'Store created successfully', store_create_failed: 'Failed to create store', status_pending: 'Pending', status_accepted: 'Accepted',
                    status_preparing: 'Preparing', status_ready: 'Ready', status_picked_up: 'Picked Up', status_rejected: 'Rejected', tab_orders: 'Orders',
                    tab_menu: 'Menu', tab_store: 'Store', tab_settings: 'Settings', menu_management: 'Menu Management', add_item: 'Add Item',
                    item_name: 'Item Name', item_price: 'Price (NZD)', item_category: 'Category', item_desc: 'Description', cancel: 'Cancel', save: 'Save',
                    item_saved: 'Item saved', item_deleted: 'Item deleted', order_accept: 'Accept', order_prepare: 'Prepare',
                    order_complete: 'Complete', order_reject: 'Reject', order_total: 'Total', order_note: 'Note', order_table: 'Table', order_pickup: 'Pickup',
                    order_new: 'New Order!', store_online: 'Online', store_offline: 'Offline', store_status_online: 'Tap to close', store_status_offline: 'Tap to open',
                    kitchen_mode: 'Kitchen Display Mode', kitchen_mode_desc: 'For kitchen screen display', logout: 'Logout', logout_success: 'Logged out',
                    no_orders: 'No orders', no_menu: 'No menu items, tap to add', type_food_truck: 'Food Truck', type_cafe: 'Cafe', type_bakery: 'Bakery',
                    type_restaurant: 'Restaurant', network_error: 'Network error, please retry', session_expired: 'Session expired, please login again',
                    sse_connected: 'Real-time connected', sse_disconnected: 'Disconnected, reconnecting...', confirm_action: 'Confirm',
                    custom_sound: 'Order Alert Sound', sound_default: 'Using default alert', sound_custom: 'Using custom alert', sound_preview: 'Preview',
                    sound_upload: 'Upload Audio', sound_record: 'Record', sound_reset: 'Reset Default', sound_recording: 'Recording...tap to stop',
                    sound_uploaded: 'Alert sound updated!', sound_recorded: 'Recording saved as alert!', sound_restored: 'Default alert restored',
                    sound_too_large: 'File too large, max 1MB', sound_mic_error: 'Cannot access microphone', confirm_mode: 'Confirm Mode',
                    confirm_longpress: 'Long Press', confirm_swipe: 'Swipe', confirm_doubleclick: 'Double Click', confirm_longpress_desc: 'Hold 1.5s to confirm',
                    confirm_swipe_desc: 'Slide to confirm', confirm_doubleclick_desc: 'Tap twice to confirm', confirm_quicktap: 'Quick Tap', confirm_quicktap_desc: 'Tap to confirm, hold to undo',
                    longpress_duration: 'Hold Duration', undo_action: 'Undo', undoing: 'Undoing...'
                }
            };

            const currentLang = ref(localStorage.getItem('lang') || 'zh');
            const t = (key) => LANG[currentLang.value]?.[key] || LANG.zh[key] || key;
            const toggleLang = () => { currentLang.value = currentLang.value === 'zh' ? 'en' : 'zh'; localStorage.setItem('lang', currentLang.value); };

            const themeVars = { primaryColor: '#ff6b35' };
            
            // State
            const token = ref(localStorage.getItem('token'));
            const user = ref(null);
            const merchant = ref(null);
            const orders = ref([]);
            const menuItems = ref([]);
            const currentFilter = ref('pending');
            const editingItem = ref(null);
            const sseConnection = ref(null);
            const audioCtx = ref(null);
            const customSoundData = ref(localStorage.getItem('customAlertSound'));
            const mediaRecorder = ref(null);
            const recordingChunks = ref([]);
            const isRecording = ref(false);

            // UI State
            const loading = ref(false);
            const loadingText = ref('');
            const showLoading = (msg) => { loading.value = true; loadingText.value = msg || ''; };
            const hideLoading = () => { loading.value = false; };
            const isLoggedIn = computed(() => !!token.value);
            const showCreateStore = ref(false);
            const showMenuModal = ref(false);
            const activeTab = ref('orders');
            const orderFilter = ref('pending');
            const refreshing = ref(false);
            const activeCategories = ref([]);
            const confirmMode = ref(localStorage.getItem('confirmMode') || 'quicktap');
            const longpressDuration = ref(parseInt(localStorage.getItem('longpressDuration')) || 1500);

            // Forms
            const loginForm = ref({ phone: '', password: '' });
            const storeForm = ref({ name: '', type: 'food_truck', phone: '', address: '', description: '' });
            const menuForm = ref({ name: '', price: '', category: '', description: '' });

            const storeTypeColumns = computed(() => [
                { text: t('type_food_truck'), value: 'food_truck' },
                { text: t('type_cafe'), value: 'cafe' },
                { text: t('type_bakery'), value: 'bakery' },
                { text: t('type_restaurant'), value: 'restaurant' }
            ]);

            // Computed
            const pendingCount = computed(() => orders.value.filter(o => o.status === 'pending').length);
            const preparingCount = computed(() => orders.value.filter(o => o.status === 'accepted' || o.status === 'preparing').length);
            const readyCount = computed(() => orders.value.filter(o => o.status === 'ready' || o.status === 'picked_up').length);
            const pendingOrdersCount = computed(() => pendingCount.value);
            const filteredOrders = computed(() => {
                if (orderFilter.value === 'pending') return orders.value.filter(o => o.status === 'pending');
                if (orderFilter.value === 'preparing') return orders.value.filter(o => o.status === 'accepted' || o.status === 'preparing');
                if (orderFilter.value === 'ready') return orders.value.filter(o => o.status === 'ready' || o.status === 'picked_up');
                return orders.value;
            });
            const groupedMenuItems = computed(() => {
                const groups = {};
                menuItems.value.forEach(item => {
                    const cat = item.category || 'ÂÖ∂‰ªñ';
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(item);
                });
                return groups;
            });
            const customSoundStatus = computed(() => customSoundData.value ? t('sound_custom') : t('sound_default'));

            // Methods
            const formatTime = (date) => new Date(date).toLocaleTimeString(currentLang.value === 'zh' ? 'zh-CN' : 'en-NZ', { hour: '2-digit', minute: '2-digit' });
            
            const showNotify = (msg, type = 'success') => { vantNotify({ message: msg, type, duration: 3000 }); };
            
            const apiCall = async (endpoint, options = {}) => {
                const headers = { 'Content-Type': 'application/json' };
                if (token.value) headers['Authorization'] = 'Bearer ' + token.value;
                try {
                    const r = await fetch('/api' + endpoint, { method: 'GET', headers, ...options });
                    if (r.status === 401) { localStorage.removeItem('token'); token.value = null; showNotify(t('session_expired'), 'danger'); return null; }
                    if (!r.ok) { let err = {}; try { err = await r.json(); } catch(e) {} throw new Error(err.error || err.message || 'Failed'); }
                    return r.json();
                } catch (e) { if (e.message.includes('fetch')) showNotify(t('network_error'), 'danger'); throw e; }
            };

            const doLogin = async () => {
                if (!loginForm.value.phone || !loginForm.value.password) { showNotify(currentLang.value === 'zh' ? 'ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑ÂíåÂØÜÁ†Å' : 'Please enter phone and password', 'danger'); return; }
                showLoading(currentLang.value === 'zh' ? 'ÁôªÂΩï‰∏≠...' : 'Logging in...');
                try {
                    const data = await apiCall('/auth/login', { method: 'POST', body: JSON.stringify({ phone: loginForm.value.phone, password: loginForm.value.password }) });
                    if (data && data.token) { token.value = data.token; user.value = data.user; localStorage.setItem('token', token.value); showNotify(t('login_success')); await initApp(); }
                } catch (e) { showNotify(e.message || t('login_failed'), 'danger'); }
                finally { hideLoading(); }
            };

            const checkAuth = async () => {
                if (!token.value) return false;
                try {
                    const data = await apiCall('/auth/me');
                    if (data && data.user) { user.value = data.user; return true; }
                } catch (e) { return false; }
                return false;
            };

            const loadMerchant = async () => {
                try {
                    const data = await apiCall('/merchants');
                    const merchants = data.merchants || data;
                    if (Array.isArray(merchants) && merchants.length > 0) {
                        merchant.value = merchants.find(m => m.ownerId === user.value?.id || m.owner === user.value?.id) || merchants[0];
                        showCreateStore.value = false;
                        return true;
                    }
                    showCreateStore.value = true;
                    return false;
                } catch (e) { showCreateStore.value = true; return false; }
            };

            const createStore = async () => {
                if (!storeForm.value.name) { showNotify(currentLang.value === 'zh' ? 'ËØ∑ËæìÂÖ•Â∫óÈì∫ÂêçÁß∞' : 'Please enter store name', 'danger'); return; }
                showLoading(currentLang.value === 'zh' ? 'ÂàõÂª∫‰∏≠...' : 'Creating...');
                try {
                    const data = await apiCall('/merchants', { method: 'POST', body: JSON.stringify({ name: storeForm.value.name, type: storeForm.value.type, phone: storeForm.value.phone, address: storeForm.value.address, description: storeForm.value.description, location: { lat: -43.532, lng: 172.636 } }) });
                    if (data && data.merchant) { merchant.value = data.merchant; showNotify(t('store_created')); showCreateStore.value = false; await initApp(); }
                } catch (e) { showNotify(e.message || t('store_create_failed'), 'danger'); }
                finally { hideLoading(); }
            };

            const toggleStoreStatus = async () => {
                if (!merchant.value) return;
                showLoading(currentLang.value === 'zh' ? 'Êõ¥Êñ∞‰∏≠...' : 'Updating...');
                try {
                    const newStatus = !merchant.value.online;
                    await apiCall('/merchants/' + merchant.value.id + '/status', { method: 'PUT', body: JSON.stringify({ online: newStatus }) });
                    merchant.value.online = newStatus;
                    showNotify(newStatus ? t('store_online') : t('store_offline'));
                } catch (e) { showNotify(e.message, 'danger'); }
                finally { hideLoading(); }
            };

            const loadOrders = async () => {
                try {
                    const data = await apiCall('/orders/merchant');
                    orders.value = data.orders || data || [];
                    refreshing.value = false;
                } catch (e) { console.error('Failed to load orders:', e); refreshing.value = false; }
            };

            const handleOrderAction = async (orderId, status) => {
                try {
                    await apiCall('/orders/' + orderId + '/status', { method: 'PATCH', body: JSON.stringify({ status }) });
                    const order = orders.value.find(o => o.id === orderId);
                    if (order) order.status = status;
                    showNotify(t('confirm_action'));
                } catch (e) { showNotify(e.message, 'danger'); }
            };

            const confirmReject = (order) => {
                vantDialog.confirm({ title: t('confirm_action'), message: t('confirm_delete'), confirmButtonText: t('order_reject'), cancelButtonText: t('cancel') }).then(() => handleOrderAction(order.id, 'rejected')).catch(() => {});
            };

            const loadMenu = async () => {
                if (!merchant.value || !merchant.value.menu) return;
                menuItems.value = merchant.value.menu || [];
            };

            const showAddMenuModal = () => { editingItem.value = null; menuForm.value = { name: '', price: '', category: '', description: '' }; showMenuModal.value = true; };
            
            const saveMenuItem = async () => {
                if (!menuForm.value.name) { showNotify(currentLang.value === 'zh' ? 'ËØ∑ËæìÂÖ•ËèúÂìÅÂêçÁß∞' : 'Please enter item name', 'danger'); return; }
                if (editingItem.value) { Object.assign(editingItem.value, { name: menuForm.value.name, price: parseFloat(menuForm.value.price) || 0, category: menuForm.value.category, description: menuForm.value.description }); }
                else { menuItems.value.push({ id: 'item_' + Date.now(), name: menuForm.value.name, price: parseFloat(menuForm.value.price) || 0, category: menuForm.value.category, description: menuForm.value.description, available: true }); }
                await saveMenu();
                showMenuModal.value = false;
                showNotify(t('item_saved'));
            };

            const toggleItemAvailability = async (itemId) => { await saveMenu(); };
            const deleteMenuItem = (itemId) => { menuItems.value = menuItems.value.filter(i => i.id !== itemId); saveMenu(); showNotify(t('item_deleted')); };

            const saveMenu = async () => {
                if (!merchant.value) return;
                try { await apiCall('/merchants/' + merchant.value.id + '/menu', { method: 'PUT', body: JSON.stringify({ menuItems: menuItems.value }) }); merchant.value.menu = menuItems.value; }
                catch (e) { showNotify(e.message, 'danger'); }
            };

            // Sound
            const playDefaultBeep = () => {
                if (!audioCtx.value) audioCtx.value = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.value.createOscillator();
                const gain = audioCtx.value.createGain();
                osc.connect(gain); gain.connect(audioCtx.value.destination);
                osc.frequency.setValueAtTime(800, audioCtx.value.currentTime);
                osc.frequency.setValueAtTime(600, audioCtx.value.currentTime + 0.1);
                osc.frequency.setValueAtTime(800, audioCtx.value.currentTime + 0.2);
                gain.gain.setValueAtTime(0.3, audioCtx.value.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.value.currentTime + 0.4);
                osc.start(audioCtx.value.currentTime); osc.stop(audioCtx.value.currentTime + 0.4);
            };

            const playNotificationSound = () => {
                try { if (customSoundData.value) { const audio = new Audio(customSoundData.value); audio.volume = 0.7; audio.play().catch(() => playDefaultBeep()); } else { playDefaultBeep(); } }
                catch (e) { console.log('Audio not supported'); }
            };

            const previewSound = () => playNotificationSound();
            
            const triggerSoundUpload = () => document.querySelector('input[type="file"]')?.click();
            
            const uploadSound = (input) => {
                const file = input.target.files[0];
                if (!file) return;
                if (file.size > 1024 * 1024) { showNotify(t('sound_too_large'), 'danger'); input.target.value = ''; return; }
                const reader = new FileReader();
                reader.onload = (e) => { customSoundData.value = e.target.result; localStorage.setItem('customAlertSound', customSoundData.value); showNotify(t('sound_uploaded')); playNotificationSound(); };
                reader.readAsDataURL(file);
                input.target.value = '';
            };

            const toggleRecord = () => {
                if (mediaRecorder.value && mediaRecorder.value.state === 'recording') { mediaRecorder.value.stop(); isRecording.value = false; return; }
                navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                    recordingChunks.value = [];
                    mediaRecorder.value = new MediaRecorder(stream);
                    mediaRecorder.value.ondataavailable = (e) => recordingChunks.value.push(e.data);
                    mediaRecorder.value.onstop = () => {
                        stream.getTracks().forEach(t => t.stop());
                        const blob = new Blob(recordingChunks.value, { type: 'audio/webm' });
                        if (blob.size > 1024 * 1024) { showNotify(t('sound_too_large'), 'danger'); return; }
                        const reader = new FileReader();
                        reader.onload = (ev) => { customSoundData.value = ev.target.result; localStorage.setItem('customAlertSound', customSoundData.value); showNotify(t('sound_recorded')); playNotificationSound(); };
                        reader.readAsDataURL(blob);
                    };
                    mediaRecorder.value.start();
                    isRecording.value = true;
                    setTimeout(() => { if (mediaRecorder.value?.state === 'recording') { mediaRecorder.value.stop(); isRecording.value = false; } }, 10000);
                }).catch(() => { showNotify(t('sound_mic_error'), 'danger'); });
            };

            const resetSound = () => { customSoundData.value = null; localStorage.removeItem('customAlertSound'); showNotify(t('sound_restored')); };

            // Confirm Mode
            const setConfirmMode = (mode) => { confirmMode.value = mode; localStorage.setItem('confirmMode', mode); };
            const setLongpressDuration = (duration) => { longpressDuration.value = duration; localStorage.setItem('longpressDuration', duration); };

            const switchToKitchen = () => { window.location.href = '/kitchen'; };
            
            const logout = () => { localStorage.removeItem('token'); token.value = null; user.value = null; merchant.value = null; if (sseConnection.value) { sseConnection.value.close(); sseConnection.value = null; } showNotify(t('logout_success')); };

            // SSE
            const connectSSE = () => {
                if (!token.value || sseConnection.value) return;
                try {
                    const eventSource = new EventSource('/api/orders/merchant/stream?token=' + encodeURIComponent(token.value));
                    eventSource.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            const existing = orders.value.find(o => o.id === data.id);
                            if (existing) { Object.assign(existing, data); }
                            else { orders.value.unshift(data); data.isNew = true; playNotificationSound(); showNotify(t('order_new')); }
                        } catch (e) { console.error('SSE parse error:', e); }
                    };
                    eventSource.onerror = () => { eventSource.close(); sseConnection.value = null; setTimeout(connectSSE, 5000); };
                    sseConnection.value = eventSource;
                } catch (e) { console.error('SSE error:', e); setTimeout(connectSSE, 5000); }
            };

            const initApp = async () => {
                showLoading(currentLang.value === 'zh' ? 'Âä†ËΩΩ‰∏≠...' : 'Loading...');
                const hasMerchant = await loadMerchant();
                if (hasMerchant) { await Promise.all([loadOrders(), loadMenu()]); connectSSE(); }
                hideLoading();
            };

            onMounted(async () => {
                const isAuth = await checkAuth();
                if (isAuth) await initApp();
            });

            return {
                t, toggleLang, themeVars, currentLang,
                loginForm, storeForm, menuForm, storeTypeColumns, onStoreTypeChange: (p) => storeForm.value.type = p.selectedOptions[0].value,
                loading, loadingText, isLoggedIn, showCreateStore, showMenuModal, activeTab, orderFilter, refreshing, activeCategories, confirmMode, longpressDuration,
                pendingCount, preparingCount, readyCount, pendingOrdersCount, filteredOrders, groupedMenuItems, customSoundStatus,
                merchant, orders, menuItems, isRecording,
                doLogin, createStore, toggleStoreStatus, loadOrders, handleOrderAction, confirmReject, showAddMenuModal, saveMenuItem, toggleItemAvailability, deleteMenuItem,
                previewSound, triggerSoundUpload, uploadSound, toggleRecord, resetSound, setConfirmMode, setLongpressDuration, switchToKitchen, logout, formatTime
            };
        }
    });

    app.use(vant);
    app.mount('#app');
    </script>
</body>
</html>